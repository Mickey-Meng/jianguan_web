<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>字段映射分组</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<div class="layui-body commonOutCss" style="left: 0">
    <div>
        <table class="layui-hide" id="cglist" lay-filter="cglist"></table>
    </div>
</div>
<script type="text/html" id="toolbar">
    <form class="layui-form layui-col-md12">
        <button class="layui-btn" id="add" title="添加">
            添加分组
            <i class="layui-icon">&#58964;</i>
        </button>
        <button class="layui-btn" id="addName" title="添加">
            添加名称配置
            <i class="layui-icon">&#58964;</i>
        </button>
        <button class="layui-btn" id="addArray" title="添加">
            添加名称
            <i class="layui-icon">&#58964;</i>
        </button>
    </form>
</script>
<script type="text/html" id="operationTpl">
    <div>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnEdit">编辑分组</button>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnAdd">编辑表</button>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnEditField">编辑字段</button>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnBurst">爆管配置</button>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnVertical">垂直净距配置</button>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnHorizontal">水平净距配置</button>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnDepth">埋深配置</button>
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnDel">删除</button>
    </div>
</script>
<script type="text/html" id="statusTpl">
    {{#  if(d.fdef == 1){ }}
    <span class="layui-btn layui-btn-normal layui-btn-xs">是</span>
    {{#  } else if(d.fdef == 0) { }}
    <span class="layui-btn layui-btn-warm layui-btn-xs">否</span>
    {{#  } }}
</script>
<script>
    var $;
    var layer;
    var okLayer;
    var zTable;
    var okUtils;
    var constantUrl;

    var parentFlag;
    layui.use(['form', 'table', 'okUtils', "okLayer", "layer", 'constantUrl', 'zTable'],function () {
        $ = layui.jquery;
        layer = layui.layer;
        okLayer = layui.okLayer;
        okUtils = layui.okUtils;
        constantUrl = layui.constantUrl;

        var zTable = layui.zTable({
            elem: '#cglist'
            , page: true //是否显示分页
            , limit: 10 //每页默认显示的数量
            , url: constantUrl.stMap.getDataPsCg
            , parseData: function (res) { //res 即为原始返回的数据
                if(!res.data){
                    return {
                        "code": res.meow, //解析接口状态
                        "msg": "无数据", //解析提示文本
                        "count": 0, //解析数据长度
                        "data": []//解析数据列表
                    };
                }

                var result =  res.data.data;
                return {
                    "code": res.meow, //解析接口状态
                    "msg": res.data.msg, //解析提示文本
                    "count": result ? result.length : 0, //解析数据长度
                    "data": result //解析数据列表
                };
            }
            , size:'lg'
            , height: 'full-40'
            , toolbar:'#toolbar'
            , cols: [[ //标题栏
                {field: 'key', title: '主键'}
                , {field: 'fdef', title: '是否默认', templet: "#statusTpl"}//0 否,1是
                , {title: "操作", width: 600, align: "center", templet: "#operationTpl"}
            ]]
        });

        var myTable = zTable.getTable();

        zTable.getLayuiTable().on("tool(cglist)", function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case "btnAdd":
                    parentFlag = 0;
                    okLayer.open("表分组", "fieldMappingTableInfo.html?ck=" + data.key, "90%", "90%", function (layero) {
                    }, function () {
                        if (parentFlag === 1) {
                            reload()
                        }
                    });
                    break;
                case "btnEdit":
                    parentFlag = 0;
                    okLayer.open("编辑", "fieldMappingCgAdd.html?isAdd=" + false + "&gid="+data.gid , "400px", "240px", function (layero) {
                        var iframeWin = window[layero.find("iframe")[0]["name"]];
                        iframeWin.initForm(JSON.stringify(data));
                    }, function () {
                        if (parentFlag === 1) {
                            reload()
                        }
                    });
                    break;
                case "btnEditField":
                    parentFlag = 0;
                    okLayer.open("编辑字段", "fieldMappingField.html?ck=" + data.key , "90%", "90%", function (layero) {
                    }, function () {
                        if (parentFlag === 1) {
                            reload()
                        }
                    });
                    break;
                case "btnDel":
                    okLayer.confirm('确认删除(' + data.key + ')这条数据吗',function () {
                        okUtils.ajax({
                            'url':constantUrl.stMap.deleteDataPsCg,
                            'param':{'gid':data.gid}
                        }).done(function (data1) {
                            if (data1.meow === 0){
                                reload()
                            }else {
                                layer.alert('警告 删除失败');
                            }
                        })
                    });
                    break;
                case "btnBurst":
                    parentFlag = 0;
                    okLayer.open("爆管分组", "fieldMappingBurst.html?ck=" + data.key , "90%", "90%", function (layero) {
                    }, function () {
                        if (parentFlag === 1) {
                            reload()
                        }
                    });
                    break;
                case 'btnVertical':
                    parentFlag = 0;
                    okLayer.open("垂直净距", "fieldMappingSpaceDepth.html?ck=" + data.key + "&type=vertical" , "90%", "90%", function (layero) {
                    }, function () {
                        if (parentFlag === 1) {
                            reload()
                        }
                    });
                    break;
                case 'btnHorizontal':
                    parentFlag = 0;
                    okLayer.open("水平净距", "fieldMappingSpaceDepth.html?ck=" + data.key + "&type=horizontal" , "90%", "90%", function (layero) {
                    }, function () {
                        if (parentFlag === 1) {
                            reload()
                        }
                    });
                    break;
                case 'btnDepth':
                    parentFlag = 0;
                    okLayer.open("埋深", "fieldMappingSpaceDepth.html?ck=" + data.key + "&type=depth" , "90%", "90%", function (layero) {
                    }, function () {
                        if (parentFlag === 1) {
                            reload()
                        }
                    });
                    break
            }
        });

        function reload(){
            myTable.reload();
            $('#add').click();
            $('#addName').click();
            $('#addArray').click();
        }

        $('#add').click(function () {
            parentFlag = 0;
            okLayer.open("添加", "fieldMappingCgAdd.html?isAdd=" + true, "400px", "240px", function (layero) {
            }, function () {
                reload()
            });
            return false;
        });

        $('#addName').click(function () {
            okLayer.open("添加配置", "nameMapping.html", "90%", "90%", function (layero) {
            }, function () {});
            return false;
        });

        $('#addArray').click(function () {
            okLayer.open("添加名称", "nameArray.html", "90%", "90%", function (layero) {
            }, function () {});
            return false;
        });
    });
</script>
</body>
</html>
