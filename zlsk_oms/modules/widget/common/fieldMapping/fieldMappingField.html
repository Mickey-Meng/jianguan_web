<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>字段信息</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<div class="layui-body commonOutCss" style="left: 0">
    <div>
        <table class="layui-hide" id="tablelist" lay-filter="tablelist"></table>
    </div>
</div>
<script type="text/html" id="stateTpl">
    {{#  if(d.state == 0){ }}
    <span class="layui-btn layui-btn-danger layui-btn-xs">不显示</span>
    {{#  } else if(d.state == 1) { }}
    <span class="layui-btn layui-btn-warm layui-btn-xs">显示</span>
    {{#  } }}
</script>
<script type="text/html" id="statusTpl">
    {{#  if(d.ststate == -1){ }}
    <span class="layui-btn layui-btn-danger layui-btn-xs">删除</span>
    {{#  } else if(d.ststate == 0) { }}
    <span class="layui-btn layui-btn-warm layui-btn-xs">冻结</span>
    {{#  } else if(d.ststate == 1) { }}
    <span class="layui-btn layui-btn-normal layui-btn-xs">正常</span>
    {{#  } }}
</script>
<script type="text/html" id="toolbar">
    <form class="layui-form layui-col-md12">
        <button class="layui-btn" id="save" lay-filter="save" lay-submit="" title="保存">
            保存
        </button>
    </form>
</script>
<script>

    var $;
    var layer;
    var okLayer;
    var zTable;
    var xmSelect;
    var okUtils;
    var constantUrl;

    var ck;
    var fieldData;
    var tableData;
    var selectArray = [];
    var arrayData = {};
    layui.use(['form', 'table', 'okUtils', "okLayer", "layer", 'constantUrl', 'zTable' ,'xmSelect'],function () {
        $ = layui.jquery;
        form = layui.form;
        table = layui.table;
        layer = layui.layer;
        okLayer = layui.okLayer;
        xmSelect = layui.xmSelect;
        okUtils = layui.okUtils;
        constantUrl = layui.constantUrl;

        ck = okUtils.getUrlParameter('ck');


        // okUtils.ajax({
        //     url:constantUrl.stMap.selectDataPsfc,
        //     param:{ck:ck}
        // }).done(function (data2) {
        //     fieldData =  data2.data.data;
        //     if (fieldData ){
        //         fieldData.forEach(function (value,index) {
        //             value.LAY_CHECKED = value.gid;
        //             value.ck = ck;
        //         });
        //     }
        //     tableData = fieldData;
        //     table.reload('tablelist',{data:fieldData});
        // });

        okUtils.ajax({
            url:constantUrl.stMap.easySelect,
            param:{table:'zlsk_ps_fmc'}
        }).done(function (data1) {
            if (data1.meow === 0){
                fieldData = data1.data;
                let key = '';
                if (fieldData && fieldData.length > 0){
                    fieldData.forEach(function (value,index) {
                        key += value.field + '&nbsp';
                    })
                }
                okUtils.ajax({
                    url:constantUrl.stMap.selectDataPsfc,
                    param:{ck:ck}
                }).done(function (data2) {
                    var result =  data2.data.data;
                    if (result && key.length > 0){
                        result.forEach(function (value,index) {
                            value.LAY_CHECKED = value.gid;
                            value.ck = ck;
                            if (key.indexOf(value.column_name) && !value.key && !value.label){
                                let data = mappingField(value.column_name,value.type);
                                value.key = data.key;
                                value.label = data.label;
                            }
                            arrayData[value.column_name + "_" + value.type] = value.key;
                        });
                    }
                    tableData = result;
                    renderTable(result);
                });
            }else {
                renderTable([]);
                layer.alert('警告 查询失败');
            }
        });

        function renderTable(data) {
            table.render({
                elem: '#tablelist'
                , page: false //是否显示分页
                , limit: data ? data.length : 0
                , data : data
                , size:'lg'
                , height: 'full-40'
                , toolbar:'#toolbar'
                , cols: [[ //标题栏
                    {type:'checkbox'}
                    ,  {field: 'ck', title: '配置组名称'}
                    , {field: 'key', title: '标准名称',edit:'text'}
                    , {field: 'column_name', title: '真实名称'}
                    , {field: 'label', title: '显示名称',
                        templet: function (d) {
                            return "<div id=\"label_" + d.column_name + '-' + d.type +  "\"></div>";
                        }
                    }
                    , {field: 'type', title: '字段类型',align: 'center',
                        templet: function (d) {
                            return "<div id=\"type_" + d.column_name + '-' + d.type +  "\"></div>";
                        }}
                    , {field: 'ftype', title: '所属表分类',align: 'center',
                        templet: function (d) {
                            return "<div id=\"ftype_" + d.column_name + '-' + d.type +  "\"></div>";
                        }}
                    , {field: 'state', title: '是否显示',align: 'center',
                        templet: function (d) {
                            return "<div id=\"visible_" + d.column_name  + '-' + d.type +  "\"></div>";
                        }}
                ]]
                ,done: function(res, curr, count){
                    $(".laytable-cell-1-0-7").css('overflow', 'visible');
                    $(".laytable-cell-1-0-5").css('overflow', 'visible');
                    $(".laytable-cell-1-0-6").css('overflow', 'visible');
                    $(".laytable-cell-1-0-4").css('overflow', 'visible');
                    // $(".layui-table-main").css('overflow', 'hidden');
                    okUtils.ajax({
                        url:constantUrl.stMap.easySelect,
                        param:{table:'zlsk_ps_fsa'}
                    }).done(function (data1) {
                        if (data1.meow === 0){
                            let data = data1.data;
                            layui.okUtils.getDic('ps_pipe_type', function (array, map) {
                                layui.okUtils.getDic('ps_field_type', function (array1, map) {
                                    layui.okUtils.getDic('ps_visible_state', function (array2, map) {
                                        getArraySelected(array,array1,array2,data)
                                    });
                                });
                            });
                        }else {
                            layer.alert('警告 查询失败');
                        }
                    });
                }
            });
        }

        function mappingField(name,type){
            let result = {};
            let d = new RegExp( '，' , "g" );//替换中文逗号
            for (let index = 0; index < fieldData.length; index++) {
                let data = fieldData[index];
                data.field = data.field.replace(d,',');
                let array = data.field.split(',');
                if (array.indexOf(name) !== -1 && type == data.type){
                    result = data;
                    break;
                }
            }
            return result;
        }

        form.on('submit(save)',function () {
            let list = table.checkStatus('tablelist');
            if (!list.data || list.data.length === 0){
                layer.alert('未选择数据');
                return false;
            }
            for (let index = 0; index < table.cache.tablelist.length; index++) {
                let cache = table.cache.tablelist[index];
                if (cache.key  && cache.label && !cache.LAY_CHECKED){
                    okLayer.confirm('存在数据未勾选，是否继续？',function () {
                        uploadData(list.data);
                    });
                    return false;
                }
            }
            uploadData(list.data);
            return false;
        })
    });

    function uploadData(data) {
        let cacheList = [];
        for (let index = 0; index < data.length; index++) {
            let cache = $.extend({},data[index]);
            let cacheType = selectArray['type_' + cache.column_name + '-' + cache.type].getValue();
            let cacheFType = selectArray['ftype_' + cache.column_name + '-' + cache.type].getValue();
            let cacheVisible = selectArray['visible_' + cache.column_name + '-' + cache.type].getValue();
            let label = selectArray['label_' + cache.column_name + '-' + cache.type].getValue();
            if (!cacheType || cacheType.length === 0){
                layer.alert('警告 未选择字段类型');
                return false;
            }else if ( !cacheFType || cacheFType.length === 0){
                layer.alert('警告 未选择所属字段');
                return false;
            }else if ( !cacheVisible || cacheVisible.length === 0){
                layer.alert('警告 未选择是否显示');
                return false;
            }else if (!cache.key){
                layer.alert('警告 未填写标准名称');
                return false;
            }else if (!label || label.length === 0){
                layer.alert('警告 未选择显示名称');
                return false;
            }
            cache.type = cacheFType[0].name;
            cache.ftype = cacheType[0].name;
            cache.state = cacheVisible[0].value;
            cache.label = label[0].name;
            cache.sttime = new Date();
            cache.ststate = 1;
            cache.field = cache.column_name;

            delete cache.column_name;
            delete cache.data_type;
            cacheList.push(cache);
        }
        okUtils.ajax({
            'url':constantUrl.stMap.uploadDataPsfc,
            'param':{dataInfo:JSON.stringify(cacheList),ck:ck},
            'type':'post'
        }).done(function (data) {
            if (data.meow === 0){
                parent.parentFlag = 1;
                parent.layer.close(parent.layer.getFrameIndex(window.name));
            }else if (data.meow === -2){
                layer.msg('警告 存在部分数据上传失败');
                parent.parentFlag = 1;
                parent.layer.close(parent.layer.getFrameIndex(window.name));
            }else {
                layer.alert('警告 添加数据失败')
            }
        });
    }

    var getArraySelected = function (pipeType, fieldArray, visibleArray,labelArray) {
        if (table && table.cache && table.cache.tablelist){
            let data =  table.cache.tablelist ;
            $.each(data,function (index,value) {
                let typeArrayCache = [];
                let fieldArrayCache = [];
                let visibleArrayCache = [];
                let labelArrayCache = [];
                let id1 = 'type_' + value.column_name + '-' + value.type;
                let id2 = 'ftype_' + value.column_name + '-' + value.type;
                let id3 = 'visible_' + value.column_name + '-' + value.type;
                let id4 = 'label_' + value.column_name + '-' + value.type;
                if ($('#' + id1).length !== 0 && $('#' +id2).length !== 0 && $('#' +id3).length !== 0 ){
                    for (let idx = 0; idx < pipeType.length; idx++) {
                        let cache = $.extend({},pipeType[idx]);
                        if (cache.value === value.type){
                            cache.selected = true;
                        }
                        typeArrayCache.push(cache);
                    }
                    for (let idx = 0; idx < fieldArray.length; idx++) {
                        let cache = $.extend({},fieldArray[idx]);
                        if (cache.value === value.ftype){
                            cache.selected = true;
                        }
                        fieldArrayCache.push(cache);
                    }
                    for (let idx = 0; idx < visibleArray.length; idx++) {
                        let cache = $.extend({},visibleArray[idx]);
                        cache.name = cache.key;
                        if (cache.value == value.state){
                            cache.selected = true;
                        }
                        visibleArrayCache.push(cache);
                    }
                    let flag = false;
                    for (let idx = 0; idx < labelArray.length; idx++) {
                        let cache = $.extend({},labelArray[idx]);
                        if (cache.name == value.label){
                            cache.selected = true;
                            flag = true;
                        }
                        cache.flag = true;
                        labelArrayCache.push(cache);
                    }

                    if (!flag && value.label){
                        labelArrayCache.push({name:value.label,value:value.label,selected:true})
                    }
                    let select1 = generateSelect(value.column_name,value.type,id2,typeArrayCache,false);
                    let select2 = generateSelect(value.column_name,value.type,id1,fieldArrayCache,false);
                    let select3 = generateSelect(value.column_name,value.type,id3,visibleArrayCache,false,function (id,name,type,arr,change,isAdd) {
                        for (let index = 0; index < table.cache.tablelist.length; index++) {
                            let cache = table.cache.tablelist[index];
                            if (name === cache.column_name && type === cache.type ){
                                cache.state = arr[0].value;
                                break;
                            }
                        }
                    });
                    selectArray[id1] = select1;
                    selectArray[id2] = select2;
                    selectArray[id3] = select3;
                    selectArray[id4] = generateSelect(value.column_name,value.type,id4,labelArrayCache,true,function (id,name,type,arr,change,isAdd) {
                        mappingFieldName(id,name,type,arr[0]);
                    });
                }
            })
        }
    };

    function mappingFieldName(id,name,type,labelData) {
        for (let index = 0; index < table.cache.tablelist.length; index++) {
            let cache = table.cache.tablelist[index];
            if (name === cache.column_name && type === cache.type ){
                let key;
                if (labelData){
                    if (labelData.flag){
                        key = labelData.value;
                    }else {
                        key = arrayData[name + '_' + type];
                    }
                    cache.label = labelData.name;
                }
                cache.key = key;
                $.extend(table.cache['tablelist'][index],{key:key});
                $(".laytable-cell-1-0-2")[index + 1].innerText = key ? key : '';
                break;
            }
        }
    }

    var generateSelect = function (name,type,id,array,isFilter,callback) {
        return xmSelect.render({
            el: '#' + id,
            tips:'请选择',
            name: 'name',
            filterable: isFilter,
            repeat: false,
            radio: true,
            clickClose: true,
            data: array,
            theme: {
                color: '#333333',
            },
            create: function(val, arr){
                if(arr.length === 0){
                    return {
                        name:  val,
                        value: val
                    }
                }
            },
            model: {
                label: {
                    type: 'block',
                    block: {
                        showCount: 0,
                        showIcon: false,//是否显示删除图标
                    }
                }
            },
            on: function (data) {
                var arr = data.arr;
                var change = data.change;
                var isAdd = data.isAdd;
                if (callback){
                    callback(id,name,type,arr,change,isAdd);
                }
            }
        })
    }
</script>
</body>
</html>
