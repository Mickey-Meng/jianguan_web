<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>名称匹配</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<div class="layui-body commonOutCss" style="left: 0">
    <div>
        <table class="layui-hide" id="datalist" lay-filter="datalist"></table>
    </div>
</div>
<script type="text/html" id="toolbar">
    <form class="layui-form layui-col-md12">
        <button class="layui-btn" id="add" title="添加">
            添加
            <i class="layui-icon">&#58964;</i>
        </button>
    </form>
</script>
<script type="text/html" id="operationTpl">
    <div>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnEdit">编辑</button>
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnDelete">删除</button>
    </div>
</script>
<script>
    var $;
    var layer;
    var okLayer;
    var zTable;
    var okUtils;
    var constantUrl;

    var parentNFlag;
    layui.use(['form', 'table', 'okUtils', "okLayer", "layer", 'constantUrl', 'zTable'],function () {
        $ = layui.jquery;
        layer = layui.layer;
        okLayer = layui.okLayer;
        okUtils = layui.okUtils;
        constantUrl = layui.constantUrl;

        var zTable = layui.zTable({
            elem: '#datalist'
            , page: true //是否显示分页
            , limit: 10 //每页默认显示的数量
            , url: constantUrl.stMap.easySelect
            , where:{table:'zlsk_ps_fmc'}
            , parseData: function (res) { //res 即为原始返回的数据
                if(!res.data){
                    return {
                        "code": res.meow, //解析接口状态
                        "msg": "无数据", //解析提示文本
                        "count": 0, //解析数据长度
                        "data": []//解析数据列表
                    };
                }

                var result ;
                if (this.page.curr) {
                    result = res.data.slice(this.limit * (this.page.curr - 1), this.limit * this.page.curr);
                } else {
                    result = res.data.slice(0, this.limit);
                }
                return {
                    "code": res.meow, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": result ?  res.data.length : 0, //解析数据长度
                    "data": result //解析数据列表
                };
            }
            , height: 'full-40'
            , toolbar:'#toolbar'
            , cols: [[ //标题栏
                {field: 'field', title: '真实名'}
                , {field: 'key', title: '标准名称'}
                , {field: 'label', title: '显示名称'}
                , {field: 'type', title: '类型'}
                , {title: "操作", align: "center", templet: "#operationTpl"}
            ]]
        });

        var myTable = zTable.getTable();

        zTable.getLayuiTable().on("tool(datalist)", function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case "btnEdit":
                    parentNFlag = 0;
                    okLayer.open("编辑", "nameMappingAdd.html?isAdd=" + false, "480px", "340px", function (layero) {
                        var iframeWin = window[layero.find("iframe")[0]["name"]];
                        iframeWin.initForm(JSON.stringify(data));
                    }, function () {
                        if (parentNFlag === 1){
                            reload()
                        }
                    });
                    break;
                case "btnDelete":
                    okLayer.confirm('确认删除(' + data.field + ")吗",function () {
                        okUtils.ajax({
                            url:constantUrl.stMap.deleteDataFmc,
                            param:{gid:data.gid}
                        }).done(function (data1) {
                            if (data1.meow === 0){
                                reload();
                            }else {
                                layer.alert('警告 删除失败');
                            }
                        })
                    });
                    break;
            }
        });

        function reload(){
            myTable.reload();
            $('#add').click()
        }

        $('#add').click(function () {
            parentNFlag = 0;
            okLayer.open("编辑", "nameMappingAdd.html?isAdd=" + true, "480px", "340px", function (layero) {
            }, function () {
                if (parentNFlag === 1){
                    reload()
                }
            });
            return false;
        })
    })
</script>
</body>
</html>
