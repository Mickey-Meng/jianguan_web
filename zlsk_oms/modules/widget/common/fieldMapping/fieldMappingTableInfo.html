<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>表信息</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<div class="layui-body commonOutCss" style="left: 0">
    <div>
        <table class="layui-hide" id="tablelist" lay-filter="tablelist"></table>
    </div>
</div>
<script type="text/html" id="toolbar">
    <form class="layui-form layui-col-md12">
        <button class="layui-btn" id="save" title="保存">
            保存
            <i class="layui-icon">&#58964;</i>
        </button>
    </form>
</script>
<script type="text/html" id="statusTpl">
    {{#  if(d.ststate == -1){ }}
    <span class="layui-btn layui-btn-danger layui-btn-xs">删除</span>
    {{#  } else if(d.ststate == 0) { }}
    <span class="layui-btn layui-btn-warm layui-btn-xs">冻结</span>
    {{#  } else if(d.ststate == 1) { }}
    <span class="layui-btn layui-btn-normal layui-btn-xs">正常</span>
    {{#  } }}
</script>
<script>

    var $;
    var layer;
    var okLayer;
    var zTable;
    var okUtils;
    var xmSelect;
    var constantUrl;
    var parentFieldFlag;

    var tableData;
    var selectArray = [];
    var pipeTypeArray;
    layui.use(['form', 'table', 'okUtils', "okLayer", "layer", 'constantUrl', 'zTable', 'table', 'xmSelect'],function () {
        $ = layui.jquery;
        form = layui.form;
        layer = layui.layer;
        zTable = layui.table;
        okLayer = layui.okLayer;
        okUtils = layui.okUtils;
        xmSelect = layui.xmSelect;
        constantUrl = layui.constantUrl;

        var ck = okUtils.getUrlParameter('ck');
        zTable.render({
            elem: '#tablelist'
            // , page: true //是否显示分页
            // , limit: 10 //每页默认显示的数量
            , url: constantUrl.stMap.getDataAllTable
            , headers: {token: okUtils.getCookie('token')}
            , where : {ck:ck}
            , parseData: function (res) { //res 即为原始返回的数据
                if(!res.data){
                    return {
                        "code": res.meow, //解析接口状态
                        "msg": "无数据", //解析提示文本
                        "count": 0, //解析数据长度
                        "data": []//解析数据列表
                    };
                }

                var result =  res.data.data;
                if (result){
                    result.forEach(function (value,index) {
                        value.LAY_CHECKED = value.gid;
                        value.ck = ck;
                    });
                }
                tableData = result;
                return {
                    "code": res.meow, //解析接口状态
                    "msg": res.data.msg, //解析提示文本
                    "count": res.data.total, //解析数据长度
                    "data": result //解析数据列表
                };
            }
            , size:'lg'
            , height: 'full-40'
            , toolbar:'#toolbar'
            , cols: [[ //标题栏
                {type:'checkbox'}
                ,  {field: 'ck', title: '配置组名称'}
                , {field: 'tablename', title: '表名'}
                , {field: 'name', title: '名称',edit:'text'}
                , {field: 'group', title: '分组名称',edit:'text'}
                , {field: 'type', title: '管线类型',align: 'center',
                    templet: function (d) {
                        return "<div id=\"type_" + d.tablename + "\"></div>";
                    }}
                , {field: 'code', title: '管线编码(大类)' ,align: 'center',
                    templet: function (d) {
                        return "<div id=\"code_" + d.tablename + "\"></div>";
                    }}
                , {field: 'pipecode', title: '管线编码(小类)',edit:'text'}
                , {field: 'sttime', title: '添加时间'}
                , {field: 'ststate', title: '状态',templet: "#statusTpl"}
            ]]
            ,done: function(res, curr, count){
                $(".laytable-cell-1-0-5").css('overflow', 'visible');
                $(".laytable-cell-1-0-6").css('overflow', 'visible');
                // $(".layui-table-main").css('overflow', 'hidden');
                layui.okUtils.getDic('ps_pipe_type', function (array, map) {
                    layui.okUtils.getDic('ps_pipe_big_type', function (array1, map) {
                        pipeTypeArray = array1;
                        getArraySelected(array,array1)
                    })
                });
            }
        });

        zTable.on('edit(tablelist)', function(obj){
            if (obj.field === 'pipecode'){
                if (!checkNum(obj.data.pipecode)){
                    layer.alert("请输入数字!");
                }
            }
        });

        function checkNum(data){
            var reg = new RegExp("^[0-9]*$");
            return reg.test(data);
        }

        $('#save').click(function () {
            let list = zTable.checkStatus('tablelist');
            if (!list.data || list.data.length === 0){
                layer.alert('未选择数据');
                return false;
            }
            let cacheList = [];
            for (let index = 0; index < list.data.length; index++) {
                let cache = $.extend({},list.data[index]);
                cache.ck = ck;
                cache.key = cache.tablename;
                let cacheCode = selectArray['code_' + cache.tablename].getValue();
                let cacheType = selectArray['type_' + cache.tablename].getValue();
                if (!cacheCode || cacheCode.length === 0){
                    layer.alert('警告 未选择管线编码(大类)');
                    return false;
                }else if ( !cacheType || cacheType.length === 0){
                    layer.alert('警告 未选择管线类型');
                    return false;
                }else if (!cache.pipecode){
                    layer.alert('警告 未填写管线编码(小类)');
                    return false;
                }else if (!checkNum(cache.pipecode)){
                    layer.alert('警告 管线编码(小类)只能填数字');
                    return false;
                }else if (parseInt(cache.pipecode) > 1000 + parseInt(cacheCode[0].name) || parseInt(cache.pipecode) < parseInt(cacheCode[0].name)){
                    layer.alert('警告 管线编码(小类)值超出范围');
                    return false;
                }else if (!cache.group){
                    layer.alert('警告 未填写分组名称');
                    return false;
                }
                cache.code = cacheCode[0].name;
                cache.type = cacheType[0].name;
                cache.sttime = new Date();
                cache.ststate = 1;
                delete cache.tablename;
                cacheList.push(cache);
            }
            okUtils.ajax({
                'url':constantUrl.stMap.uploadDataAllTable,
                'param':{dataInfo:JSON.stringify(cacheList)},
                'type':'post'
            }).done(function (data) {
                if (data.meow === 0){
                    parent.parentFlag = 1;
                    parent.layer.close(parent.layer.getFrameIndex(window.name));
                }else if (data.meow === -2){
                    layer.msg('警告 存在部分数据上传失败');
                    parent.parentFlag = 1;
                    parent.layer.close(parent.layer.getFrameIndex(window.name));
                }else {
                    layer.alert('警告 添加数据失败')
                }
            });
            return false;
        })
    });

    var getArraySelected = function (typeArray,codeType) {
        if (tableData){
            $.each(tableData,function (index,value) {
                let typeArrayCache = [];
                let codeTypeCache = [];
                let id1 = 'type_' + value.tablename;
                let id2 = 'code_' + value.tablename;
                if ($('#' + id1).length !== 0 ){
                    for (let idx = 0; idx < typeArray.length; idx++) {
                        let cache = $.extend({},typeArray[idx]);
                        if (cache.value === value.type){
                            cache.selected = true;
                        }
                        typeArrayCache.push(cache);
                    }
                    for (let idx = 0; idx < codeType.length; idx++) {
                        let cache = $.extend({},codeType[idx]);
                        if (cache.value == value.code){
                            cache.selected = true;
                        }
                        codeTypeCache.push(cache);
                    }
                    let select1 = generateSelect(id1,typeArrayCache,value.tablename);
                    let select2 = generateSelect(id2,codeTypeCache,value.tablename);
                    selectArray[id1] = select1;
                    selectArray[id2] = select2;
                }
            })
        }
    };

    var generateSelect = function (id,array,key) {
        return xmSelect.render({
            el: '#' + id,
            tips:'请选择',
            name: 'name',
            filterable: false,
            repeat: true,
            radio: true,
            clickClose: true,
            data: array,
            theme: {
                color: '#333333',
            },
            model: {
                label: {
                    type: 'block',
                    block: {
                        showCount: 0,
                        showIcon: false,//是否显示删除图标
                    }
                }
            }
            , on:function (data) {
                var arr = data.arr;
                var change = data.change;
                var isAdd = data.isAdd;
                if (id.indexOf('code_') !== -1){
                    for (let index = 0; index < tableData.length; index++) {
                        if (tableData[index].tablename == key){
                            for (let idx = 0; idx < pipeTypeArray. length; idx++) {
                                if (arr[0].name === pipeTypeArray[idx].name){
                                    $(".laytable-cell-1-0-3")[index + 1].innerText = arr[0].key;
                                        var tableData1 = zTable.cache['tablelist'];
                                        tableData1[index]['name'] = arr[0].key;
                                }
                            }
                            break
                        }
                    }
                }
            }
        })
    }
</script>
</body>
</html>
