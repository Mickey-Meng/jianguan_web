<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>添加表单</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<div class="ok-body" style="margin-top: 10px;margin-left: 10px">
    <!--form表单-->
    <form class="layui-form layui-form-pane ok-form">
        <div class="layui-form-item">
            <label class="layui-form-label">表单名</label>
            <div class="layui-input-block">
                <input type="text" name="name" placeholder="请输入表单名" autocomplete="off" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">表单key</label>
            <div class="layui-input-block">
                <input type="text" name="key" placeholder="请输入表单key" autocomplete="off" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">表单分类</label>
            <div class="layui-input-block">
                <select  id="formType" name="formType" placeholder="请选择表单分类" autocomplete="off" class="layui-input" ></select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">表单模式</label>
            <div class="layui-input-block">
                <select id="formModel" name="formModel" lay-filter="formModel">
                    <option >业务对象</option>
                    <option >表配置</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item" style="display: none" id="modelFormName">
            <label class="layui-form-label">表名</label>
            <div class="layui-input-block" id="formName">

            </div>
        </div>
        <div class="layui-form-item" >
            <label class="layui-form-label">业务对象</label>
            <div class="layui-input-block" id="obObjectDiv">
                <input type="text" id="obObject" name="obObject" placeholder="请选择业务对象" autocomplete="off" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">表单构建模式</label>
            <div class="layui-input-block">
                <select id="formCreateModel" name="formCreateModel" lay-filter="formCreateModel">
                    <option >默认模板</option>
                    <option >表单模板</option>
                    <option >表定义模板</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="add">立即提交</button>
            </div>
        </div>
    </form>
</div>
<!--js逻辑-->
<script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
<script>
    var $;
    var selectData ;
    var formFlag = null;

    function initForm(type) {
        var typeString = JSON.stringify(type);

        layui.use(["element", "form", "okLayer", "layer", "okUtils", 'constantUrl'], function () {
            $ = layui.jquery;
            var form = layui.form;
            var layer = layui.layer;
            var okLayer = layui.okLayer;
            var okUtils = layui.okUtils;
            var constantUrl = layui.constantUrl;

            okUtils.adapterSelect("#formType", "", "id", "name", JSON.parse(typeString));

            form.on("submit(add)", function (data) {
                if (!data.field.formType || data.field.formType === null){
                    layer.alert('请选择分类');
                }else {
                    okUtils.ajax({"url": constantUrl.stForm.easySelect,'param':{ table: 'zlsk_oms_form_def'}}).done(function (data1) {
                        if (data1.data == null) {
                            layer.alert('检查出错，请重试');
                            return false;
                        } else {
                            let isDuplicate = false;
                            for (let index = 0; index < data1.data.length; index++) {
                                if (data1.data[index].key === data.field.key){
                                    isDuplicate = true;
                                    break;
                                }
                            }
                            if (isDuplicate){
                                layer.alert('key重复');
                            }else if (!formFlag || formFlag === null){
                                layer.alert('请选择业务对象');
                            } else {
                                uploadInfo(data)
                            }
                        }
                    });
                }

                return false;
            });

            function uploadInfo(data) {
                let param = {};
                param.form = JSON.stringify({'code':data.field.key,'name':data.field.name,'des':'','ststate':1,'storder':0,'gpid':data.field.formType});
                param.boRel = JSON.stringify({'boid':formFlag.gid,'bokey':formFlag.code});
                okUtils.ajax({"url": constantUrl.stForm.addForm,'param':param}).done(function (data1) {
                    if (data1.meow !== 0) {
                        layer.alert("警告 " + data1.msg)
                    } else {
                        parent.parentFlag = 1;
                        parent.layer.close(parent.layer.getFrameIndex(window.name));
                    }
                }).fail(function (error) {
                    console.log(error)
                });
            }

            $('#obObjectDiv').click(function () {
                formFlag = null;
                okLayer.open("选择业务对象", "addBoRel.html", "90%", "90%", function (layero) {
                    var iframeWin = window[layero.find("iframe")[0]["name"]];
                }, function () {
                    if (formFlag && formFlag !== null) {
                        $("#obObject").attr('value',formFlag.name);
                    }
                });
                return false;
            })
        });
    }
</script>
</body>
</html>
