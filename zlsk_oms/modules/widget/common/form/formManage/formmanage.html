<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>表单管理</title>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <script type="text/javascript" src="../formUtil.js"></script>
</head>
<body>
<style>
</style>
<div class="layui-body commonOutCss" style="left: 0">
    <div id="form">
        <table class="layui-hide" id="forms" lay-filter="forms"></table>
    </div>
</div>

<script type="text/html" id="toolbar">
    <form class="layui-form  layui-col-md12" style="margin-top: -10px;height: 40px" lay-filter="toolForm" >
        <div class="layui-input-inline ok-search">
            <input class="layui-input" placeholder="表单名称" autocomplete="off" name="formName" id="formName">
        </div>
        <div class="layui-inline layui-form-item" style="width: 200px;padding-top: 10px">
            <div id="form_type_select" ></div>
        </div>
        <button class="layui-btn" lay-submit="" lay-filter="search" id="searchForm">
            <i class="layui-icon">&#xe615;</i>
        </button>
        <button class="layui-btn" lay-submit="" lay-filter="reset" id="reset" type="reset">
            <i class="layui-icon">&#xe9aa;</i>
        </button>
        <button class="layui-btn" id="add" title="新建">
            新建
            <i class="layui-icon">&#58964;</i>
        </button>
<!--        <button class="layui-btn" id="import" title="导入">
            导入
            <i class="layui-icon">&#58964;</i>
        </button>
        <button class="layui-btn" id="export" title="导出">
            导出
            <i class="layui-icon">&#58964;</i>
        </button>-->
    </form>
</script>

<script type="text/html" id="operationTpl">
    <div>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnPreview">预览</button>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnEdit">编辑</button>
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnDel">删除</button>
<!--        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnAuth">表单权限</button>-->
    </div>
</script>

<script>
    var $;
    var parentFlag = 0;
    var formType = [];
    layui.use(['tree', 'okUtils', "okLayer", "layer", 'constantUrl', 'zTable', 'xmSelect'], function () {
        $ = layui.jquery;
        var tree = layui.tree;
        var okUtils = layui.okUtils;
        var constantUrl = layui.constantUrl;
        var okLayer = layui.okLayer;
        var layer = layui.layer;

        var zTable = layui.zTable({
            elem: '#forms'
            , page: true
            , limit: 10
            , url: constantUrl.stForm.easySelect
            , where: {'table': 'zlsk_oms_form_def'}
            , parseData: function (res) {
                var result = {};
                if (this.page.curr) {
                    result = res.data.slice(this.limit * (this.page.curr - 1), this.limit * this.page.curr);
                } else {
                    result = res.data.slice(0, this.limit);
                }
                return {
                    "code": res.meow, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data ? res.data.length : 0, //解析数据长度
                    "data": result //解析数据列表
                };
            }
            , toolbar: '#toolbar'
            , cols: [[ //标题栏
                {field: 'name', title: '名称'}
                , {field: 'des', title: '描述'}
                , {field: 'sttime', title: '建立时间'}
                , {title: "操作", width: 300, align: "center", templet: "#operationTpl"}
            ]]
        });

        var myTable = zTable.getTable();

        layui.okUtils.getDic('form_type', function (array, map) {
            formType = array;
            formUtil.renderEasySelect($, {
                el: '#form_type_select',
                tips: '请选表单分类',
                name: 'gid',
                data: array
            });
        });

        zTable.getLayuiTable().on("tool(forms)", function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case "btnPreview":
                    okLayer.open("表单预览", "formPreview.html?fmId=" + data.gid + "&previewType=preview", "60%", "60%",function (dom,index) {

                    },function () {

                    });
                    break;
                case "btnEdit":
                    gotoEdit(data);
                    break;
                case "btnDel":
                    layer.confirm("确定要删除吗？", function (index) {
                        btnDel(data);
                        layer.close(index);
                    });
                    break;
                case "btnAuth":
                    break;
            }
        });

        function btnDel(data) {
            okUtils.ajax({
                "url": constantUrl.stForm.deleteForm,
                'param': {formId:data.gid}
            }).done(function (data1) {
                if (data1.meow !== 0) {
                    layer.alert("警告 " + data1.msg)
                }else {
                    myTable.refresh()
                }
            })
        }

        $('#add').click(function () {
            okLayer.open("添加表单", "addForm.html", "40%", "60%", function (layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(formType);
            }, function () {
                if (parentFlag === 1) {
                    myTable.refresh()
                }
            });
            return false;
        });

        $('#searchForm').click(function () {
            let searchData = $('#formName').val();
            let type = $('#form_type_select')[0].innerText;
            let typeId = '';
            if (type){
                for (let index = 0; index < formType.length; index++) {
                    if (formType[index].name === type){
                        typeId = formType[index].id;
                        break;
                    }
                }
            }
            myTable.refresh({
                where: {
                    'table': 'zlsk_oms_form_def',
                    'mapStr':JSON.stringify({'name':searchData,'gpid':typeId})
                },
                curr: 1
            });
            return false;
        });
        $('#reset').click(function () {
            myTable.refresh({
                where: {
                    'table': 'zlsk_oms_form_def'
                },
                curr: 1});
            return false;
        });

        function gotoEdit(data) {
            parentFlag = 0;
            okLayer.open("编辑表单", "formedit.html", "100%", "100%", function (layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(data);
            }, function () {
                if (parentFlag === 1) {
                    myTable.refresh();
                }
            });
        }
    });
</script>
</body>
</html>
