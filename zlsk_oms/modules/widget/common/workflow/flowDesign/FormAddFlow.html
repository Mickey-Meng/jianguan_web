<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>添加</title>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <script type="text/javascript" src="../../form/formUtil.js"></script>
</head>
<body>
<div class="ok-body">
    <!--form表单-->
    <form class="layui-form ok-form" lay-filter="form" style="margin: 10px">
        <div class="layui-form-item">
            <label class="layui-form-label">流程key</label>
            <div class="layui-input-block">
                <input type="text" name="key" placeholder="流程key" autocomplete="off" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">流程名</label>
            <div class="layui-input-block">
                <input type="text" name="name" placeholder="流程名" autocomplete="off" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">流程描述</label>
            <div class="layui-input-block">
                <input type="text" name="des" placeholder="流程描述" autocomplete="off" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">流程编号前缀</label>
            <div class="layui-input-block">
                <input type="text" name="nopre" placeholder="流程编号前缀" autocomplete="off" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">流程编号格式</label>
            <div class="layui-input-block">
                <div id="fmtSelect"></div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">流程类型</label>
            <div class="layui-input-block">
                <select name="ftype">
                    <option value="1">主流程</option>
                    <option value="2">子流程</option>
                    <option value="3">子流程或主流程</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="submit">立即提交</button>
            </div>
        </div>
    </form>
</div>
<script>
    var $;
    var form;
    var layer;
    var okUtils;
    var constantUrl;

    var fid;
    var fmtType;
    var workFlow;
    var selectObj;
    function initForm(data) {
        fid = data;
    }
    layui.use(['form','okUtils','constantUrl','layer','xmSelect'],function () {
        $ = layui.jquery;
        form = layui.form;
        layer = layui.layer;
        okUtils = layui.okUtils;
        constantUrl = layui.constantUrl;

        layui.okUtils.getDic('flow_fmt', function (array, map) {
            fmtType = array;
            if (fid){
                okUtils.ajax({
                    'url':constantUrl.stFlow2.getWorkFlowDetail,
                    'param':{'fid':fid}
                }).done(function (data1) {
                    if (data1.meow === 0 && data1.data){
                        workFlow = data1.data;
                        let info = workFlow.info;
                        form.val('form',info);

                        let selectData = info.nofmt;
                        $.each(fmtType,function (index,value) {
                            if (selectData.indexOf(value.key) !== -1){
                                value.selected = true;
                            }
                        });
                        selectObj = formUtil.renderEasySelect($, {
                            el: '#fmtSelect',
                            tips: '请选择',
                            name: 'fmtSelect',
                            data: fmtType,
                            repeat:false,
                            clickClose:false,
                            radio:false
                        });
                    }else {}
                })
            }else {
                selectObj = formUtil.renderEasySelect($, {
                    el: '#fmtSelect',
                    tips: '请选择',
                    name: 'fmtSelect',
                    data: fmtType,
                    repeat:false,
                    clickClose:false,
                    radio:false
                });
            }
        });


        form.on("submit(submit)", function (data) {
            let cache = data.field;
            cache.ftype = parseInt(cache.ftype);
            cache.nofmt = getFmt(selectObj.getValue());
            for (let key in cache){
                if (!cache[key] || cache[key] == null || cache[key] == ''){
                    delete cache[key];
                }
            }
            if (fid){
                $.extend(workFlow.info,cache);
                okUtils.ajax({'url':constantUrl.stFlow2.updateWorkFlow,
                    'param':{'workflow':JSON.stringify(workFlow)}}).done(function (data1) {
                    if (data1.meow === 0) {
                        parent.layer.close(parent.layer.getFrameIndex(window.name));
                    }else {
                        layer.alert('警告 更新失败');
                    }
                })
            }else {
                cache.cno = 0;
                //检查flow key
                okUtils.ajax({'url':constantUrl.stFlow2.existWorkFlow,'param':{'key':cache.key}}).done(function (data1) {
                    if (data1.meow === 0){
                        if ( data1.data){
                            layer.alert('警告 key重复');
                        }else {
                            parent.parentFlowData = JSON.stringify(cache);
                            parent.layer.close(parent.layer.getFrameIndex(window.name));
                        }
                    }else {
                        layer.alert('警告 检查key失败');
                    }
                });
            }
            return false;
        });

        function getFmt(selects) {
            let cache = '';
            if (selects){
                for (let index = 0; index < selects.length; index++) {
                    cache += selects[index].key
                }
            }
            return cache;
        }
    })
</script>
</body>
</html>
