<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>步骤</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <style>
        .borderStyle{
            border: 10px black;
            max-width: 60%;
        }
       .info1{
           line-height: 30px;
           height: 30px;
           text-align: center;
       }
        .item{
            text-align: left;
        }
        .timeStyle{
            margin-left: 10px;
            background: chocolate;
            color: white;
        }
        .manStyle{
            margin-left: 10px;
            background: darkseagreen;
            color: white;
        }
    </style>
</head>
<body>
<div id="stepItem" style="margin: 10px;overflow: auto;padding: 10px">
    <div class="borderStyle layui-bg-gray">
        <ul class="layui-timeline"></ul>
    </div>
</div>
<script>
    var $;
    var layer;
    var okLayer;
    var okUtils;
    var constantUrl;

    var nodesData;
    var cno;
    var flowId;
    layui.use(['layer','okLayer','okUtils','constantUrl'],function () {
        $ = layui.jquery;
        layer = layui.layer;
        okLayer = layui.okLayer;
        okUtils = layui.okUtils;
        constantUrl = layui.constantUrl;

        cno = okUtils.getUrlParameter('cno');
        flowId = okUtils.getUrlParameter('flowId');
        if (cno && flowId){
            okUtils.ajax({
                'url':constantUrl.stForm.getFlowNodeFormInfo,
                'param':{'flowId':flowId}
            }).done(function (data) {
                if (data.meow === 0){
                    nodesData = data.data;
                    okUtils.ajax({
                        'url':constantUrl.stForm.getStepHistory,
                        'param':{'cno':cno}
                    }).done(function (data) {
                        if (data.meow === 0 && data.data){
                            for (let index = 0; index < data.data.length; index++) {
                                addStep(data.data[index]);
                            }
                        }
                    });
                }else {
                    layer.alert('警告 查询流程信息失败，请刷新后重试')
                }
            })
        }else {
            layer.alert('警告 未获取到参数，请刷新后重试')
        }
    });

    function addStep(data) {
        if (data){
            let state = 'none';
            let fromData;
            if (nodesData){
                for (let index = 0; index < nodesData.length; index++) {
                    if (nodesData[index].gid == data.nid && nodesData[index].forms){
                        state = 'inline';
                        fromData = nodesData[index].forms[0];// TODO 默认一个节点仅一个表单
                    }
                }
            }
            $('.layui-timeline').append(
                "<li class=\"layui-timeline-item\">\n" +
                "                <i class=\"layui-icon layui-timeline-axis\">&#xe63f;</i>\n" +
                "                <div class=\"layui-timeline-content layui-text\">\n" +
                "                    <h3 class=\"layui-timeline-title\" id=\"title\">" + data.nname + "</h3>\n" +
                "                    <div>\n" +
                "                        <div class=\"info1\"><!-- 承办时间 接收时间 -->\n" +
                "                            <div class=\"item layui-col-md4\"><span>承&nbsp&nbsp&nbsp办&nbsp&nbsp&nbsp人&nbsp</span><span class=\"manStyle\" id=\"handman\">" + changeUndefineToEmpty(data.uk) + "</span></div>\n" +
                "                            <div class=\"item layui-col-md4\"><span>上级承办人</span><span class=\"manStyle\" id=\"prehandman\">" +changeUndefineToEmpty( data.preman) + "</span></div>\n" +
                "                            <div class=\"item layui-col-md4\"><span>承  办  时  间</span><span class=\"timeStyle\" id=\"tktime\">" + changeUndefineToEmpty(data.tktime) + "</span></div>\n" +
                "                        </div>\n" +
                "                        <div class=\"info1\"><!-- 办结时间 移交时间 -->\n" +
                "                            <div class=\"item layui-col-md4\"><span>移  交  时  间</span><span class=\"timeStyle\" id=\"handtime\">" + changeUndefineToEmpty(data.hotime) + "</span></div>\n" +
                "                            <div class=\"item layui-col-md4\"><span>接  收  时  间</span><span class=\"timeStyle\" id=\"acpttime\">" + changeUndefineToEmpty(data.acpttime) + "</span></div>\n" +
                "                            <div class=\"item layui-col-md4\"><span>办  结  时  间</span><span class=\"timeStyle\" id=\"fnshtime\">" + changeUndefineToEmpty(data.fnshtime) + "</span></div>\n" +
                "                        </div>\n" +
                "                    </div>\n" +
                "                    <button class=\"layui-btn layui-btn-normal layui-btn-sm\" style='display: " + state + "' onclick='showForm(" + JSON.stringify(fromData) + "," + data.gid + "," + data.nid + ")'>查看表单</button>\n" +
                "                </div>\n" +
                "            </li>"
            )
        }
    }

    function changeUndefineToEmpty(data) {
        let result = '';
        if (data){
            result = data;
        }
        return result;
    }

    function showForm(data,sid,nid) {
        okUtils.ajax({
            'url':constantUrl.stForm.easySelectWithOutLike,
            'param':{'table':'zlsk_oms_wf_form_rec','mapStr':JSON.stringify({'nid':nid,'sid':sid})}
        }).done(function (data1) {
            if (data1.meow == 0){
                if (!data1.data || data1.data.length == 0){
                    layer.alert('警告 未查询到表单信息')
                }else {
                    okLayer.open("查看表单", "../form/formManage/formPreview.html?fmId=" + data.fmid + "&templateId=" + data.templateId + "&xxId=" + data1.data[0].fmpkv + "&previewType=detail", "60%", "60%", function (layero) {
                    },function () {});
                }
            }else {
                layer.alert('警告 查询表单失败 ')
            }
        });
    }
</script>
</body>
</html>
