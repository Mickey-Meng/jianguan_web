<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>流程处理页面</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<div class="layui-body commonOutCss" style="left: 0">
    <div id="form">
        <table class="layui-hide" id="flows" lay-filter="flows"></table>
    </div>
</div>

<script type="text/html" id="toolbar">
    <form class="layui-form  layui-col-md12" style="height: 40px" lay-filter="toolForm" >
        <div class="layui-input-inline ok-search">
            <input class="layui-input" placeholder="承办人" autocomplete="off" name="uk" id="search_uk">
        </div>
        <div class="layui-input-inline ok-search">
            <input class="layui-input" placeholder="节点名" autocomplete="off" name="nname" id="search_nname">
        </div>
        <button class="layui-btn" lay-submit="" lay-filter="search" id="search">
            <i class="layui-icon">&#xe615;</i>
        </button>
        <button class="layui-btn" lay-submit="" lay-filter="refresh" id="refresh">
            <i class="layui-icon">&#xe9aa;</i>
        </button>
        <button class="layui-btn" lay-submit=""  lay-filter="add" id="add" title="添加">
            添加
            <i class="layui-icon">&#58964;</i>
        </button>
    </form>
</script>

<script>
    var $;
    var form;
    var table;
    var okUtils;
    var okLayer;
    var xmSelect;
    var layer;
    var constantUrl;

    var flowId ;
    var myTable;
    var workFlow;
    var nodesData;
    var parentFlag;
    var startNodeID;
    var finishNodeID;
    var userInfo = JSON.parse(sessionStorage.getItem('userInfo'));
    userInfo = userInfo ? userInfo : {};
    layui.use(['table','zTable','form','okUtils','okLayer','xmSelect','layer','constantUrl'],function () {
        $ = layui.jquery;
        form = layui.form;
        table = layui.table;
        zTable = layui.zTable;
        okUtils = layui.okUtils;
        okLayer = layui.okLayer;
        xmSelect = layui.xmSelect;
        layer = layui.layer;
        constantUrl = layui.constantUrl;

        flowId = okUtils.getUrlParameter('flowId');

        okUtils.ajax({
            'url':constantUrl.stForm.getFlowNodeFormInfo,
            'param':{'flowId':flowId}
        }).done(function (data1) {
            if (data1.meow === 0 && data1.data){
                workFlow = data1.data.flow[0];
                nodesData = data1.data.node;
                if (nodesData){
                    for (let index = 0; index < nodesData.length; index++) {
                        if (nodesData[index].ntype == 3){
                            finishNodeID = nodesData[index].gid;
                        }else if (nodesData[index].ntype == 1){
                            startNodeID = nodesData[index].gid;
                        }
                    }
                }
                myTable = zTable.getTable();
            }else {
                layer.alert('警告 获取流程信息失败');
            }
        });

        var zTable = layui.zTable({
            elem: '#flows'
            , page: true
            , limit: 10
            , url:constantUrl.stForm.getDoingCase
            , where :{'fid':flowId,'ukid':userInfo.ID}
            , parseData: function (res) {
                var result = {};
                if (res.data){
                    for (let index = 0; index < res.data.length; index++) {
                        if (res.data[index].ukid == userInfo.ID){
                            res.data[index].flagIsHandMan = true;
                            res.data[index].flagIsStart = startNodeID == res.data[index].nid;
                            res.data[index].flagIsFinish = finishNodeID == res.data[index].nid;
                        }
                        res.data[index].flagIsPreMan = res.data[index].premanid == userInfo.ID;
                    }
                    if (this.page.curr) {
                        result = res.data.slice(this.limit * (this.page.curr - 1), this.limit * this.page.curr);
                    } else {
                        result = res.data.slice(0, this.limit);
                    }
                }
                return {
                    "code": res.meow, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data ? res.data.length : 0, //解析数据长度
                    "data": result //解析数据列表
                };
            }
            , toolbar: '#toolbar'
            , cols: [[ //标题栏
                 {field: 'nname', title: '节点名'}
                , {field: 'preman', title: '前承办人'}
                , {field: 'uk', title: '承办人'}
                , {field: 'tktime', title: '承办时间'}
                , {field: 'acpttime', title: '接受时间'}
                , {field: 'fnshtime', title: '办结时间'}
                , {field: 'sttime', title: '建立时间'}
                , {title: "操作", width: 300, align: "center", templet: "#operationTpl"}
            ]]
        });

        form.on('submit(search)',function (data) {
            myTable.reload({
                url: constantUrl.stForm.getDoingCase,
                where: data.field,
                page: {curr: 1}
            });
            return false;
        });

        form.on('submit(refresh)',function (data) {
            myTable.reload();
        });

        form.on('submit(add)',function (data) {
            let startNode;
            for (let index = 0; index < nodesData.length; index++) {
                if (nodesData[index].ntype == 1){
                    startNode = nodesData[index];
                    break
                }
            }
            // if (startNode.forms){
            //     let formId = startNode.forms[0].fmid;
            //     let templateId = startNode.forms[0].templateId;
            //     parentFlag = null;
            //     okLayer.open("添加信息", "../form/formManage/formPreview.html?fmId=" + formId + "&templateId=" + templateId + "&previewType=add", "100%", "100%", function (layero) {},function () {
            //         uploadCaseAndForm(formId);
            //     })
            // }else {
                okUtils.ajax({
                    'url':constantUrl.stFlow2.createCase,
                    'param':{'case':JSON.stringify({'fid':parseInt(flowId),'ukid':userInfo.ID}),'returnDataAnyWay':true}
                }).done(function (data1) {
                    if (data1.meow === 0) {
                        layer.msg('流程启动成功');
                        myTable.reload()
                    }else {
                        layer.alert('警告 流程启动失败')
                    }
                });
            // }
            return false;
        });

        zTable.getLayuiTable().on("tool(flows)", function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case 'btnItemDelete':
                    layer.confirm('确认删除该案件?',function () {
                        deleteCase(data);
                    });
                    break;
                case 'btnItemInfo':
                    okLayer.open("流程步骤", "commonFlowDealStep.html?cno=" + data.cno + "&flowId=" + data.fid , "100%", "100%", function (layero) {},function () {});
                    break;
                case 'btnItemHand':
                    for (let index = 0; index < nodesData.length; index++) {
                        if (nodesData[index].gid === data.nid && nodesData[index].forms){
                            checkFinishNodeForm(data.nid,data.sid,nodesData[index].forms[0],function (data1,form) {
                                if (data1 === -1){
                                    layer.alert('警告 查询表单失败')
                                }else if (data1 && data1.length>0){
                                    gotoHanover(data);
                                }else {
                                    parentFlag = null;
                                    okLayer.open("添加信息", "../form/formManage/formPreview.html?fmId=" + form.fmid + "&templateId=" + form.templateId + "&previewType=add", "90%", "90%", function (layero) {
                                    },function () {
                                        if (parentFlag){
                                            let formCacheData = JSON.parse(parentFlag);
                                            if (formCacheData && formCacheData.gid){
                                                okUtils.ajax({
                                                    'url':constantUrl.stForm.easyInsert,
                                                    'param':{'table':'zlsk_oms_wf_form_rec','mapStr':JSON.stringify({'nid':data.nid,'sid':data.sid,'fmid':form.fmid,'fmpk':'gid','fmpkv':formCacheData.gid})}
                                                }).done(function (data3) {
                                                    if (data3.meow === 0){
                                                        layer.msg('表单上传成功');
                                                        myTable.reload()
                                                    }else {
                                                        layer.alert('警告 上传表单失败')
                                                    }
                                                })
                                            }else {
                                                layer.alert('警告 未获取到表单信息')
                                            }
                                        }
                                    })
                                }
                            });
                            return
                        }
                    }
                    gotoHanover(data);
                    break;
                case 'btnHandBack':
                    layer.confirm('确认回退该案件?',function () {
                        okUtils.ajax({
                            'url':constantUrl.stFlow2.handbackCase,
                            'param':{'userid':userInfo.ID,'sid':data.sid}
                        }).done(function (data1) {
                            if (data1.meow === 0){
                                layer.msg('回退成功 ');
                                myTable.reload();
                            }else {
                                layer.alert('警告 ' + data1.msg)
                            }
                        })
                    });
                    break;
                case 'btnWithDraw':
                    layer.confirm('确认撤回该案件?',function () {
                        okUtils.ajax({
                            'url':constantUrl.stFlow2.withdrawCase,
                            'param':{'userid':userInfo.ID,'sid':data.sid}
                        }).done(function (data1) {
                            if (data1.meow === 0){
                                layer.msg('撤回成功 ');
                                myTable.reload();
                            }else {
                                layer.alert('警告 ' + data1.msg)
                            }
                        })
                    });
                    break;
                case 'btnFinishCase':
                    layer.confirm('确认结案?',function () {
                        okUtils.ajax({
                            'url':constantUrl.stFlow2.archiveCase,
                            'param':{'sid':data.sid,'userid':userInfo.ID}
                        }).done(function (data1) {
                            if (data1.meow === 0){
                                layer.msg('结案成功 ');
                                myTable.reload();
                            }else {
                                layer.alert('警告 ' + data1.msg)
                            }
                        })
                    });
                    break
            }
        });

        var uploadCaseAndForm = function (formId) {
            if (parentFlag){
                okUtils.ajax({
                    'url':constantUrl.stFlow2.createCase,
                    'param':{'case':JSON.stringify({'fid':parseInt(flowId),'ukid':userInfo.ID}),'returnDataAnyWay':true}
                }).done(function (data1) {
                    if (data1.meow === 0){
                        let gid = data1.data;
                        let formCacheData = JSON.parse(parentFlag);
                        if (formCacheData && formCacheData.gid){
                            okUtils.ajax({
                                'url':constantUrl.stForm.getDoingCase,
                                'param':{'gid':gid}
                            }).done(function (data2) {
                                if (data2.meow === 0){
                                    let doingCase = data2.data[0];
                                    okUtils.ajax({
                                        'url':constantUrl.stForm.easyInsert,
                                        'param':{'table':'zlsk_oms_wf_form_rec','mapStr':JSON.stringify({'nid':doingCase.nid,'sid':doingCase.sid,'fmid':formId,'fmpk':'gid','fmpkv':formCacheData.gid})}
                                    }).done(function (data3) {
                                        if (data3.meow === 0){
                                            layer.msg('流程启动成功');
                                            myTable.reload()
                                        }else {
                                            layer.alert('警告 流程启动失败')
                                        }
                                    })
                                }else {
                                    layer.alert('警告 查询案卷信息失败')
                                }
                            })
                        }else {
                            layer.alert('警告 未获取到表单信息')
                        }
                    }else {
                        layer.alert('警告 创建案卷失败')
                    }
                })
            }else {
                layer.alert('警告 未获取到表单信息')
            }
        };

        var deleteCase = function (data) {
            okUtils.ajax({
                'url':constantUrl.stFlow2.deleteCase,
                'param':{'cno':data.cno}
            }).done(function (data1) {
                if (data1.meow === 0){
                    layer.msg('删除成功');
                    myTable.reload()
                }else {
                    layer.alert('警告 删除失败')
                }
            })
        };

        var checkFinishNodeForm = function (nid,sid,form,callback) {
            okUtils.ajax({
                'url':constantUrl.stForm.easySelectWithOutLike,
                'param':{'table':'zlsk_oms_wf_form_rec','mapStr':JSON.stringify({'nid':nid,'sid':sid})}
            }).done(function (data1) {
                if (data1.meow === 0){
                    callback(data1.data,form)
                }else {
                    callback(-1)
                }
            })
        };

        var gotoHanover = function (data) {
            parentFlag = 0;
            okLayer.open("流程移交", "commonFlowDealHand.html" , "60%", "60%", function (layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(JSON.stringify(data));
            },function () {
                if (parentFlag === 1){
                    myTable.reload();
                }
            });
        };
    })
</script>

<script type="text/html" id="operationTpl">

    <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnItemDelete">删除</button>
    <button class="layui-btn layui-btn-xs" lay-event="btnItemInfo">明细</button>
    {{#     if(d.flagIsHandMan){            }}

    <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnItemHand">移交</button>
    {{#         if(!d.flagIsStart){            }}
    <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnHandBack">回退</button>
    {{#         }                              }}
    {{#      }                              }}
    {{#     if(d.flagIsPreMan){             }}
    <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnWithDraw">撤回</button>
    {{#      }                              }}
    {{#     if(d.flagIsFinish){             }}
    <button class="layui-btn layui-btn-warm layui-btn-xs" lay-event="btnFinishCase">结案</button>
    {{#      }                              }}
</script>
</body>
</html>
