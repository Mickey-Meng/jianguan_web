<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>首页地图</title>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/okadmin.css">
    <link rel="stylesheet" href="../../../common/map/css/zCss.css">
    <link rel="stylesheet" href="../../../common/map/css/zInfoWindow.css">
    <script type="text/javascript" src="../../../../../lib/sfmbase/sfmUtil.js"></script>
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <script src="../../../common/map/zUtil.js"></script>
    <script src="../../../common/map/zInfoWindow.js"></script>
    <script type="text/javascript" src="../FileSaver.js"></script>
    <script type="text/javascript">
        SFM.sfmUtil.loadJquery();
        SFM.sfmUtil.loadSfmBase();
        SFM.sfmUtil.loadCesium('1.60');
        SFM.sfmUtil.load(
            '/modules/lib/drawPlot/createModel.js',
            '/modules/lib/drawPlot/createBillboard.js',
            '/modules/lib/drawPlot/createLabel.js',
            '/modules/lib/drawPlot/createPoint.js',
            '/modules/lib/drawPlot/createPolygon.js',
            '/modules/lib/drawPlot/createPolyline.js',
            '/modules/lib/drawPlot/createRectangle.js',
            '/modules/lib/drawPlot/createImgRectangle.js',
            '/modules/lib/drawPlot/createCorridor.js',
            '/modules/lib/drawPlot/createCircle.js',
            '/modules/lib/drawPlot/createCylinder.js',
            '/modules/lib/drawPlot/drawTool.js',
        );
    </script>
    <script type="text/javascript">
        SFM.CesiumEarthWidget = SFM.SfmResizableWidgetBase.extend({
            constructor: function(options) {
                var me = this;
                me.base(options);
            },
            destroy: function() {
                this.base();
            },
            render: function() {
                var me = this;
                me.base();
                return me;
            },
            getEarthContext: function() {
                return earthCtx;
            },
            __className__: 'CesiumEarthWidget'
        });
        var sfmWidget = new SFM.CesiumEarthWidget();
    </script>
    <script src="../gcoord.js"></script>
    <script src="../location.js"></script>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        #toolContainer,
        #geoStyleContainer,
        #container_geo_attributes,
        #container_layer_fields {
            position: absolute;
            width: 350px;
            z-index: 999;
            background-color: rgba(34, 34, 34, 0.6);
            color: #fff;
        }

        .container {
            position: absolute;
            width: 350px;
            z-index: 999;
            background-color: rgba(34, 34, 34, 0.6);
            color: #fff;
        }

        .disno {
            display: none
        }
    </style>
</head>

<body onload="init()">
    <!-- cesium容器 -->
    <div id="divCesiumContainer" class="layui-body-map commonOutCss">
    </div>

    <!-- 左侧图层工具 -->

    <!-- 图层列表 -->
    <div id="toolContainer" class="container" style="left: 20px;top: 20px;bottom:20px;">
        <div id="container_layer_list">
            <div style="line-height: 50px;height: 50px;">
                <div style="margin-left: 16px;float: left">
                    图层列表
                </div>

                <button onclick="switchListDetail(0)" id="btn_Add_layer" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
                    <i class="layui-icon">&#58916;</i>
                    手动添加图层
                </button>
                <button id="btn_Add_geojson" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 8px">
                    <input type="file" style=" width: 0.1px;height: 0.1px;opacity: 0;overflow: hidden; position: absolute; z-index: -1;" id="files" />
                    <label for="files"  style="cursor: pointer;"><i class="layui-icon">&#58916;</i>读取GeoJSON</label>
                </button>
            </div>
            <div style="width: 100%;border-bottom: 1px solid #787878;"></div>
            <div class="div_slate_list scrollbar_ul" style="height: 758px">
                <ul id="layerList">

                </ul>
            </div>
        </div>

        <!-- 图层添加 -->
        <div id="container_layer_detail" style="display: none">
            <div style="line-height: 50px;height: 50px;">
                <div id="layerAddOrEdit" style="margin-left: 16px;float: left">
                    图层添加
                </div>
                <button onclick="switchListDetail(1)" id="btn_Cancel" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
                <i class="layui-icon">&#58972;</i>
                返回
            </button>
                <button onclick="saveLayer()" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
                <i class="layui-icon">&#58885;</i>
                <i style="font-style: normal;">保存</i>
            </button>
            </div>
            <div style="width: 100%;border-bottom: 1px solid #787878;"></div>
            <div style="line-height: 50px;height: 50px;">
                <div style="margin-left: 16px;float: left;color: #009688">
                    图层基本信息
                </div>
            </div>
            <div style="width: 100%;border-bottom: 1px solid #787878;"></div>
            <div class="normal_list scrollbar_ul div_slate_list_no_hover">
                <form class="layui-form" lay-filter="form-edit">
                    <ul>
                        <li>
                            <span style="margin-left: 16px;font-size: 3px" class="layui-icon">&#58889;</span>
                            <span style="margin-left: 2px;width: 100px;display: inline-block;">图层名称</span>
                            <input id="layerName" class="layui-input" style="width:200px;float: right;margin-top: 5px;margin-right: 4px">
                        </li>
                        <li>
                            <span style="margin-left: 16px;font-size: 3px" class="layui-icon">&#58889;</span>
                            <span style="margin-left: 2px;width: 100px;display: inline-block;">图层固有属性字段</span>
                            <button onclick="openLayerFields()" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 5px;margin-right: 4px">
                            <i class="layui-icon">&#58946;</i>
                            <i style="font-style: normal;">编辑</i>
                        </button>
                        </li>
                    </ul>
                </form>
            </div>
            <div style="line-height: 50px;height: 50px;">
                <div style="margin-left: 16px;float: left;color: #009688">
                    图层要素
                </div>
                <button onclick="" id="btn_add_geo" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px;">
                <i class="layui-icon">&#58916;</i>
                添加
            </button>
                <button onclick="switchStyle()" id="btn_style" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
                <i class="layui-icon">&#58986;</i>
                样式
            </button>
                <div id="geoType" style="float: right;right: 4px;width: 80px;margin-top: 6px;margin-right: 10px"></div>
            </div>
            <div style="width: 100%;border-bottom: 1px solid #787878;"></div>
            <div class="div_slate_list scrollbar_ul" style="height: 528px">
                <ul id="geoList">

                </ul>
            </div>
        </div>
    </div>

    <div id="geoStyleContainer" class="container disno" style="left: 380px;top: 243px;">

    </div>

    <!-- 要素属性 -->
    <div id="container_geo_attributes" class="container disno" style="left: 380px;top: 151px;">
        <div style="line-height: 50px;height: 50px;">
            <div style="margin-left: 16px;float: left;color: #009688">
                要素属性
            </div>
            <button onclick="closeGeoAttrContainer()" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
            <i class="layui-icon">&#58972;</i>
            返回
        </button>
            <!--            <button onclick="addNewAttr()" id="btn_add_geo_attr" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">-->
            <!--                <i class="layui-icon">&#58916;</i>-->
            <!--                添加-->
            <!--            </button>-->
            <button onclick="saveGeoAttr()" id="saveGeoAttrBtn" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
            <i class="layui-icon">&#58885;</i>
            <i style="font-style: normal;">保存</i>
        </button>
        </div>
        <div style="width: 100%;border-bottom: 1px solid #787878;"></div>
        <div class="normal_list scrollbar_ul div_slate_list_no_hover" style="height: 568px;">
            <form class="layui-form" lay-filter="form-edit">
                <ul id="geoAttrList">

                </ul>
            </form>
        </div>
    </div>

    <!-- 图层固有属性 -->
    <div id="container_layer_fields" class="container disno" style="left: 380px;top: 151px;">
        <div style="line-height: 50px;height: 50px;">
            <div style="margin-left: 16px;float: left;color: #009688">
                图层固有属性
            </div>
            <button onclick="closeLayerFieldsContainer()" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
            <i class="layui-icon">&#58972;</i>
            返回
        </button>
            <button onclick="addNewFields()" id="btn_add_layer_field" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
            <i class="layui-icon">&#58916;</i>
            添加
        </button>
            <button onclick="saveLayerFields()" id="saveLayerFields" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">
            <i class="layui-icon">&#58885;</i>
            <i style="font-style: normal;">保存</i>
        </button>
        </div>
        <div style="width: 100%;border-bottom: 1px solid #787878;"></div>
        <div class="normal_list scrollbar_ul div_slate_list_no_hover" style="height: 568px;">
            <form class="layui-form" lay-filter="form-fields">
                <ul id="layerFieldsList">

                </ul>
            </form>
        </div>
    </div>

    <script>
        var viewer;
        var drawTool;
        let layerListId = 0;
        let layerList = []

        var styleConfig = {
            point: {
                name: '点',
                configs: [{
                    type: 'color',
                    name: 'color',
                    cn: '颜色',
                    defaultValue: '#b2ffc0'
                }, {
                    type: 'input',
                    name: 'pixelSize',
                    cn: '像素',
                    defaultValue: 10
                }, {
                    type: 'input',
                    name: 'outlineWidth',
                    cn: '边框宽度',
                    defaultValue: 3
                }, {
                    type: 'color',
                    name: 'outlineColor',
                    cn: '边框颜色',
                    defaultValue: '#3388ff'
                }]
            },

            polyline: {
                name: '线',
                configs: [{
                    type: 'color',
                    name: 'material',
                    cn: '颜色',
                    defaultValue: '#3388ff'
                }, {
                    type: 'input',
                    name: 'width',
                    cn: '宽度',
                    defaultValue: 3
                }, {
                    type: 'checkBox',
                    name: 'glow',
                    cn: '是否发光',
                    defaultValue: false
                }]
            },
            polygon: {
                name: '面',
                configs: [{
                    type: 'checkBox',
                    name: 'fill',
                    cn: '是否填充',
                    defaultValue: true
                }, {
                    type: 'color',
                    name: 'material',
                    cn: '颜色',
                    defaultValue: '#3388ff'
                }, {
                    type: 'color',
                    name: 'outlineColor',
                    cn: '边框颜色',
                    defaultValue: '#3388ff'
                }, {
                    type: 'input',
                    name: 'outlineWidth',
                    cn: '边框宽度',
                    defaultValue: 3
                }, {
                    type: 'progress',
                    name: 'alpha',
                    cn: '不透明度',
                    defaultValue: 0.2
                }]
            }
        };

        var CLASS_STYLE_CONTAINER = 'class_style_container';
        var constructStylePanel = function(type) {
            var obj = styleConfig[type];
            var styleClass = CLASS_STYLE_CONTAINER + ' ' + type;
            var html = '        <div class="' + styleClass + '"><div style="line-height: 50px;height: 50px;">\n' +
                '            <div style="margin-left: 16px;float: left;color: #009688">\n' +
                '                ' + obj.name + '\n' +
                '            </div>\n' +
                '<button  onclick="switchStyle()" id="btn_Cancel" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 10px;margin-right: 4px">\n' +
                '                    <i class="layui-icon">&#58972;</i>\n' +
                '                    返回\n' +
                '                </button>' +
                '        </div>\n' +
                '        <div style="width: 100%;border-bottom: 1px solid #787878;"></div>';
            var formFilter = 'form_' + type;
            html += '<div class="normal_list scrollbar_ul div_slate_list_no_hover">\n' +
                '            <form id="' + formFilter + '" class="layui-form" lay-filter="' + formFilter + '">\n' +
                '                <ul>\n';

            for (var index = 0; index < obj.configs.length; index++) {
                var config = obj.configs[index];
                if (config.type === 'input') {
                    html += ' <li>\n' +
                        '                        <span style="margin-left: 16px;width: 100px;display: inline-block;">' + config.cn + '</span>\n' +
                        '                        <input name="' + config.name + '" type="number" value="' + config.defaultValue + '" class="layui-input" style="width:200px;float: right;margin-top: 5px;margin-right: 4px">\n' +
                        '                    </li>';
                } else if (config.type === 'color') {
                    var colorDivId = 'layui_color_' + type + config.name;
                    var colorInputId = colorDivId + '_input';
                    html += '<li>\n' +
                        '                        <span style="margin-left: 16px;width: 100px;display: inline-block;">' + config.cn + '</span>\n' +
                        '                        <div class="layui_color"  id="' + colorDivId + '"  data-defaultValue="' + config.defaultValue + '" style="float: right;margin-right: 4px"></div>\n' +
                        '                        <input  id="' + colorInputId + '" name="' + config.name + '"  value="' + config.defaultValue + '" class="layui-input" style="width:168px;float: right;margin-top: 5px;margin-right: 4px">\n' +
                        '                    </li>';
                } else if (config.type === 'checkBox') {
                    var checked = config.defaultValue ? 'checked' : '';
                    html += '                    <li>\n' +
                        '                        <span style="margin-left: 16px;width: 100px;display: inline-block;">' + config.cn + '</span>\n' +
                        '                        <div style="float: right;margin-right: 4px">\n' +
                        '                            <input  type="checkbox" name="' + config.name + '" lay-skin="switch" lay-filter="' + config.name + '" lay-text="是|否" ' + checked + '>\n' +
                        '                        </div>\n' +
                        '                    </li>';
                } else if (config.type === 'progress') {
                    html += ' <li>\n' +
                        '                        <span style="margin-left: 16px;width: 100px;display: inline-block;">' + config.cn + '</span>\n' +
                        '                        <input class="sfm-m-vs-ctrl" style="float: right;margin-top: 10px;margin-right: 4px;width: 57%" name="' + config.name + '" type="range" min="0.01" max="1" step="0.01" value="' + config.defaultValue + '" title="不透明度">\n' +
                        '                    </li>';
                }
            }

            html += '                </ul>\n' +
                '            </form>\n' +
                '        </div></div>';

            return html;
        };

        var getGraphicStyle = function(type) {
            return layui.form.getValue('form_' + type);
        };

        var init = function() {
            var point = {
                longitude: 114.40,
                latitude: 30.45,
                height: 5000
            };
            viewer = zUtil.initCesium($, 'divCesiumContainer', {}, point);
            locationUtil.initLocation(Cesium, viewer);
            drawTool = new DrawTool({
                Cesium: Cesium,
                viewer: viewer,
                hasEdit: false
            });

            layui.use(['colorpicker', 'xmSelect', 'form', 'slider', "okUtils", 'constantUrl', 'okLayer'], function() {
                var html = constructStylePanel('point');
                html += constructStylePanel('polyline');
                html += constructStylePanel('polygon');
                $('#geoStyleContainer').html(html);

                var layui_color_doms = $($('#geoStyleContainer .layui_color'));
                for (var index = 0; index < layui_color_doms.length; index++) {
                    var dom = layui_color_doms[index];
                    layui.colorpicker.render({
                        elem: '#' + dom.id, //绑定元素
                        color: dom.dataset.defaultvalue, //设置默认色
                        done: function(color) { //颜色改变的回调
                            $($(this)[0].elem + '_input').val(color);
                            getGraphicStyle('polygon');
                        }
                    });
                }
                layui.form.on('checkbox(modelCheck)', function(data) {
                    var index = data.othis[0].parentElement.dataset.index;
                    var datasource = zUtil.getDataSourceByName(Cesium, viewer, index);
                    datasource.show = data.elem.checked;
                    return false;
                });
                $('#geoStyleContainer .selectImg').off('click').on('click', function() {
                    var id = $(this)[0].id;
                    layui.okLayer.open("标注图片选择", "../markIcon/markIcon.html", "60%", "70%", function(dom, index) {
                        var iframeWin = window[dom.find("iframe")[0]["name"]];
                        iframeWin.initData(true, '标注图');
                        sessionStorage.setItem("tempId", id);
                    }, function() {
                        var id = sessionStorage.getItem('tempId');
                        var pic = sessionStorage.getItem("callback");
                        if (!pic || pic === '') {
                            return;
                        }
                        $("#" + id).attr("src", layui.constantUrl.baseTempUrl + pic);
                        $("#" + id + '_input').val(pic);
                        sessionStorage.removeItem("callback");
                        sessionStorage.removeItem("tempId");
                        sessionStorage.removeItem("callbackName");
                    });
                });
                $('#geoStyleContainer .selectModel').off('click').on('click', function() {
                    var id = $(this)[0].id;
                    layui.okLayer.open("模型选择", "../markIcon/markIcon.html", "60%", "70%", function(dom, index) {
                        var iframeWin = window[dom.find("iframe")[0]["name"]];
                        iframeWin.initData(true, '模型');
                        sessionStorage.setItem("tempId", id);
                    }, function() {
                        var id = sessionStorage.getItem('tempId');
                        var pic = sessionStorage.getItem("callback");
                        if (!pic || pic === '') {
                            return;
                        }
                        $("#" + id + '_input').val(pic);
                        $('#' + id + ' i').html(sessionStorage.getItem('callbackName'));
                        sessionStorage.removeItem("callback");
                        sessionStorage.removeItem("tempId");
                        sessionStorage.removeItem("callbackName");
                    });
                });

                layui.form.render();
                getAllLayerList();
            })

            locationUtil.initLocation(Cesium, viewer);
        };

        var getAllLayerList = function() {
            currentLayerList = layerList;
            drawAllLayer(layerList);
            initLayerList(layerList);
            layui.form.render();

        };

        var isAdd = true;
        var currentLayerList = [];
        var currentEditLayerInfo;
        var initLayerList = function(layerList) {
            var html = '';
            for (var index = 0; index < layerList.length; index++) {
                const item = layerList[index];
                html += '<form class="layui-form"><li data-index="' + item.id + '">\n' +
                    '                        <span style="margin-left: 16px;font-size: 3px" class="layui-icon">&#58903;</span>' +
                    '                        <span id="layerNameSpan" data-index="' + item.id + '" style="margin-left: 2px;width: 140px;display: inline-block" >' + item.name + '</span>\n' +
                    '                        <input type="checkbox"  data-index="' + index + '" checked lay-filter="modelCheck">\n                                           ' +
                    '                        <button type="button" data-index="' + index + '" id="' + item.id + '" class="layui-btn layui-btn-primary layui-btn-xs delete" style="float: right;margin-top: 9px;margin-right: 4px">\n' +
                    '                            <i class="layui-icon">&#58944;</i>\n' +
                    '                            删除\n' +
                    '                        </button>\n' +
                    '                        <button type="button"  data-index="' + index + '" id="' + item.id + '" class="layui-btn layui-btn-primary layui-btn-xs edit" style="float: right;margin-top: 9px;margin-right: 2px">\n' +
                    '                            <i class="layui-icon">&#58946;</i>\n' +
                    '                            编辑\n' +
                    '                        </button>\n' +
                    '                    </li></form>';
            }
            $('#layerList').html(html);

            $('#layerList li #layerNameSpan').off('click').on('click', function() {
                var index = $(this)[0].dataset.index;
                var datasource = zUtil.getDataSourceByName(Cesium, viewer, index);
                viewer.flyTo(datasource);
                zUtil.twinklingGeometry(datasource);
            });

            $('#layerList .delete').off('click').on('click', function() {
                var layerId = $(this).attr("id");
                var index = $(this)[0].dataset.index;
                currentLayerList[index].dataSource.entities.removeAll();
                for (let i = 0; i < layerList.length; i++) {
                    if (layerList[i].id == layerId) {
                        layerList.splice(i, 1);
                    }
                };
                getAllLayerList();

                return false;
            });
            $('#layerList .edit').off('click').on('click', function() {
                switchListDetail(0);
                isAdd = false;
                tempDeleteEntity = [];
                var index = $(this)[0].dataset.index;
                var layerInfo = currentLayerList[index];
                currentEditLayerInfo = layerInfo;
                currentAllFields = layerInfo.fields;
                $('#layerName').val(layerInfo.name);
                var elements = layerInfo.elements;
                tempDeleteElements = zUtil.deepCopy(elements);
                tempGeos = elements;
                currentEditId = $(this).attr("id");
                initGeoList(elements);
                $('#layerAddOrEdit').html('图层编辑');
                return false;
            });
        };

        var geoStyleSelect;
        var switchListDetail = function(type) {
            $(type === 0 ? '#container_layer_list' : '#container_layer_detail').hide();
            $(type === 1 ? '#container_layer_list' : '#container_layer_detail').show();
            if (type === 0) {
                isAdd = true;
                $('#layerAddOrEdit').html('图层添加');
                $('#layerName').val('');
                geoStyleSelect = layui.xmSelect.render({
                    el: '#geoType',
                    name: 'geoType',
                    repeat: true,
                    radio: true,
                    clickClose: true,
                    data: [{
                        name: '点',
                        value: 'point',
                        selected: true
                    }, {
                        name: '线',
                        value: 'polyline'
                    }, {
                        name: '面',
                        value: 'polygon'
                    }, ],
                    theme: {
                        color: '#333333',
                    },
                    model: {
                        label: {
                            type: 'block',
                            block: {
                                showCount: 0,
                                showIcon: false, //是否显示删除图标
                            }
                        }
                    },
                    on: function(data) {
                        if (data.arr && data.arr.length !== 0) {
                            var exist = geoStyleSelect.getValue('valueStr');
                            if (!exist || exist === '' || exist !== data.arr[0].value) {
                                switchGeoStyleVisible(data.arr[0].value);
                            }
                        }
                    },
                });

                $('#btn_add_geo').off('click').on('click', function() {
                    var geoType = geoStyleSelect.getValue('valueStr');
                    var style = getGraphicStyle(geoType);
                    style.tempUrl = layui.constantUrl.baseTempUrl;
                    drawTool.startDraw({
                        type: geoType,
                        style: style,
                        success: function(evt) {
                            viewer.scene.globe.depthTestAgainstTerrain = false;
                            onSingleGeoSuccess(geoType, evt);
                        }
                    });
                });
            } else {
                tempGeos = [];
                viewer.entities.removeAll();
                for (var index = 0; index < tempDeleteEntity.length; index++) {
                    tempDeleteEntity[index].show = true;
                }
                if (currentEditLayerInfo) {
                    currentEditLayerInfo.elements = tempDeleteElements;
                }
                $('#geoStyleContainer').hide();
                $('#container_geo_attributes').hide();
                $('#geoList').html('');
            }
        };

        var switchStyle = function() {
            switchGeoStyleVisible();
            $('#container_geo_attributes').hide();
            $('#geoStyleContainer').toggle();

        };

        function switchGeoStyleVisible(type) {
            var parent = $('.' + CLASS_STYLE_CONTAINER);
            var geoType = type || geoStyleSelect.getValue('valueStr');
            for (var index = 0; index < parent.length; index++) {
                var item = parent[index];
                if ($(item).hasClass(geoType)) {
                    $(item).show();
                } else {
                    $(item).hide();
                }
            }
        }

        var drawAllLayer = function() {
            for (var index = 0; index < currentLayerList.length; index++) {
                var elements = currentLayerList[index].elements;
                var element = elements;
                currentLayerList[index].elements = element;
                var dataSource = zUtil.getDataSourceByName(Cesium, viewer, currentLayerList[index].id);
                dataSource.entities.removeAll();
                currentLayerList[index].dataSource = dataSource;
                drawSingleLayer(element, dataSource);
            }
        };

        var drawSingleLayer = function(element, dataSource) {
            for (var index = 0; index < element.length; index++) {
                var geoInfo = element[index];
                (function(geoInfo) {
                    var type = geoInfo.type;
                    var label = {
                        text: geoInfo.attributes['名称'],
                        font: '16px sans-serif',
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 5,
                        fillColor: Cesium.Color.fromCssColorString("#ffffff"),
                        pixelOffset: new Cesium.Cartesian2(0, -20),
                        scaleByDistance: new Cesium.NearFarScalar(5000, 1.0, 7000, 0.7),
                    };
                    switch (type) {
                        case 'point':
                            zUtil.getHeight(Cesium, viewer, [Cesium.Cartographic.fromDegrees(geoInfo.geometry.longitude, geoInfo.geometry.latitude)], function(updatePoints) {
                                var point = dataSource.entities.add({
                                    position: Cesium.Cartesian3.fromDegrees(geoInfo.geometry.longitude, geoInfo.geometry.latitude, updatePoints[0].height),
                                    point: {
                                        pixelSize: geoInfo.style.pixelSize,
                                        color: Cesium.Color.fromCssColorString(geoInfo.style.color),
                                        outlineColor: Cesium.Color.fromCssColorString(geoInfo.style.outlineColor),
                                        outlineWidth: geoInfo.style.outlineWidth,
                                    },
                                    label: label
                                });
                                geoInfo.entity = point;
                            });
                            break;

                        case 'polyline':
                            var centerPoint = geoInfo.geometry[parseInt(geoInfo.geometry.length / 2)];
                            zUtil.getHeight(Cesium, viewer, [Cesium.Cartographic.fromDegrees(centerPoint.longitude, centerPoint.latitude)], function(updatePoints) {
                                var positions = [];
                                for (var pointIndex = 0; pointIndex < geoInfo.geometry.length; pointIndex++) {
                                    var point = geoInfo.geometry[pointIndex];
                                    positions.push(Cesium.Cartesian3.fromDegrees(point.longitude, point.latitude));
                                }
                                var polyline = dataSource.entities.add({
                                    position: Cesium.Cartesian3.fromDegrees(centerPoint.longitude, centerPoint.latitude, updatePoints[0].height),
                                    polyline: {
                                        positions: positions,
                                        show: true,
                                        material: geoInfo.style.glow ? new Cesium.PolylineGlowMaterialProperty({
                                            color: Cesium.Color.fromCssColorString(geoInfo.style.material),
                                            glowPower: 0.5,
                                            taperPower: 1
                                        }) : Cesium.Color.fromCssColorString(geoInfo.style.material),
                                        width: geoInfo.style.width,
                                        clampToGround: true
                                    },
                                    label: label
                                });
                                geoInfo.entity = polyline;
                            });
                            break;
                        case 'polygon':
                            var centerPoint = zUtil.getPolygonGravityPoint(geoInfo.geometry);
                            zUtil.getHeight(Cesium, viewer, [Cesium.Cartographic.fromDegrees(centerPoint.longitude, centerPoint.latitude)], function(updatePoints) {
                                var positions = [];
                                for (var pointIndex = 0; pointIndex < geoInfo.geometry.length; pointIndex++) {
                                    var point = geoInfo.geometry[pointIndex];
                                    var cartesian = Cesium.Cartesian3.fromDegrees(point.longitude, point.latitude, 10000);
                                    positions.push(cartesian);
                                }
                                var polygon = dataSource.entities.add({
                                    position: Cesium.Cartesian3.fromDegrees(centerPoint.longitude, centerPoint.latitude, updatePoints[0].height),
                                    polygon: {
                                        hierarchy: positions,
                                        material: Cesium.Color.fromCssColorString(geoInfo.style.material).withAlpha(geoInfo.style.alpha),
                                        clampToGround: true,
                                        show: true,
                                        fill: geoInfo.style.fill && geoInfo.style.fill === 'on',
                                        outlineColor: Cesium.Color.fromCssColorString(geoInfo.style.outlineColor),
                                        outlineWidth: geoInfo.style.outlineWidth,
                                        outline: true,
                                    },
                                    label: label
                                });
                                geoInfo.entity = polygon;
                            });
                            break;
                    }
                })(geoInfo);
            }
        };

        var tempGeos = [];
        var currentEditId;
        var onSingleGeoSuccess = function(geoType, evt) {
            var geos;
            var style;
            var entity;
            switch (geoType) {
                case 'point':
                    var car = evt.point.position._value;
                    geos = zUtil.cartesian3ToGeo(Cesium, viewer, car);
                    style = getGraphicStyle(geoType);
                    entity = evt.point;
                    break;

                case 'polyline':
                    var cars = evt.polyline.positions.getValue();
                    geos = turnCartesian3ToGeo(cars);
                    style = getGraphicStyle(geoType);
                    entity = evt;
                    break;
                case 'polygon':
                    var cars = evt.positions;
                    geos = turnCartesian3ToGeo(cars);
                    style = getGraphicStyle(geoType);
                    entity = evt.polygon;
                    break;
            }
            var attributes = {};
            if (currentAllFields.length === 0) {
                currentAllFields.push({
                    field: '名称'
                });
            }
            currentAllFields.forEach(function(item) {
                if (item.field === '名称') {
                    attributes[item.field] = geoType;
                } else {
                    attributes[item.field] = '';
                }
            });
            tempGeos.push({
                geometry: geos,
                type: geoType,
                style: style,
                entity: entity,
                attributes: attributes
            });
            initGeoList(tempGeos);
        };
        var turnCartesian3ToGeo = function(cars) {
            var geos = [];
            for (var index = 0; index < cars.length; index++) {
                var geo = zUtil.cartesian3ToGeo(Cesium, viewer, cars[index]);
                geos.push(geo);
            }
            return geos;
        };

        var tempDeleteEntity = [];
        var tempDeleteElements = [];
        var initGeoList = function(geoList) {
            var html = '';
            for (var index = 0; index < geoList.length; index++) {
                const item = geoList[index];
                var liId = 'li_' + index;
                html += '<li data-index="' + index + '" id="' + liId + '">\n' +
                    '                        <span style="margin-left: 16px;font-size: 3px" class="layui-icon">&#58903;</span>' +
                    '                        <span style="margin-left: 2px" >' + item.attributes['名称'] + '</span>\n' +
                    '                        <button type="button" data-index="' + index + '" id="' + item.entity.id + '" class="layui-btn layui-btn-primary layui-btn-xs delete" style="float: right;margin-top: 9px;margin-right: 4px">\n' +
                    '                            <i class="layui-icon">&#58944;</i>\n' +
                    '                            删除\n' +
                    '                        </button>\n' +
                    '                        <button type="button"  data-index="' + index + '" id="' + item.id + '" class="layui-btn layui-btn-primary layui-btn-xs edit" style="float: right;margin-top: 9px;margin-right: 10px">\n' +
                    '                            <i class="layui-icon">&#58946;</i>\n' +
                    '                            属性\n' +
                    '                        </button>\n' +
                    '                    </li>';
            }
            $('#geoList').html(html);
            $('#geoList li').off('click').on('click', function() {
                var index = $(this)[0].dataset.index;
                viewer.flyTo(tempGeos[index].entity);
                zUtil.twinklingGeometry(tempGeos[index].entity);

            });
            $('#geoList .delete').off('click').on('click', function() {
                var index = $(this)[0].dataset.index;
                tempGeos[index].entity.show = false;
                tempDeleteEntity.push(tempGeos[index].entity);
                $('#geoList #li_' + index).remove();
                tempGeos.splice(index, 1);
                initGeoList(tempGeos);
                return false;
            });
            $('#geoList .edit').off('click').on('click', function() {
                var index = $(this)[0].dataset.index;
                $('#saveGeoAttrBtn')[0].dataset.index = index;
                $('#geoStyleContainer').hide();
                $('#container_geo_attributes').show();
                setExistAttr(tempGeos[index].attributes);
                return false;
            });
        };

        var closeGeoAttrContainer = function() {
            $('#container_geo_attributes').hide();
        };

        var closeGeoStyleContainer = function() {
            $('#geoStyleContainer').hide();
        };

        var setExistAttr = function(attrs) {
            $('#geoAttrList').html('');
            currentAllFields.forEach(function(item) {
                addNewAttr(item.field, attrs[item.field]);
            });
        };

        var saveGeoAttr = function() {
            var atts = {};
            var lis = $('#geoAttrList li');
            for (var index = 0; index < lis.length; index++) {
                var key = $(lis[index]).find('input[id=key]').val();
                var value = $(lis[index]).find('input[id=value]').val();
                atts[key] = value;
            }
            var index = $('#saveGeoAttrBtn')[0].dataset.index;
            tempGeos[index].attributes = atts;
            initGeoList(tempGeos);
            closeGeoAttrContainer();
        };

        var addNewAttr = function(key, value) {
            key = key || '';
            value = value || '';
            var li = '<li>\n' +
                '                        <input value="' + key + '" id="key" class="layui-input" disabled="disabled" style="width:120px;float: left;margin-top: 5px;margin-left: 4px" placeholder="属性名称">\n' +
                '                        <input value="' + value + '" id="value" class="layui-input" style="width:200px;float: right;margin-top: 5px;margin-right: 4px" placeholder="属性值">\n' +
                '                    </li>';
            $('#geoAttrList').append(li);
        };

        var saveLayer = function() {
            var layerName = $('#layerName').val();
            if (!layerName) {
                layer.msg('请填写图层名称');
                return;
            }
            for (var index = 0; index < tempGeos.length; index++) {
                delete tempGeos[index].entity;
            }
            var elements = JSON.stringify(tempGeos);
            let saveTempGeos = [];
            for (let item of tempGeos) {
                let type;
                let coordinates = [];
                if (item.type === 'point') {
                    type = 'Point';
                    coordinates = [item.geometry.longitude, item.geometry.latitude];
                } else if (item.type === 'polyline') {
                    type = 'LineString';
                    for (let j of item.geometry) {
                        coordinates.push([j.longitude, j.latitude])
                    }
                } else if (item.type === 'polygon') {
                    type = 'Polygon';
                    coordinates.push([])
                    for (let j of item.geometry) {
                        coordinates[0].push([j.longitude, j.latitude])
                    }
                    coordinates[0].push([item.geometry[0].longitude, item.geometry[0].latitude])
                };
                saveTempGeos.push({
                    type: "Feature",
                    geometry: {
                        type: type,
                        coordinates: coordinates
                    },
                    properties: item.attributes
                });
            }
            //保存geojson
            let geojson = {
                type: "FeatureCollection",
                features: saveTempGeos
            }
            var geojsons = JSON.stringify(geojson);
            var blob = new Blob([geojsons], {
                type: "text/plain;charset=utf-8"
            });
            saveAs(blob, `${layerName}.geojson`);
            if (isAdd) {
                layerList.push({
                    name: layerName,
                    elements: tempGeos,
                    fields: currentAllFields,
                    id: layerListId++
                });
            } else {
                for (let i = 0; i < layerList.length; i++) {
                    if (layerList[i].id == currentEditId) {
                        layerList[i] = {
                            name: layerName,
                            elements: tempGeos,
                            fields: currentAllFields,
                            id: currentEditId
                        }
                    }
                };
                tempDeleteEntity = [];
            }
            switchListDetail(1);
            getAllLayerList();
        };

        function openLayerFields() {
            $('#layerFieldsList').html('');
            if (currentAllFields.length === 0) {
                currentAllFields.push({
                    field: '名称'
                });
            }
            currentAllFields.forEach(function(item) {
                addNewFields(item.field, item.unit);
            });
            $('#container_layer_fields').show();
        }

        function closeLayerFieldsContainer() {
            $('#container_layer_fields').hide();
        }

        function addNewFields(key, value) {
            key = key || '';
            value = value || '';
            var li = '<li>\n' +
                '                        <input value="' + key + '" id="key" class="layui-input" style="width:200px;float: left;margin-top: 5px;margin-left: 12px" placeholder="字段">\n' +
                '                        <button  id="deleteFields" type="button" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 5px;margin-right: 4px">\n' +
                '                <i class="layui-icon">&#4102;</i>\n' +
                '                \n' +
                '            </button>                                                                         \n' +
                //'                        <input value="' + value + '" id="value" class="layui-input" style="width:165px;float: right;margin-top: 5px;margin-right: 4px" placeholder="单位">\n' +
                '                    </li>';
            $('#layerFieldsList').append(li);

            $('#layerFieldsList #deleteFields').off('click').on('click', function() {
                $(this)[0].parentNode.remove();
            })
        }

        var currentAllFields = [];

        function saveLayerFields() {
            currentAllFields = [];
            var lis = $('#layerFieldsList li');
            for (var index = 0; index < lis.length; index++) {
                var key = $(lis[index]).find('input[id=key]').val();
                var value = $(lis[index]).find('input[id=value]').val();
                currentAllFields.push({
                    field: key,
                    unit: value
                });
            }
            closeLayerFieldsContainer();
        }

        //读取geojosn文件功能
        let inputElement = document.getElementById("files");
        inputElement.addEventListener("change", handleFiles, false);

        let asdsadasda = 100;

        function handleFiles() {
            let selectedFile = document.getElementById("files").files[0]; //获取读取的File对象
            let name = selectedFile.name.match(/(\S*)\./)[1]; //读取选中文件的文件名
            let suffix = selectedFile.name.match(/\.(\S*)/)[1];
            if (suffix !== 'geojson') {
                layer.msg('请选择读取geojson文件');
                return;
            }
            let size = selectedFile.size; //读取选中文件的大小
            let reader = new FileReader(); //这里是核心！！！读取操作就是由它完成的。
            reader.readAsText(selectedFile); //读取文件的内容
            reader.onload = function() {
                let readGeojson = JSON.parse(this.result);
                var readElements = [];
                for (let item of readGeojson.features) {

                    let type = item.geometry.type;
                    let coordinates = item.geometry.coordinates;
                    let geometry;
                    if (type === 'Point') {
                        type = 'point'
                        geometry = {
                            "longitude": coordinates[0],
                            "latitude": coordinates[1]
                        }
                    } else if (type === 'LineString') {
                        type = 'polyline'
                        geometry = []
                        for (let coordinate of coordinates) {
                            geometry.push({
                                "longitude": coordinate[0],
                                "latitude": coordinate[1]
                            })
                        }
                    } else if (type === 'Polygon') {
                        type = 'polygon'
                        geometry = []
                        for (let coordinate of coordinates[0]) {
                            geometry.push({
                                "longitude": coordinate[0],
                                "latitude": coordinate[1]
                            })
                        }
                    };
                    let style = {
                        point: {
                            "color": "#b2ffc0",
                            "pixelSize": "10",
                            "outlineWidth": "3",
                            "outlineColor": "#3388ff"
                        },
                        polyline: {
                            "material": "#3388ff",
                            "width": "3"
                        },
                        polygon: {
                            "fill": "on",
                            "material": "#3388ff",
                            "outlineColor": "#3388ff",
                            "outlineWidth": "3",
                            "alpha": "0.2"
                        }
                    }
                    readElements.push({
                        "geometry": geometry,
                        "type": type,
                        "style": style[type],
                        "attributes": item.properties
                    })
                }
                layerList.push({
                    "elements": readElements,
                    "name": name,
                    "remark": "",
                    "id": asdsadasda++,
                    "time": "2020-06-16 14:48:47",
                    "fields": [{
                        "field": "名称"
                    }]
                });
                switchListDetail(1);
                getAllLayerList();
            };
        };
    </script>
</body>

</html>
