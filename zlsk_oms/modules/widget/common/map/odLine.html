<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <link rel="stylesheet" href="./css/zCss.css">
    <script type="text/javascript" src="../../../../lib/sfmbase/sfmUtil.js"></script>
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <script src="./zUtil.js"></script>
    <script type="text/javascript">
        SFM.sfmUtil.loadJquery();
        SFM.sfmUtil.loadSfmBase();
        SFM.sfmUtil.loadCesium('1.60');
        SFM.sfmUtil.load(
            '/modules/lib/drawPlot/createBillboard.js',
            '/modules/lib/drawPlot/createLabel.js',
            '/modules/lib/drawPlot/createPoint.js',
            '/modules/lib/drawPlot/createPolygon.js',
            '/modules/lib/drawPlot/createPolyline.js',
            '/modules/lib/drawPlot/createRectangle.js',
            '/modules/lib/drawPlot/createImgRectangle.js',
            '/modules/lib/drawPlot/createCorridor.js',
            '/modules/lib/drawPlot/createCircle.js',
            '/modules/lib/drawPlot/createCylinder.js',
            '/modules/lib/drawPlot/drawTool.js',
        );
    </script>
    <script type="text/javascript">
        SFM.CesiumEarthWidget = SFM.SfmResizableWidgetBase.extend({
            constructor: function(options) {
                var me = this;
                me.base(options);
            },
            destroy: function() {
                this.base();
            },
            render: function() {
                var me = this;
                me.base();
                return me;
            },
            getEarthContext: function() {
                return earthCtx;
            },
            __className__: 'CesiumEarthWidget'
        });
        var sfmWidget = new SFM.CesiumEarthWidget();
    </script>
</head>

<body onload="startup()">
<div id="divCesiumContainer" class="layui-body-map commonOutCss">
</div>

<script>
    function startup() {
        var  viewer = new Cesium.Viewer('divCesiumContainer', {
            animation: true,//左下角动画组件
            baseLayerPicker: false,//地图选择按钮
            fullscreenButton: true,//全屏按钮,
            vrButton: false,//右下角全屏按钮旁VR开启按钮
            geocoder: false,//右上角第一个地理编码按钮
            homeButton: true,//复位按钮
            infoBox: false,
            sceneModePicker: false,//视角模式按钮
            selectionIndicator: false,
            timeline: true,//时间线
            navigationHelpButton: false,//帮助按钮,
            navigationInstructionsInitiallyVisible: false,
            scene3DOnly: false,
            shadows: true,
            imageryProvider: new Cesium.ArcGisMapServerImageryProvider({
                // url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer',
                url:'//map.geoq.cn/arcgis/rest/services/ChinaOnlineStreetPurplishBlue/MapServer',
            })
        });
        viewer._cesiumWidget._creditContainer.style.display="none";
        viewer.scene.debugShowFramesPerSecond = false;
        viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function(e) {
            e.cancel = true;
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(112.3050799800,30.2642187600,10000)
            });
        });
        viewer.camera.flyTo({
            destination : Cesium.Cartesian3.fromDegrees(112.3050799800,30.2642187600,250000),
            orientation : {
                heading : Cesium.Math.toRadians(0.0),
                pitch : Cesium.Math.toRadians(-90.0),
                roll : 0.0
            }
        });

        var polylinePointsArray = [];
        var totalTime = 1000;
        var start = Cesium.JulianDate.fromDate(new Date(2020, 3, 2));
        var stop = Cesium.JulianDate.addSeconds(start, totalTime, new Cesium.JulianDate());
        viewer.clock.startTime = start.clone();
        viewer.clock.currentTime = start.clone();
        viewer.clock.stopTime = stop.clone();
        viewer.clock.multiplier = 600;
        viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
        viewer.clock.shouldAnimate = false;

        layui.use(["okUtils", 'constantUrl',],function () {
            layui.okUtils.ajax({
                url:layui.constantUrl.stBase.easySelect,
                data:{
                    table:'st_layers',
                    mapStr:JSON.stringify({name:'od'})
                }
            }).done(function(data){
                var layerList = data.data;
                polylinePointsArray = [];
                for (var _index = 0;_index < layerList.length;_index++){
                    var layers = JSON.parse(layerList[_index].elements);
                    for(var index = 0;index < layers.length;index ++){
                        polylinePointsArray.push(layers[index].geometry);
                    }
                }
                add();
            });
        });

        function add() {
            for (var arrayIndex = 0;arrayIndex < polylinePointsArray.length;arrayIndex ++){
                var polylinePoints = polylinePointsArray[arrayIndex];

                var positions = [];
                for (var index = 0;index < polylinePoints.length;index ++){
                    positions.push(Cesium.Cartesian3.fromDegrees(polylinePoints[index].longitude, polylinePoints[index].latitude));
                }
                viewer.entities.add({
                    polyline:{
                        positions: positions,
                        show: true,
                        material:Cesium.Color.fromCssColorString('#FFA500').withAlpha(0.5),
                        width: 2,
                        clampToGround: true,
                    },
                });

                var property = computeFlight(polylinePoints);
                viewer.entities.add({
                    position: property,
                    path: {
                        show: true,
                        leadTime: 50,
                        trailTime: 50,
                        width: 2,
                        resolution: 2,
                        material:getColorRamp(),
                    }
                });
            }
        }

        function computeFlight(source) {
            var property = new Cesium.SampledPositionProperty();
            var timeStep = 0;
            for (var i = 0; i < source.length; i++) {
                var time = Cesium.JulianDate.addSeconds(start, timeStep, new Cesium.JulianDate);
                var position = Cesium.Cartesian3.fromDegrees(source[i].longitude, source[i].latitude);
                property.addSample(time, position);
                timeStep += totalTime / (source.length - 1);
            }
            return property;
        }

        /*
         * 横向渐变
         */
        function getColorRamp() {
            var ramp = document.createElement('canvas');
            ramp.width = 100;
            ramp.height = 1;
            var ctx = ramp.getContext("2d");
            var my_gradient = ctx.createLinearGradient(0, 0, 100, 0);
            my_gradient.addColorStop(0, "#646400");
            my_gradient.addColorStop(1, "#FFFF00");
            ctx.fillStyle = my_gradient;
            ctx.fillRect(0, 0, 100, 1);
            return ramp;
        }
    }
</script>
</body>

</html>
