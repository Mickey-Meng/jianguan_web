<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>地图方案</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <style>
    </style>
</head>

<body>
    <div class="layui-body commonOutCss" style="left: 0;" id="content">
        <form class="layui-form ok-form" lay-filter="filter" id="cform">
            <div class="layui-input-inline">
                <label class="layui-form-label">方案名称</label>
                <div class="layui-input-block">
                    <input type="text" name="pname" placeholder="方案名称" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-input-inline" style="margin-top: 2px;height: 38px;margin-left: 20px;">
                <button class="layui-btn" lay-submit="" lay-filter="search" title="条件查询">
                    <i class="layui-icon">&#xe615;</i>
                </button>
            </div>
        </form>
        <div>
            <table class="layui-hide" id="mapConfigRecords" lay-filter="mapConfigRecords"></table>
        </div>
        <div style="text-align: center;height: 25px;">
            <button class="layui-btn" lay-submit id="add">立即提交</button>
        </div>
    </div>
    <script>
    var $;
    var result = null;

    function initForm(selectData,index) {
        layui.use(['tree', 'form', 'table', 'okUtils', "okLayer", 'constantUrl', 'zTable', 'layer'], function() {
            $ = layui.jquery;
            var tree = layui.tree;
            var okUtils = layui.okUtils;
            var constantUrl = layui.constantUrl;
            var okLayer = layui.okLayer;
            var form = layui.form;
            var table = layui.table;
            var layer = layui.layer;
            var param = { mId: selectData.id,ptype:index };
            var h = $('#content').height();
            var fh = $('#cform').height();
            var th = h - fh -30;
            var zTable = layui.zTable({
                elem: '#mapConfigRecords',
                page: false, //是否显示分页
                url: constantUrl.stMap.selectNoPer,
                where: param,
                parseData: function(res) { //res 即为原始返回的数据
                    if (!res.data) {
                        return {
                            "code": res.meow, //解析接口状态
                            "msg": "无数据", //解析提示文本
                            "count": 0, //解析数据长度
                            "data": [] //解析数据列表
                        };
                    }
                    return {
                        "code": res.meow, //解析接口状态
                        "msg": res.data.msg, //解析提示文本
                        "data": res.data.getMe //解析数据列表
                    };
                },
                height: th,
                cols: [
                    [ //标题栏
                        { type: 'checkbox', width: 50 },
                        { field: 'pname', title: '方案名称' }, { field: 'createtime', title: '添加时间' }
                    ]
                ]
            });

            var myTable = zTable.getTable();

            form.on("submit(search)", function(data) {
                var param = {};
                param.pname = data.field.pname;
                myTable.reload({
                    url: constantUrl.stMap.selectNoPer,
                    where: param
                });
                return false;
            });


            $('#add').click(function() {
                var checkStatus = table.checkStatus('mapConfigRecords');
                if (selectData == null) {
                    layer.msg('请选择关联对象');
                    return false;
                }
                var d = checkStatus.data;
                if (d.length == 0) {
                    layer.msg('请勾选方案');
                    return false;
                }
                if (Number(selectData.id) < 0) {
                    layer.msg('请选择关联对象');
                    return false;
                }
                var jsonobj = [];
                for (var i = 0; i < d.length; i++) {
                    jsonobj.push({
                        associateId: selectData.id,
                        mId: d[i].ID,
                        ptype: index
                    })
                }
                var m = JSON.stringify(jsonobj);
                var param = {};
                param.mps = m;
                okUtils.ajax({ "url": constantUrl.stMap.addMapPermission, "param": param, type: 'POST' }).done(function(response) {
                    okLayer.msg.greenTick("添加成功", function() {
                         parent.layer.close(parent.layer.getFrameIndex(window.name));
                    });
                }).fail(function(error) {
                    console.log(error)
                });
            });


        })
    }
    </script>
</body>

</html>
