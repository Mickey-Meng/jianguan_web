<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>注册地图服务</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/oksub.css">
</head>

<body>
    <div class="ok-body">
        <!--form表单-->
        <form class="layui-form ok-form" lay-filter="filter">
            <div class="layui-form-item">
                <label class="layui-form-label">服务类型</label>
                <div class="layui-input-block">
                    <select name="type" lay-filter="type" id="select">
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">服务名称</label>
                <div class="layui-input-block" id="serverInput">
                    <input type="text" name="serverName" placeholder="服务名称" autocomplete="off" class="layui-input" >
                </div>
                <div class="layui-input-block" id="serverSelect" style="display: none;">
                    <select name="serverNameSelect" lay-filter="serverNameSelect" id="ssver">
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">服务地址</label>
                <div class="layui-input-block">
                    <input type="text" name="url" placeholder="服务地址" autocomplete="off" class="layui-input" >
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">服务缩略图</label>
                <div class="layui-input-block">
                    <div class="layui-input" style="height: 38px;line-height: 38px">
                        <input value="" style="display: none" name="img">
                        <span id="mapConfigImgName"></span>
                        <button id="mapImgButton" class="layui-btn layui-btn-primary layui-btn-sm" style="float: right;margin-top: 3px;margin-right: 5px">图片选择</button>
                    </div>
                </div>
            </div>
           <!--  <div class="layui-form-item">
                <label class="layui-form-label">是否可见</label>
                <div class="layui-input-block">
                    <select name="visiable" lay-filter="visiable">
                        <option value="-1"></option>
                        <option value="1">可见</option>
                        <option value="0">不可见</option>
                    </select>
                </div>
            </div> -->
            <div class="layui-form-item">
                <label class="layui-form-label">属性信息</label>
                <div class="layui-input-block">
                    <button class="layui-btn" id="attr" title="添加属性" style="display: none;">
                        添加属性
                        <i class="layui-icon">&#58964;</i>
                    </button>
                    <button class="layui-btn" id="attr1" title="编辑属性" style="display: none;">
                        编辑属性
                        <i class="layui-icon">&#58964;</i>
                    </button>
                </div>
            </div>
            <!--    <div class="layui-form-item">
                <label class="layui-form-label">描述</label>
                <div class="layui-input-block">
                    <textarea placeholder="请输入内容" class="layui-textarea" name="description"></textarea>
                </div>
            </div> -->
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="add">立即提交</button>
                </div>
            </div>
        </form>
    </div>
    <!--js逻辑-->
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <script>
    var $;
    var attrObj = null;
    var obj = null;
    var selectedServer = null;
    function initForm(res) {
        var jsonString = JSON.stringify(res);
        obj = JSON.parse(jsonString);
        obj.attrbuites && (attrObj = obj.attrbuites);
    }
    layui.use(["element", "form", "laydate", "okLayer", "okUtils", 'constantUrl', 'tree', 'layer'], function() {
        $ = layui.jquery;
        var form = layui.form;
        var laydate = layui.laydate;
        var okLayer = layui.okLayer;
        var okUtils = layui.okUtils;
        var tree = layui.tree;
        var constantUrl = layui.constantUrl;
        var layer = layui.layer;
        okUtils.ajax({ "url": constantUrl.stAuth.selectDicByParentKey, "param": { keyStr: 'mapType' } }).done(function(data1) {
            if (data1.data == null) {
                layer.alert("警告 " + data1.msg)
            }
            var d = data1.data.mapType;
            $("#select").append(' <option value="-1"></option>');
            for (var i = 0; i < d.length; i++) {
                $("#select").append(' <option value="' + d[i].key + '">' + d[i].value + '</option>');
                form.render("select");
            }
            if (obj != null) {
                form.val("filter", obj);
                $('#select').val(obj.tkey);
                 form.render('select');
                $('#attr').hide();
                $('#attr1').show();
                $('#attr1').click(function() {
                    okLayer.open("编辑属性信息", "attrAdd.html", "90%", "90%", function(layero) {
                        var iframeWin = window[layero.find("iframe")[0]["name"]];
                       iframeWin.initForm(attrObj || obj.attrbuites);
                    }, function() {

                    });
                    return false;
                });
            } else {
                $('#attr1').hide();
                $('#attr').show();
                $('#attr').click(function() {
                    okLayer.open("添加属性信息", "attrAdd.html", "90%", "90%", function(layero) {
                        var iframeWin = window[layero.find("iframe")[0]["name"]];
                        iframeWin.initForm(attrObj);
                    }, function() {

                    });
                    return false;
                });
            }
        }).fail(function(error) {
            console.log(error)
        });


        form.on('select(type)', function(obj) {
            var v = obj.value;
            if (v == 'customServer') {
                $('#serverInput').hide();
                $('#serverSelect').show();
                var param = { table: 'st_layers' };
                okUtils.ajax({ "url": constantUrl.stBase.easySelect, "param": param }).done(function(data1) {
                    if (data1.data == null) {
                        layer.alert("警告 " + data1.msg)
                    }
                    var d = data1.data;
                    $("#ssver").append(' <option value="-1">请选择</option>');
                    for (var i = 0; i < d.length; i++) {
                        $("#ssver").append(' <option value="' + d[i].id + '" dataName = "'+d[i].name+'">' + d[i].name + '</option>');
                       // form.render("ssver");
                    }
                    form.render('select',"filter");
                }).fail(function(error) {
                    console.log(error)
                });
            } else {
                $('#serverInput').show();
                $('#serverSelect').hide();
            }
        })
        form.on('select(serverNameSelect)', function(obj) {
            selectedServer = obj.elem[obj.elem.selectedIndex].text;
         });

        $('#mapImgButton').off('click').on('click',function () {
            layui.okLayer.open("图片选择", "../markIcon/markIcon.html", "90%", "100%",function (dom,index) {
                var iframeWin = window[dom.find("iframe")[0]["name"]];
                iframeWin.initData(true,'服务缩略图');
            },function () {
                var picPath = sessionStorage.getItem("callback");
                var picName = sessionStorage.getItem("callbackName");
                if(!picPath || picPath === ''){
                    return;
                }
                $("input[name='img']").val(picPath);
                $('#mapConfigImgName').html(picName);
                sessionStorage.removeItem("callback");
                sessionStorage.removeItem("callbackName");
            });
            return false;
        });

        form.on("submit(add)", function(data) {
            var param = {};
            if(selectedServer == null){
                 param.serverName = data.field.serverName;
                 if(data.field.serverName == null || data.field.serverName == ""){
                    layer.msg("请输入服务名", { icon: 5 }); //提示
                    return false;
                 }
             }else{
                 param.serverName = selectedServer;
                 param.cusId = data.field.serverNameSelect;
             }

            param.url = data.field.url;
            param.description = data.field.description;
            var stype = data.field.type;
            if (stype == "-1") {
                layer.msg("请选择服务类型", { icon: 5 }); //提示
                return false;
            }
            param.type = stype;
            var v = data.field.visiable;
            if (v == "-1") {
                layer.msg("请选择是否可见", { icon: 5 }); //提示
                return false;
            }
            param.visiable = v;
            param.attrbuites = attrObj;
            param.ststate = 1;
            if(data.field.img){
                param.img = data.field.img;
            }
            var url = constantUrl.stMap.addMapConfig;
            if (obj != null) {
                url = constantUrl.stMap.editMapConfig;
                param.ID = obj.ID;
            }
            okUtils.ajax({ "url": url, "param": param, type: 'POST' }).done(function(response) {
                okLayer.msg.greenTick("添加成功", function() {
                    parent.parentFlag = 1;
                    selectedServer = null;
                    parent.layer.close(parent.layer.getFrameIndex(window.name));
                });
            }).fail(function(error) {
                console.log(error)
            });
            return false;
        });
    });
    </script>
</body>

</html>
