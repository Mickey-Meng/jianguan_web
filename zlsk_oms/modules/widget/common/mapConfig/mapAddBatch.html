<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>批量添加地图服务</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <style>
        .labelItem{
            /*width: 20%;*/
        }
        .inputItem{
            height: 38px;width: 60%;display: inline
        }
        .divItem{
            width: 28%;height: 50px;display: inline-block
        }
    </style>
</head>
<body>
<div class="layui-body commonOutCss" style="left: 0">
<!--    <div style="height: 50px;width: 100%;text-align: center">
        <div class="divItem">
            <label  class="labelItem">三维发布地址</label>
            <input type="text"  id="3dInput" name="serverName" placeholder="例:http://192.168.2.xx:8010/data_cesium/gx" autocomplete="off" class="layui-input inputItem" >
            <button class="layui-btn labelItem" id="3dBtn" >确定</button>
        </div>
        <div class="divItem">
            <label  class="labelItem">二维服务地址</label>
            <input type="text"  id="2dInput" name="serverName" placeholder="例:http://192.168.2.xx:8010/geoserver/gwc/service/wmts" autocomplete="off" class="layui-input inputItem" >
            <button class="layui-btn labelItem" id="2dBtn" >确定</button>
        </div>
        <div class="divItem">
            <select name="xm" id="xm" lay-filter="xmFilter"></select>
        </div>
        <div style="height: 50px;width: 10%;display: inline-block" >
            <button class="layui-btn layui-btn-normal" id="save" >保存</button>
        </div>
    </div>-->
    <div class="toolBarContainer">
        <form class="layui-form layui-col-md12" id="search-form" style="display: flex;margin-left: 10px;margin-top: 10px">
            <div class="layui-input-inline" style="flex: 1">
                <label  class="labelItem">三维发布地址</label>
                <input type="text"  id="3dInput" name="serverName" placeholder="例:http://192.168.2.xx:8010/data_cesium/gx" autocomplete="off" class="layui-input inputItem" >
                <button class="layui-btn labelItem" id="3dBtn" >确定</button>
            </div>
            <div class="layui-input-inline" style="flex: 1">
                <label  class="labelItem">二维服务地址</label>
                <input type="text"  id="2dInput" name="serverName" placeholder="例:http://192.168.2.xx:8010/geoserver/gwc/service/wmts" autocomplete="off" class="layui-input inputItem" >
                <button class="layui-btn labelItem" id="2dBtn" >确定</button>
            </div>
            <div class="layui-input-inline" style="flex: 0.5">
                <select name="xm1" id="xm1" lay-filter="xmFilter"></select>
            </div>
            <div style="height: 50px;width: 10%;display: inline-block;flex: 0.5;margin-left: 10px"  >
                <button class="layui-btn layui-btn-normal" id="save" >保存</button>
            </div>
        </form>
    </div>
    <div style="">
        <table class="layui-hide" id="maplist" lay-filter="maplist" style="width: 100%;"></table>
    </div>
</div>
<script>
    var $;
    var form;
    var constantUrl;

    var key ;
    var okUtils ;
    var okLayer ;
    var tableData;
    var afterRequestCount;
    var beforeRequestCount;
    var layerArray = [];
    var selectArray = {};
    var table;
    var cacheTool;
    let pointAttrZlsk = ['特征','附属物','井','井盖'];
    let pointAttrDataZlsk = ['Feature','Appendant','Well','WellCover'];

    let pointAttrAnt = ['附属物','特征','井','井盖'];
    let pointAttrDataAnt = ['fushuwu','tezheng','jing_Geometry_[1-9]','jing_Geometry_0'];
    layui.use(['form', 'okUtils', 'okLayer', "okLayer", 'constantUrl', 'zTable', 'table', 'xmSelect'], function () {
        $ = layui.jquery;
        form = layui.form;
        table = layui.table;
        okLayer = layui.okLayer;
        okUtils = layui.okUtils;
        xmSelect = layui.xmSelect;
        constantUrl = layui.constantUrl;

        okUtils.adapterSelect("#xm1", "", "name", "value", [{'name': '智联时空工具', 'value': '智联时空工具'},{'name': '蚂蚁工具', 'value': '蚂蚁工具'}],'','蚂蚁工具');

        okUtils.ajax({
            'url':constantUrl.stMap.getMapPsTc,
        }).done(function (data1) {
            tableData = data1.data.data;
            renderTable(tableData);
            generalLayerSelect(function () {
                getArraySelected()
            });
        });

        form.on('select(xmFilter)',function (data) {
            if (data.value == '智联时空工具'){
                cacheTool = 1;
            }else if (data.value == '蚂蚁工具'){
                cacheTool = 2;
            }
        });

        function renderTable(tableData){
            table.render({
                elem: '#maplist'
                , page: false //是否显示分页
                , limit: tableData ? tableData.length : 0
                , data : tableData
                , height: 'full-90'
                , size: 'lg'
                , defaultToolbar:[]
                , cols: [[ //标题栏
                    {type:'checkbox'}
                    , {field: 'name', title: '名称'}
                    , {field: '3dService', title: '三维服务地址'}
                    , {field: '2dServiceUrl', title: '二维服务地址'}
                    , {field: '2dService', title: '二维服务图层',
                        align: 'center',
                        templet: function (d) {
                            // 模板的实现方式也是多种多样，这里简单返回固定的
                            return "<div id=\"" + d.key + "\"></div>";
                        }}
                ]]
                ,done: function(res, curr, count){
                    $(".laytable-cell-1-0-4").css('overflow', 'visible');//修复 单元格内下拉框下拉项无法显示 若修改行数需修改  laytable-cell-1-0-4
                    $(".layui-table-main").css('overflow-x', 'hidden');//修复横向宽度导致出现横向滚动条
                    if (tableData){
                        getArraySelected()
                    }
                }
            });
            table.resize()
        }

        layui.xmSelect.render({
            el: '#xm1',
            tips:'请选择发布工具',
            name: 'name',
            data: [{'name': '智联时空工具', 'value': '智联时空工具'},{'name': '蚂蚁工具', 'value': '蚂蚁工具'}],
            filterable: false,
            repeat: false,
            radio: false,
            clickClose: true,
            theme: {
                color: '#333333',
            },
            model: {
                label: {
                    type: 'block',
                    block: {
                        showCount: 0,
                        showIcon: false,//是否显示删除图标
                    }
                }
            },
            on: function (data) {

            }
        })

        $('#3dBtn').click(function () {
            let dataUrl = $('#3dInput').val();
            if (dataUrl === ''){
                layer.alert('警告 请先输入地址');
                return false;
            }
            if (dataUrl[dataUrl.length - 1] !== '/'){
                dataUrl += '/';
            }
            $.each(tableData,function (index,value) {
                value['3dService'] = dataUrl + value.key  + '/tileset.json' ;
            });
            reload(tableData);
            layer.alert('地址添加成功');
            return false;
        });

        $('#2dBtn').click(function () {
            let dataUrl = $('#2dInput').val();
            if (dataUrl === ''){
                layer.alert('警告 请先输入地址');
                return false;
            }
            $.each(tableData,function (index,value) {
                value['2dService'] = dataUrl ;
                value['2dServiceUrl'] = dataUrl  ;
            });
            reload(tableData);
            layer.alert('地址添加成功');
            return false;
        });

        $('#save').click(function () {

            beforeRequestCount = 0;
            afterRequestCount = 0;
            var checkStatus = table.checkStatus('maplist');
            if (!checkStatus.data || checkStatus.data.length === 0){
                layer.alert('警告 未选择数据');
                return false;
            }
            let pointAttr ;
            let pointAttrData;
            if (cacheTool == 1){
                pointAttr = pointAttrZlsk;
                pointAttrData = pointAttrDataZlsk;
            }else if (cacheTool == 2){
                pointAttr = pointAttrAnt;
                pointAttrData = pointAttrDataAnt;
            }else {
                layer.alert('警告 未选择工具类型');
                return false;
            }
            $.each(checkStatus.data,function (index,value) {
                let param = {};

                if (value['3dService']){
                    param.url = value['3dService'];
                    param.type = 'C3DTILES';
                    param.ststate = 1;
                    if (value.type === 'point'){
                        for (let idx = 0; idx < pointAttr.length; idx++) {
                            param.serverName = value.name + "_" + pointAttr[idx];
                            param.attrbuites = JSON.stringify({stPipeSt:3,style:JSON.stringify({show: "${name} =~ regExp(\"" + pointAttrData[idx] + "\")"}),stGroup:value.key});
                            uploadService(param);
                        }
                    }else {
                        param.serverName = value.name;
                        param.attrbuites = JSON.stringify({stPipeSt:3,stGroup:value.key});
                        uploadService(param);
                    }
                }
                if (value['2dService']){
                    let attr = {};
                    let select = selectArray[value.key];
                    if (select && select.getValue()){
                        attr = select.getValue()[0];
                        delete attr.name;
                        delete attr.value;
                        attr['stPipeSt'] = 2;
                        attr['stGroup'] = value.key;
                        param.url = value['2dService'];
                        param.type = 'WMTS';
                        param.ststate = 1;
                        param.serverName = '二维' + value.name;
                        param.attrbuites = JSON.stringify(attr);
                        uploadService(param);
                    }
                }
            })
        })
    });

    function uploadService(param) {
        beforeRequestCount++;
        okUtils.ajax({ "url": constantUrl.stMap.addMapConfig, "param": param, type: 'POST' }).done(function(response) {
            afterRequestCount++;
            if (afterRequestCount === beforeRequestCount){
                okLayer.msg.greenTick("添加成功", function() {
                    parent.parentFlag = 1;
                    selectedServer = null;
                    parent.layer.close(parent.layer.getFrameIndex(window.name));
                })
            }
        }).fail(function(error) {
            console.log(error)
        });
    }

    function reload(data) {
        table.reload('maplist',{
            data:data
        });
        getArraySelected()
    }

    function createCORS(method, url){
        var xhr = new XMLHttpRequest();
        if('withCredentials' in xhr){
            xhr.open(method, url, true);
        }else if(typeof XDomainRequest != 'undefined'){
            var xhr = new XDomainRequest();
            xhr.open(method, url);
        }else{
            xhr = null;
        }
        return xhr;
    }

    var generalLayerSelect = function (callback) {
        var request = createCORS('get',constantUrl.other.geoserverWmts);
        if(request) {
            request.onload = function (data) {
                let xmlDom = layui.okUtils.loadXMLString(data.target.response);
                let layers;
                try {
                    layers = xmlDom.getElementsByTagName("Capabilities")[0].getElementsByTagName("Contents")[0].getElementsByTagName('Layer');
                }catch (e) {
                    return
                }
                let cache;
                // maximumLevel 存在多个优先取4326
                $.each(layers,function (index,value) {
                    cache = {};
                    cache.tilingScheme = 'WGS84';
                    cache.stPipeSt = '2';
                    if (value){
                        let format = value.getElementsByTagName('Format');
                        if (format){
                            for (let index = 0; index < format.length; index++) {
                                let currentFormat = format[index].innerHTML;
                                cache.format = currentFormat;
                                if (currentFormat.indexOf('image/png') !== -1){
                                    break;
                                }
                            }
                        }

                        let identifier = value.getElementsByTagName('ows:Identifier');
                        if (identifier){
                            cache.layer = identifier[0].innerHTML;
                            cache.name = identifier[0].innerHTML;
                            cache.value = identifier[0].innerHTML;
                        }
                        let boundingBox = value.getElementsByTagName('ows:WGS84BoundingBox');
                        if (boundingBox){
                            let lowerCorner = boundingBox[0].getElementsByTagName('ows:LowerCorner')[0].innerHTML;
                            let upperCorner = boundingBox[0].getElementsByTagName('ows:UpperCorner')[0].innerHTML;
                            lowerCorner = lowerCorner.replace(' ',',');
                            upperCorner = lowerCorner.replace(' ',',');
                            cache.rectangle = lowerCorner + ',' + upperCorner;
                        }

                        let setLink = value.getElementsByTagName('TileMatrixSetLink');
                        if (setLink){
                            for (let index = 0; index < setLink.length; index++) {
                                cache.TileMatrixID = setLink[index].getElementsByTagName('TileMatrixSet')[0].innerHTML;

                                let setLimits = setLink[index].getElementsByTagName('TileMatrixSetLimits');
                                if (setLimits && setLimits[0] && setLimits[0].getElementsByTagName('TileMatrixLimits')){//默认TileMatrixSetLimits只有一个
                                    let limits = setLimits[0].getElementsByTagName('TileMatrixLimits');
                                    let TileMatrixLabels = '';
                                    for (let idx = 0; idx < limits.length; idx++) {
                                        let tileMatrix = limits[idx].getElementsByTagName('TileMatrix')[0].innerHTML;
                                        TileMatrixLabels += tileMatrix + ',';
                                        if (idx === limits.length - 1){
                                            cache.maximumLevel = tileMatrix.replace(cache.TileMatrixID + ':','');
                                        }
                                    }
                                    cache.TileMatrixLabels = TileMatrixLabels.substring(0,TileMatrixLabels.length - 1);
                                }
                                if (cache.TileMatrixID.indexOf('4326')){
                                    break
                                }
                            }
                        }
                    }
                    layerArray.push(cache);
                });
                callback();
            };
            request.send();
        }
    };

    var getArraySelected = function () {
        if (tableData){
            $.each(tableData,function (index,value) {
                if ($('#' + value.key).length !== 0){
                    let select = generateSelect(value);
                    let arrayData = {};
                    for (let index = 0; index < layerArray.length; index++) {
                        if (layerArray[index].layer.indexOf(value.key) !== -1){
                            arrayData = layerArray[index];
                            break;
                        }
                    }
                    select.setValue([arrayData]);
                    selectArray[value.key] = select;
                }
            })
        }
    };

    var generateSelect = function (data) {
        return xmSelect.render({
            el: '#' + data.key,
            tips:'请选择layer',
            name: 'name',
            filterable: true,
            repeat: true,
            radio: true,
            clickClose: true,
            data: layerArray,
            theme: {
                color: '#333333',
            },
            model: {
                label: {
                    type: 'block',
                    block: {
                        showCount: 0,
                        showIcon: false,//是否显示删除图标
                    }
                }
            }
        })
    }
</script>
</body>
</html>
