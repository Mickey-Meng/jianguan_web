<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>地图配置</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <style>
        /** 项目列表样式 */
        .layui-col-md3{
            padding: 5px 15px;
        }
        .project-list-item {
            background-color: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            transition: all .2s;
            box-shadow: 0 0 3px rgba(150,150,150,.5);
            -webkit-box-shadow: 0 0 3px rgba(150,150,150,.5);
        }

        .project-list-item:hover {
            transform: scale(1.03) translateZ(0);
            z-index: 100;
            -webkit-transform: scale(1.03) translateZ(0);
            transition-duration: .4s;
            box-shadow: 1px 1px 6px rgba(150,150,150,.6);
            -webkit-box-shadow: 1px 1px 6px rgba(150,150,150,.6);
        }

        .project-list-item .project-list-item-cover {
            width: 100%;
            height: 200px;
            display: block;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            cursor: pointer;
        }

        .project-list-item-body {
            padding: 10px;
        }

        .project-list-item .project-list-item-body > h2 {
            font-size: 18px;
            color: #333;
            /*margin-bottom: 5px;*/
        }

        .project-list-item .project-list-item-text {
            height: 44px;
            overflow: hidden;
            /*margin-bottom: 5px;*/
            word-break:break-all;
        }

        .project-list-item .title{
            height: 28px;
            line-height: 28px;
            padding-right: 5px;
        }

        .project-list-item .operate{
            height: 28px;
            line-height: 28px;
            margin-top: 5px;
        }

        .project-list-item .operate button{
            height: 28px;
            line-height: 28px;
            margin: 0;
            width: 49%;
        }

        .layui-laypage{
            margin: 5px 0;
        }

    </style>
</head>
<body>
    <div class="layui-body commonOutCss" style="left: 0">
        <div class="toolBarContainer">
            <form class="layui-form layui-col-md12" style="padding: 5px 15px 0 15px">
                <div class="layui-input-inline ok-search">
                    <input class="layui-input" placeholder="按服务名称搜索" autocomplete="off" name="serverName">
                </div>
                <div class="layui-input-inline ok-search">
                    <div id="mapType" style="width: 240px"></div>
                </div>
                <button class="layui-btn introSearch" lay-submit="" lay-filter="search" title="条件查询">
                    <i class="layui-icon">&#xe615;</i>
                </button>
                <button class="layui-btn" id="add" title="注册地图服务">
                    注册地图服务
                    <i class="layui-icon">&#58964;</i>
                </button>
                <button class="layui-btn" id="addBatch" title="批量注册地图服务">
                    批量注册地图服务
                    <i class="layui-icon">&#58964;</i>
                </button>
            </form>
        </div>
        <div class="mapGridContainer">
            <div id="mapGrid"></div>
            <div id="layerPage"></div>
        </div>
    </div>
</body>
<!-- 项目模板 -->
<script type="text/html" id="mapGridTemp">
    <div class="layui-col-md3">
        <div class="project-list-item">
            <img lay-event="preview" class="project-list-item-cover" onerror="this.src='./404.png';this.onerror=null" style="width: 100%;height: 220px" src="{{(layui.constantUrl.baseTempUrl + d.img)}}"/>
            <div class="project-list-item-body" style="padding: 10px">
                <div class="title">
                    <span style="float: left;font-size: 18px">{{d.serverName}}</span>
                    <span style="float: right">{{d.type}}</span>
                </div>
                <div class="project-list-item-text layui-text">{{d.url}}</div>
                <div class="operate">
                    <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" lay-event="edit">
                        编辑
                    </button>
                    <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" lay-event="delete">
                        删除
                    </button>
                </div>
            </div>
        </div>
    </div>
</script>
<script>
    let jquery;
    let mapGrid;
    let parentFlag = 0;

    layui.use(['form','okUtils', "okLayer", 'constantUrl', 'zDataGrid','xmSelect'],function () {
        jquery = layui.jquery;
        initSelect();
        initMapGrid();
        bindEvent();
    });

    const initSelect = () => {
        layui.okUtils.ajax({ "url": layui.constantUrl.stAuth.selectDicByParentKey, "param": { keyStr: 'mapType' } }).done(function(data) {
            layui.okUtils.renderEasySelect(jquery,{
                el: '#mapType',
                name: 'type',
                data: data.data.mapType,
                tips:'按服务类型搜索'
            },true);
        });
    };

    const refreshGrid = () => {
        jquery(".layui-laypage-btn")[0].click();
    };

    const initMapGrid = () => {
        mapGrid = layui.zDataGrid.render({
            elem: '#mapGrid',
            toolbar:'#toolbar',
            templet: '#mapGridTemp',
            data:layui.constantUrl.stMap.queryMapConfigs,
            page: {limit: 8, limits: [8, 16, 24, 32, 40],layout:['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']},
            parseData: function (res) {
                var result =  res.data.getMe;
                return {
                    "code": res.meow,
                    "msg": res.data.msg,
                    "count": res.data.total,
                    "data": result
                };
            },
            request:{
                limitName: "pageSize",
                pageName: "pageNumber"
            },
            onItemClick: function (obj) {

            },
            onToolBarClick:function(obj){
                let event = obj.event;
                let data = obj.data;
                if(event === 'edit'){
                    btnEdit(data);
                }
                else if(event === 'delete'){
                    btnDel(data);
                }
                else if(event === 'preview'){
                    btnPreview(data);
                }
            },
            where:{}
        });
    };

    const btnPreview = (data) => {
        let rootUrl = sessionStorage.getItem("homeFolder");
        let url = `${rootUrl}/modules/widget/common/mapConfig/mapPreview.html?id=${data.ID}`;
        let config = {
            type:data.type,
            url:data.url
        };
        data.attrbuites && (config.attribute = parseAttributes(data.attrbuites));
        layui.data('mapPreview',{key:data.ID,value:config});
        window.parent.addTab({
            id:'mapPreview' + data.ID,
            url:url,
            title:data.serverName || '服务预览',
            icon:'&#58899;'
        });
    };

    const parseAttributes = (data) => {
        data = JSON.parse(data);
        for (let key in data){
            let value = data[key];
            if(value && value.indexOf && value.indexOf('{') !== -1 && value.indexOf('}') !== -1){
                data[key] = JSON.parse(layui.okUtils.toJSONStr(value));
            }
        }
        return data;
    };

    const btnEdit = (data) => {
        layui.okLayer.open("编辑信息", "mapAdd.html", "90%", "90%", function (layero) {
            var iframeWin = window[layero.find("iframe")[0]["name"]];
            iframeWin.initForm(data);
        }, function () {
            refreshGrid();
        })
    };

    const btnDel = (data) =>{
        layui.okLayer.confirm("确定要删除吗？", function (index) {
            layui.okUtils.ajax({
                "url": layui.constantUrl.stMap.delMapConfig,
                "param": {"id": data.ID, "ststate":0}
            }).done(function (response) {
                layui.layer.msg('删除成功', {icon: 1, time: 1000}, function () {
                    refreshGrid();
                });
            }).fail(function (error) {
                console.log(error)
            });
        });
    };

    const bindEvent = () => {
        jquery('#add').click(function () {
            layui.okLayer.open("注册地图服务", "mapAdd.html", "90%", "90%", function (layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(null);
            }, function () {
                refreshGrid();
            });
            return false;
        });
        jquery('#addBatch').click(function () {
            layui.okLayer.open("批量添加地图服务", "mapAddBatch.html", "90%", "90%", function (layero) {
            }, function () {
                refreshGrid();
            });
            return false;
        });
        layui.form.on("submit(search)", function (data) {
            mapGrid.reload({
                where: data.field,
                page: {curr: 1}
            });
            return false;
        });
    }

</script>
</html>
