<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>地图方案</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <style>
        body {
        overflow: hidden;
    }

    #planTree {
        height: 100%;
        width: 20%;
        float: left;
        overflow: auto;
    }

    #mapConfigRecord {
        width: 75%;
        right: 10px;
        float: left;
        position: absolute;
    }

    .treeNodeCss {
        background: #D3D3D3;
    }
    </style>
</head>

<body>
    <div class="layui-body commonOutCss" style="left: 0;overflow: hidden;" id="content">
        <div id="planTree" style="min-height:400px;"></div>
        <div id="mapConfigRecord">
            <div style="height: 35px;text-align: left;">
                <button class="layui-btn" lay-submit id="reloadTable">加载地图基础数据</button>
                <button class="layui-btn" lay-submit id="intro">教程引导</button>
            </div>
            <div style="margin-top: 10px;">
                <table class="layui-hide" id="mapConfigRecords" lay-filter="mapConfigRecords"></table>
            </div>
        </div>
    </div>
    <script>
        var $;
        var planData = [{ id: -1, title: '方案列表', spread: true, lev: -1 }];
        var selectData = { id: -1, title: '方案列表', spread: true, lev: -1 };
        var result = null;
        var flag = 0;
        var zdyId = [];
        var intro;
        var parentFlag = 0;
        layui.use(['tree', 'form', 'table', 'okUtils', "okLayer", 'constantUrl', 'zTable', 'layer','introJs'], function() {
            $ = layui.jquery;
            var tree = layui.tree;
            var okUtils = layui.okUtils;
            var constantUrl = layui.constantUrl;
            var okLayer = layui.okLayer;
            var form = layui.form;
            var table = layui.table;
            var layer = layui.layer;
            var h = $('#content').height();
            var initTree = function () {
                okUtils.ajax({"url": constantUrl.stMap.queryMapPlans}).done(function (data1) {
                    if (data1.data == null) {
                        layer.alert("警告 " + data1.msg)
                    } else {
                        var d = data1.data.getMe;
                        var cd = [];
                        result = d;
                        for (var i = 0; i < d.length; i++) {
                            var childreList = [];
                            var lv = d[i].lev;
                            var pid = d[i].parentId;
                            if (lv == 0 && pid == 0) {
                             var c =   getChildren(d, 'parentId', d[i].ID);
                                cd.push({
                                    id: d[i].ID,
                                    title: d[i].pname,
                                    spread: true,
                                    children: c,
                                    parentId: pid,
                                    lev: lv,
                                    sttype: d[i].sttype,
                                    storder:d[i].storder
                                });
                            }
                        }
                        planData[0]['children'] = cd;
                        tree.render({
                            elem: '#planTree',
                            data: planData,
                            id: 'treeId',
                            spread: true,
                            onlyIconControl: true,
                            customOperate: true,
                            limitNodeUpdateLevel: 1,
                            limitNodeDelLevel: 1,
                            edit: ['add', 'update', 'del'],
                            operate: function (obj) {
                                var type = obj.type; //得到操作类型：add、edit、del
                                var data = obj.data; //得到当前节点的数据
                                cacheData = data;
                                if (type == 'add') { //增加节点
                                    // if (data.lev < 1) {
                                    //     addPlan(obj.data);
                                    // } else {
                                    //     layer.msg("不支持当前操作");
                                    //     return false;
                                    // }
                                    addPlan(obj.data);

                                } else if (type == 'del') { //删除节点
                                    deletePlan(data)
                                } else if (type == 'update') {
                                    editPlan(obj.data);
                                }
                                return false;
                            },
                            click: function (obj) {
                                selectData = obj.data;
                                $('.layui-tree-txt').removeClass('treeNodeCss');
                                $(obj.elem.find("span")[1]).addClass('treeNodeCss');
                                initTable(obj.data)
                            }
                        });
                        initIntro();
                    }
                }).fail(function (error) {
                    console.log(error)
                });
            }
            initTree();


            var getTreeData = function(list, key, value){
                if (!list) {
                    return childreList;
                }

            }
            var getChildren = function (list, key, value) {
                var d = [];
                if (!list) {
                    return d;
                }
                for (var i = 0; i < list.length; i++) {
                    if (list[i][key] == value) {
                        d.push({
                            id: list[i].ID,
                            title: list[i].pname,
                            spread: true,
                            parentId: list[i].parentId,
                            lev: list[i].lev,
                            sttype: list[i].sttype,
                            storder:list[i].storder,
                            children: getChildren(list, 'parentId', list[i].ID)
                        });

                    }
                }
                return d;
            }
            var initTable = function (obj) {
                var url = "";
                var param = {};
                // if (obj.lev == 0) {
                //     url = constantUrl.stMap.selectRecordByPlanParent;
                //     var c = obj.children;
                //     var id = "";
                //     for (var i = 0; i < c.length; i++) {
                //         id += c[i].id + ",";
                //     }
                //     id = id.substring(0, id.length - 1);
                //     param = { mpids: id }
                // } else if (obj.lev == 1) {
                //     url = constantUrl.stMap.selectRecordByPlan;
                //     param = { mpid: obj.id }
                // } else {
                //     url = constantUrl.stMap.selectRecordByPlan;
                // }
                url = constantUrl.stMap.selectRecordByPlan;
                param = {mpid: obj.id}
                myTable.reload({
                    url: url,
                    where: param
                });
            }

            var zTable = layui.zTable({
                elem: '#mapConfigRecords',
                page: false, //是否显示分页
                url: constantUrl.stMap.selectRecordByPlan,
                where: {mpid: selectData.id},
                parseData: function (res) { //res 即为原始返回的数据
                    if (!res.data) {
                        return {
                            "code": res.meow, //解析接口状态
                            "msg": "无数据", //解析提示文本
                            "count": 0, //解析数据长度
                            "data": [] //解析数据列表
                        };
                    }
                    // if (selectData.sttype == 'customLayer') {
                    //     flag = 1;
                    // }else{
                    //     flag = 0;
                    // }
                    flag = 0;
                    if (flag == 1) {
                        var d = res.data.getMe;
                        var rd = [];
                        for (var i = 0; i < d.length; i++) {

                            rd.push({
                                ID: d[i].layresId,
                                serverName: d[i].name,
                                createtime: d[i].time,
                                visiable: d[i].visible,
                                type: '自定义服务'
                            })
                            if ($.inArray(d[i].layresId, zdyId) > -1) {
                                continue;
                            }
                            zdyId.push(d[i].layresId);
                        }
                        return {
                            "code": res.meow, //解析接口状态
                            "msg": res.data.msg, //解析提示文本
                            "data": rd //解析数据列表
                        };
                    } else {
                        return {
                            "code": res.meow, //解析接口状态
                            "msg": res.data.msg, //解析提示文本
                            "data": res.data.getMe //解析数据列表
                        };
                    }

                },
                height: 'full-85',
                cols: [
                    [ //标题栏
                        // { type: 'checkbox', width: 50 },
                        {field: 'serverName', title: '名称'}, {field: 'url', title: '地图服务地址'}, {
                        field: 'type',
                        title: '服务类型'
                    }, {field: 'visiable', title: '是否可见', templet: '#statusTpl'}, {
                        field: 'createtime',
                        title: '添加时间'
                    }, {title: "操作", width: 150, align: "center", templet: "#operationTpl"}
                    ]
                ]
            });

            var myTable = zTable.getTable();

            function deletePlan(data) {
                var param = {};
                var lv = data.lev;
                if (lv == -1) {
                    param = {"lev": -1}
                } else {
                    param = {"id": data.id, parentId: data.parentId};
                }
                okLayer.confirm("确定要删除吗？", function (index) {

                    okUtils.ajax({
                        "url": constantUrl.stMap.delMapPlans,
                        "param": param
                    }).done(function (response) {
                        okUtils.table.successMsg("删除成功");
                        initTree();
                        myTable.reload();
                    }).fail(function (error) {
                        console.log(error)
                    });
                });
            }

            function editPlan(data) {
                var title = "编辑方案";
                if (data.lev == 1) {
                    title = '编辑分组';
                }
                okLayer.open(title, "planAdd.html", "50%", "50%", function (layero) {
                    var iframeWin = window[layero.find("iframe")[0]["name"]];
                    iframeWin.initForm(data, 1, 0, 0, title, result);
                }, function () {
                    initTree();
                });
            }

            function addPlan(data) {
                var title = "添加方案";
                if (data.id > 0) {
                    title = '添加分组';
                }
                okLayer.open(title, "planAdd.html", "30%", "35%", function (layero) {
                    var iframeWin = window[layero.find("iframe")[0]["name"]];
                    if (data.id == -1) {
                        iframeWin.initForm(data, 0, 0, 0, title, result);
                    } else {
                        iframeWin.initForm(data, 0, data.id, data.lev + 1, title, result);
                    }

                }, function () {
                    initTree();
                });
            }

            $('#reloadTable').click(function () {
                if (selectData == null) {
                    layer.msg('请选择一个方案');
                    return false;
                }
                if (selectData.lev < 1) {
                    layer.msg('请选择子节点');
                    return false;
                }
                okLayer.open("地图基础服务信息", "addConfigPlan.html", "90%", "90%", function (layero) {
                    var iframeWin = window[layero.find("iframe")[0]["name"]];
                    iframeWin.initForm(selectData, zdyId);

                }, function () {
                    initTable(selectData);
                });
                // if (selectData.sttype == 'customLayer') {
                //    okLayer.open("地图基础服务信息", "addZdyConfigPlan.html", "90%", "90%", function(layero) {
                //     var iframeWin = window[layero.find("iframe")[0]["name"]];
                //     iframeWin.initForm(selectData,zdyId);

                // }, function() {
                //     initTable(selectData);
                // });
                // }else{
                //      okLayer.open("地图基础服务信息", "addConfigPlan.html", "90%", "90%", function(layero) {
                //     var iframeWin = window[layero.find("iframe")[0]["name"]];
                //     iframeWin.initForm(selectData,zdyId);

                // }, function() {
                //     initTable(selectData);
                // });
                // }

            })
            $('#add').click(function () {
                var checkStatus = table.checkStatus('mapConfigRecords');
                if (selectData == null) {
                    layer.msg('请选择一个方案');
                    return false;
                }
                var d = checkStatus.data;
                if (d.length == 0) {
                    layer.msg('请勾选地图服务基础信息');
                    return false;
                }
                var jsonobj = [];
                for (var i = 0; i < d.length; i++) {
                    jsonobj.push({
                        mpId: selectData.id,
                        mcrId: d[i].ID
                    })
                }
                var plans = JSON.stringify(jsonobj);
                var param = {};
                param.plans = plans;
                okUtils.ajax({
                    "url": constantUrl.stMap.insertMapRecordPlan,
                    "param": param,
                    type: 'POST'
                }).done(function (response) {
                    okLayer.msg.greenTick("添加成功", function () {
                        initTree();
                        selectData = null;
                        $('.layui-tree-txt').removeClass('treeNodeCss');
                        myTable.reload({
                            url: constantUrl.stMap.selectNoPlans,
                            where: param
                        });
                    });
                }).fail(function (error) {
                    console.log(error)
                });
            });
            zTable.getLayuiTable().on("tool(mapConfigRecords)", function (obj) {
                var data = obj.data;
                switch (obj.event) {
                    case "btnDel":
                        btnDel(data);
                        break;
                    case "btnEdit":
                    parentFlag = 0;
                    btnEdit(data);
                    break;
                }
            });

            function btnDel(data) {
                okLayer.confirm("确定要删除吗？", function (index) {
                    if (flag == 1) {
                        for (var i = 0; i < zdyId.length; i++) {
                            if (zdyId[i] == data.ID) {
                                zdyId.splice(i, 1);
                            }
                        }
                    }
                    okUtils.ajax({
                        "url": constantUrl.stMap.delMap_Record_Plan,
                        "param": {"mcrId": data.ID}
                    }).done(function (response) {
                        okUtils.table.successMsg("删除成功");

                        initTable(selectData)
                    }).fail(function (error) {
                        console.log(error)
                    });
                });
            }

            function btnEdit(data) {
            okLayer.open("编辑信息", "editVisiable.html", "50%", "30%", function (layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(data);
            }, function () {
                if (parentFlag === 1) {
                    myTable.reload()
                }
            })
        }

            function initIntro() {
                intro = layui.introJs();
                intro.setOptions({
                    steps: [
                        {
                            element: "#planTree",
                            intro: '<h5>方案组添加</h5><br>' +
                                '1.鼠标点击 "方案列表", 根据需求在方案树上新建需要的方案组<br>' +
                                '2.如图所示,添加 "农科院" 方案组<br><img src="./mapPlanClickPlan.png"><br><img src="./mapPlanGroup.png">',
                            tooltipPosition:'right'
                        },
                        {
                            element: "#planTree",
                            intro: '<h5>专题方案</h5><br>' +
                                '1.根据需求在方案组中添加具体专题方案<br>' +
                                '2.如图所示,添加 "三维模型" 方案<br><img src="./mapPlanClickPlan2.png"><br><img src="./mapPlanThe.png">',
                            tooltipPosition:'right'
                        },
                        {
                            element: "#reloadTable",
                            intro: '<h5>服务挂接</h5><br>' +
                                '1.点击专题方案,为该方案挂接相应地图服务<br>' +
                                '2.如图所示,挂接 "农科院倾斜模型" 服务到 "三维模型" 方案中<br><img src="./mapPlanClickPlan3.png">',
                            tooltipPosition:'bottom'
                        },
                        {
                            element: "#reloadTable",
                            intro: '<h5>服务选择</h5><br>' +
                                '1.点击 "加载地图基础数据" <br>' +
                                '2.如图所示,勾选 "农科院倾斜模型" 点击提交<br><img src="./mapPlanServiceSelect.png">',
                            tooltipPosition:'bottom'
                        }
                    ]
                });
                var hasShowIntro = layui.okUtils.getCookie('hasShowIntroMapPlan');
                if(!hasShowIntro){
                    intro.start();
                    layui.okUtils.setCookie('hasShowIntroMapPlan','hasShowIntroMapPlan');
                }
            }

            $('#intro').off('click').on('click',function () {
                intro.start();
                return false;
            });
        });

    </script>
    <script type="text/html" id="operationTpl">
        <div>
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnEdit">编辑信息</button>
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnDel">删除</button>
    </div>
</script>
</body>
<script type="text/html" id="statusTpl">
    {{#  if(d.visiable == 1){ }}
    <span class="layui-btn layui-btn-normal layui-btn-xs">可见</span>
    {{#  } else if(d.visiable == 0) { }}
    <span class="layui-btn layui-btn-warm layui-btn-xs">不可见</span>
    {{#  } }}
</script>

</html>
