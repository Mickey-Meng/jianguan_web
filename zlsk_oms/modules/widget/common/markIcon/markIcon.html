<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css"  media="all">
    <style>
        #assets + .layui-table-view .layui-table-body tbody > tr > td {
            padding: 0;
        }

        #assets + .layui-table-view .layui-table-body tbody > tr > td > .layui-table-cell {
            height: 60px;
            line-height: 60px;
        }

        .tdImg {
            width: 45px;
            height: 45px;
            max-width: none;
            cursor: zoom-in;
        }
    </style>
</head>
<body>

<div class="commonOutCss">
    <script type="text/html" id="toolbar">
        <form class="layui-form layui-col-md12" id="search-form">
            <div class="layui-input-inline ok-search">
                <input class="layui-input" placeholder="资源名称" autocomplete="off" name="name" >
            </div>
            <button class="layui-btn" lay-submit="" lay-filter="search" title="条件查询">
                <i class="layui-icon">&#58901;</i>
            </button>
            <button type="reset" class="layui-btn" id="btn_reset" title="重置刷新">
                <i class="layui-icon">&#58982;</i>
            </button>
            <button class="layui-btn" id="btn_add" title="添加图片">
                添加图片
                <i class="layui-icon" style="margin-left: 10px">&#58964;</i>
            </button>
            <button class="layui-btn" id="btn_add_model" title="添加模型">
                添加模型
                <i class="layui-icon" style="margin-left: 10px">&#58964;</i>
            </button>
        </form>

    </script>
    <table class="layui-table" id="assets" lay-filter="assetsTable"></table>
</div>

<script src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
<script>
    var initWhere = {table:'st_mark_icon'};
    var isMarkSelect = false;
    var selectType;
    var initData = function(data,type){
        isMarkSelect = data;
        selectType = type;
        if(isMarkSelect){
            initWhere.mapStr = JSON.stringify({type:type});
        }
    };

    layui.use(['jquery','zTable','constantUrl','okLayer','okUtils','form'],function () {
        var $ = layui.jquery;
        var zTable = layui.zTable({
            elem: '#assets',
            page:true,
            url:layui.constantUrl.stBase.easySelectWithPagination,
            where:initWhere,
            toolbar:'#toolbar',
            cols: [[
                {field: 'name', title: '资源名称'},
                {field: 'type', title: '资源类型'},
                {
                    align: 'center', templet: function (d) {
                        if(d.type.indexOf('图') !== -1){
                            var url = 'https://pic.qqtn.com/up/2018-9/15367146917869444.jpg';
                            if(d.path){
                                var pics = d.path.split(layui.constantUrl.commonField.FILE_SPLITTER);
                                if(pics.path !== 0){
                                    url = layui.constantUrl.baseTempUrl + pics[0];
                                }
                            }
                            return '<img src="' + url + '" class="tdImg" lay-event="pictureView"/>';
                        }else {
                            return '';
                        }
                    }, title: '资源预览', unresize: false
                },
                {field: 'time', title: '入库时间',templet: function(d){
                        var time = layui.okUtils.dateFormat(new Date(d.time),"yyyy-MM-dd hh:mm:ss");
                        return '<span>'+ time +'</span>'
                    }},
                {field: 'operate', title: '操作',align:'center',templet:function (d) {
                        let div = '';
                        if(isMarkSelect){
                            div += '<a class="layui-btn layui-btn-danger layui-btn" lay-event="select">选择</a>';
                        }else {
                            div += '<a class="layui-btn layui-btn-danger layui-btn" lay-event="del">删除</a>';
                        }
                        return div;
                    }}
            ]]
        });
        var myTable = zTable.getTable();
        zTable.getLayuiTable().on('tool(assetsTable)', function(obj){
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            if(layEvent === 'del'){
                layui.okUtils.showConfirmDialog({title:'确定要删除该资源嘛？',text:'删除后不可还原'},function (result) {
                    if(result.value === true){
                        layui.okUtils.ajax({
                            url:layui.constantUrl.stBase.easyDelete,
                            param:{
                                table:'st_mark_icon',
                                mapStr:JSON.stringify({id:data.id})
                            }
                        }).done(function (response) {
                            layui.okLayer.msg.greenTick(response.msg, function () {
                                $('#btn_reset').click();
                            });
                        });
                    }
                });
            } else if(layEvent === "pictureView") {
                var picStr = layui.constantUrl.baseTempUrl + obj.data.path;
                layui.okLayer.open("资源预览", "./photoViewer.html", "80%", "80%", function (dom) {
                    var iframeWin = window[dom.find("iframe")[0]["name"]];
                    iframeWin.initData([picStr]);
                });
            } else if(layEvent === "select"){
                var picStr = obj.data.path;
                sessionStorage.setItem("callback",picStr);
                sessionStorage.setItem("callbackName",obj.data.name);
                parent.layer.close(parent.layer.getFrameIndex(window.name));
            }
        });
        var userInfo = JSON.parse(sessionStorage.getItem("userInfo"));
        layui.form.on('submit(search)', function(data){
            myTable.refresh({
                where:{
                    table:'st_mark_icon',
                    mapStr:JSON.stringify(data.field),
                },
                curr: 1
            });
            return false;
        });
        $('#btn_add').off('click').on('click',function () {
            addResource(selectType);
            return false;
        });
        $('#btn_add_model').off('click').on('click',function () {
            addResource('模型','*.gltf');
            return false;
        });
        $('#btn_reset').click(function () {
            myTable.refresh({
                where:initWhere,
                curr: 1
            });
        });

        if(selectType.indexOf('图') !== -1){
            $('#btn_add').show();
            $('#btn_add_model').hide();
        }else if(selectType === '模型'){
            $('#btn_add').hide();
            $('#btn_add_model').show();
        }

        function addResource(type,fileType) {
            layui.okLayer.open("资源添加", "./fileUpload.html", "60%", "70%",function (dom,index) {
                var iframeWin = window[dom.find("iframe")[0]["name"]];
                iframeWin.initData({
                    userName:userInfo.NAME,
                    userId:userInfo.ID,
                    type:type,
                },fileType);
            },function () {
                $('#btn_reset').click();
            });
        }
    });
</script>
</body>
</html>
