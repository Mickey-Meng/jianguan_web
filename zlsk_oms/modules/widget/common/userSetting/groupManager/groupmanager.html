<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>部门组织配置</title>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <style>
        #departmentTree {
            height: 100%;
            width: 20%;
            float: left;
            overflow: auto;
        }

        #user {
            width: 78%;
            right: 10px;
            float: left;
            position: absolute;
        }
    </style>
</head>
<body>
<div class="layui-body commonOutCss" style="left: 0px">
    <div id="departmentTree" style="min-height:400px;"></div>
    <div id="user">
        <div class="layui-row layui-tab-card layui-tab" >
            <form class="layui-form " style="width: auto;margin: 10px;" lay-filter="form" id="form">
                <div class="layui-form-item">
                    <label class="layui-form-label">部门名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="name" placeholder="请输入部门名称" autocomplete="off" class="layui-input"
                               lay-verify="required">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">顺序编号</label>
                    <div class="layui-input-block">
                        <input type="text" name="storder" placeholder="请输入顺序编号" autocomplete="off" class="layui-input"
                               lay-verify="required">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">部门标识</label>
                    <div class="layui-input-block">
                        <select name="mark" id="mark"></select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">部门类型</label>
                    <div class="layui-input-block">
                        <select name="type" id="type"></select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">部门代码</label>
                    <div class="layui-input-block">
                        <input type="text" name="code" placeholder="请输入部门代码" autocomplete="off" class="layui-input"
                               lay-verify="required" disabled>
                    </div>
                </div>
                <div class="layui-form-item" style="display: none" id="higherOffice">
                    <label class="layui-form-label">上级部门</label>
                    <div class="layui-input-block">
                        <input type="text" name="parent" placeholder="请输入上级部门" autocomplete="off" class="layui-input"
                               lay-verify="addRequired" disabled>
                    </div>
                </div>
                <div style="text-align: center">
                    <button class="layui-btn" lay-submit lay-filter="submit">提交<i style='margin-left: 10px' class="layui-icon">&#4101;</i></button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    var $;
    var typeData = [
        {'key': "province", 'value': '省'},
        {'key': "town", 'value': '市'},
        {'key': "country", 'value': '县'}
    ];

    layui.use(['tree', 'layer', 'form', 'table', 'okUtils', "okLayer", 'constantUrl'], function () {
        $ = layui.jquery;
        var tree = layui.tree;
        var okUtils = layui.okUtils;
        var constantUrl = layui.constantUrl;
        var okLayer = layui.okLayer;
        var layer = layui.layer;
        var form = layui.form;
        var cacheData = {};
        var addFlag = 0; //区分添加和编辑的标志 1 添加 2 编辑

        var initTree = function () {
            var groupData = [];
            okUtils.ajax({"url":constantUrl.stAuth.selectGroup}).done(function (data1) {
                if (data1.data == null) {
                    layer.alert("警告 " + data1.msg)
                } else {
                    data = okUtils.structureTree({"data":data1.data.getMe,"check":true,"spread":true});
                    for (var index = 0; index < data.length; index++) {
                        if (data[index].PARENTID === -1) {
                            groupData[0] = data[index];
                        }
                    }
                    tree.render({
                        elem: '#departmentTree'
                        , onlyIconControl: true
                        , data: groupData
                        , id: 'treeId'
                        , customOperate: true
                        , edit: ['add', 'update', 'del']
                        , operate: function (obj) {
                            var type = obj.type; //得到操作类型：add、edit、del
                            var data = obj.data; //得到当前节点的数据
                            document.getElementById("form").reset();
                            cacheData = data;
                            if (type === 'add') { //增加节点
                                addFlag = 1;
                                addGroup(data)
                            } else if (type === 'del') { //删除节点
                                deleteGroup(data)
                            } else {
                                editGroup(obj.data);
                            }
                            return false;
                        }
                        , click: function (obj) {
                            cacheData = obj.data;
                            editGroup(obj.data);
                        }
                    });
                }
            });
        };

        initTree();

        okUtils.ajax({"url":constantUrl.stAuth.selectDic,"param":{'key': 'bmbh'}}).done(function (data1) {
            if (data1.meow != 0) {
                layer.alert("警告 " + data1.msg)
            } else {
                okUtils.ajax({"url":constantUrl.stAuth.selectDic,"param":{'parentid': data1.data[0].id}}).done(function (data2) {
                    okUtils.adapterSelect("#mark", "", "key", "name", data2.data);

                });

            }
        }).fail(function (error) {
            layer.alert("警告 " + error)
        });


        okUtils.ajax({"url":constantUrl.stAuth.selectDic,"param":{'key': 'bmlx'}}).done(function (data1) {
            if (data1.meow != 0) {
                layer.alert("警告 " + data1.msg)
            } else {
                okUtils.ajax({"url":constantUrl.stAuth.selectDic,"param":{'parentid': data1.data[0].id}}).done(function (data2) {
                    okUtils.adapterSelect("#type", "", "key", "name", data2.data);

                });

            }
        }).fail(function (error) {
            layer.alert("警告 " + error)
        });

     // okUtils.adapterSelect("#type", "", "key", "value", typeData);

        form.on("submit(submit)",function (data) {
            var  param = data.field;
            var type = $("#type option:selected");
            var mark = $("#mark option:selected");
            param.visible = mark.val();
            param.type = type.val();
            if (addFlag === 1){
                param.parentid = cacheData.ID;
                param.grouplevel = cacheData.GROUPLEVEL + 1;
                okUtils.ajax({"url": constantUrl.stAuth.selectGroup,"param":{"code": param.code},"returnDataAnyWay":true}).done(function (data1) {
                    if (data1.data == null) {
                        layer.alert("警告 " + data1.msg);
                    } else {
                        if (data1.meow == 0) {
                            layer.msg("编码已被占用，重新生成编码");
                            okUtils.ajax({"url": constantUrl.stAuth.getCode,"param":{"code": cacheData.ID}}).done(function (data2) {
                                var code = data2.data.code;
                                $("input[name='code']").val(code);
                                param.code = code;
                                okUtils.ajax({"url": constantUrl.stAuth.insertGroup,"param":param}).done(function (data3) {
                                    layer.alert("添加成功");
                                    resetForm(param);
                                    initTree();
                                }).fail(function (error) {
                                    layer.alert("警告 " + error);
                                })
                            })
                        }else {
                            okUtils.ajax({"url": constantUrl.stAuth.insertGroup,"param":param}).done(function (data3) {
                                layer.alert("添加成功");
                                resetForm(param);
                                initTree();
                            }).fail(function (error) {
                                layer.alert("警告 " + error);
                            })
                        }
                    }
                });
            }else if (addFlag === 2){
                param.id = cacheData.ID;
                okUtils.ajax({"url": constantUrl.stAuth.updateGroup,"param":param}).done(function (data3) {
                    layer.alert("编辑成功");
                    resetForm(param);
                    initTree();
                }).fail(function (error) {
                    layer.alert("警告 " + error);
                })
            }else {
                layer.msg("请刷新后重试")
            }
            return false;
        });

        var resetForm = function (data) {
            $("#higherOffice").hide();
            $("#mark").find("option[value = '" + data.visible + "']").attr("selected", "selected");
            $("#mark").attr("disabled", "disabled");
            $("#type").find("option[value = '" + data.type + "']").attr("selected", "selected");
            form.val("form", data);
        };

        var editGroup = function (data) {
            addFlag = 2;
            $("#higherOffice").hide();
            var param = {};
            $("#mark").find("option[value = '" + data.VISIBLE + "']").attr("selected", "selected");
            $("#mark").attr("disabled", "disabled");
            $("#type").find("option[value = '" + data.TYPE + "']").attr("selected", "selected");
            param.name = data.NAME;
            param.code = data.CODE;
            param.storder = data.STORDER;
            form.val("form", param);
        };

        var addGroup = function (data) {
            addFlag = 1;
            $("#higherOffice").show();
            var newData = {};
            newData.parent = data.NAME;
            $("#mark").find("option[value = '" + data.VISIBLE + "']").attr("selected", "selected");
            $("#mark").attr("disabled", "disabled");
            layui.form.render("select");
            okUtils.ajax({"url":constantUrl.stAuth.getGroupCode,"param":{"id": data.ID}}).done(function (data1) {
                newData.code = data1.data.code;
                form.val("form", newData);
            })
        };

        var deleteGroup = function (data) {
            var  param = {"groupId": data.ID};
            layer.confirm('是否确认删除', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                okUtils.ajax({"url":constantUrl.stAuth.deleteGroup1,"param":param}).done(function (data1) {
                    if (data1.data == null) {
                        layer.msg("警告" +  data.msg);
                    } else {
                        initTree();
                    }
                });
            });
        };
    })
</script>
</body>
</html>
