<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>字典配置</title>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>

<body style="overflow: hidden">
    <div class="commonOutCss">
        <table id="treeTable" lay-filter="treeTable"></table>
    </div>
    <script type="text/html" id="toolbarDemo">
        <div class="layui-btn-container">
        <button class="layui-btn " id = "add" style="text-align: right;margin-right: 20px" title="添加功能名称">添加功能名称<i style="margin-left: 10px" class="layui-icon">&#58964;</i></button>
    </div>
</script>
    <script>
    var ptable = null,
        treeGrid = null,
        tableId = 'treeTable',
        layer = null,
        okLayer = null;
    var $;
    var parentData = 0;
    layui.use(['zTreeGrid', 'treeGrid', 'layer', 'constantUrl', 'dltable', "okLayer", 'okUtils'], function() {
        $ = layui.jquery;
        treeGrid = layui.treeGrid;
        layer = layui.layer;
        okLayer = layui.okLayer;
        var constantUrl = layui.constantUrl;
        var okUtils = layui.okUtils;
        var zTreeGrid = layui.zTreeGrid({
            id: tableId,
            elem: '#' + tableId,
            idField: 'id',
            height: 'full-40',
            // data: data,
            toolbar: '#toolbarDemo',
            treeId: 'id' //树形id字段名称
                ,
            treeUpId: 'parentId' //树形父id字段名称
                ,
            treeShowName: 'funName' //以树形式显示的字段
                ,
            page: false,
            url: constantUrl.stAuth.selectGyy,
            parseData: function(res) {
                return {
                    "code": res.meow,
                    "msg": res.msg,
                    "data": res.data.getMe,
                    "count": 10
                };
            },
            cols: [
                [
                    { field: 'funName', title: '名称' },
                    { field: 'funKey', title: '名称编号' },
                    { field: 'createtime', title: '创建时间' },
                    {
                        width: 200,
                        title: '操作',
                        align: 'center' /*toolbar: '#barDemo'*/ ,
                        templet: function(d) {
                            var html = '';
                            var addBtn = '<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="addGyy">添加惯用语</a>';
                            var updateBtn = '<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">编辑</a>';
                            var delBtn = '<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>';
                            if (d.parentId == -1) {
                                return addBtn + updateBtn + delBtn;
                            } else {
                                return updateBtn + delBtn;
                            }

                        }
                    }
                ]
            ]
        });

        zTreeGrid.getTreeGrid();

        zTreeGrid.getLayuiTreeGrid().on('tool(' + tableId + ')', function(obj) {
            if (obj.event === "edit") {
                edit(obj);
            } else if (obj.event === "del") {
                del(obj)
            } else if (obj.event === "addGyy") {
                addGyy(obj)
            }
        });

        var del = function(obj) {
            var children = obj.data.children;
            var msg;
            if (children == "") {
                msg = "您确认想要删除该惯用语？";
            } else {
                msg = "该节点下面有子节点,删除后则子节点也一并删除,确认删除?";
            }
            layer.confirm(msg, { icon: 3, title: '提示' }, function(index) {
                layer.close(index);
                okUtils.ajax({ "url": constantUrl.stAuth.delGyy, "param": { "id": obj.data.id }, "traditional": true }).done(function(data1) {
                    layer.alert("删除成功");
                    reload();
                }).fail(function(error) {
                    console.log(error);
                });
            });
        };

        $(document).on('click', '#add', function() {
            parentData = 0;
            okLayer.open("添加功能名称", "gyyAdd.html", "30%", "50%", function(layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(null, true, "名称", true);
            }, function() {
                if (parentData === 1) {
                    reload()
                }
            })
        });
        var addGyy = function(obj) {
            okLayer.open("添加惯用语", "gyyAdd.html", "30%", "40%", function(layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(obj.data, true, "惯用语名称", false);
            }, function() {
                if (parentData === 1) {
                    reload()
                }
            })
        };
        var edit = function(obj) {
            okLayer.open("编辑惯用语", "gyyAdd.html", "30%", "40%", function(layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                if (obj.data.parentId == -1) {
                    iframeWin.initForm(obj.data, false, "名称", true);
                } else {
                    iframeWin.initForm(obj.data, false, "惯用语名称", false);
                }

            }, function() {
                if (parentData === 1) {
                    reload()
                }
            })
        };
    });

    function reload() {
        treeGrid.reload(tableId, {
            page: {
                curr: 1
            }
        });
    }
    </script>
</body>

</html>
