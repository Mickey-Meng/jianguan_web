<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>角色管理</title>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/extend/treeGrid.js"></script>
</head>

<body>
    <div class="commonOutCss">
        <table class="layui-hide" id="list" lay-filter="list"></table>
    </div>
    <script type="text/html" id="toolbar">
        <form class="layui-form layui-col-md12" id="search-form">
        <div class="layui-input-inline">
            <input class="layui-input"  placeholder="请输入操作内容" name="operation">
        </div>
         <div class="layui-input-inline" style="margin-left:20px;font-size: inherit;">
            操作类型:
        </div>
        <div class="layui-input-inline">
            <select name="type" id="type" lay-filter="xmFilter"></select>
        </div>
        <div class="layui-input-inline">
            <input class="layui-input"  placeholder="请输入操作人" name="operName">
        </div>
        <a class="layui-btn " lay-submit="" lay-filter="search" title="查询"><i class="layui-icon">&#58901;</i></a>
        <a class="layui-btn " id="add" title="添加子系统"><i class="layui-icon">&#58964;</i></a>
    </form>
</script>
    <script>
        var parentFlag = 0;
    var $;
    var selectData = null;
    layui.use(['tree', 'form', 'table', 'okUtils', "okLayer", 'constantUrl', 'zTable'],function () {
                    $ = layui.jquery;
                    var okUtils = layui.okUtils;
                    var constantUrl = layui.constantUrl;
                    var okLayer = layui.okLayer;
                    var form = layui.form;
                    var zTable = layui.zTable({
                        elem: '#list',
                        page: true, //是否显示分页
                        limit: 10, //每页默认显示的数量
                        url: constantUrl.stAuth.selectLog,
                        parseData: function(res) { //res 即为原始返回的数据
                            if (!res.data) {
                                return {
                                    "code": res.meow, //解析接口状态
                                    "msg": "无数据", //解析提示文本
                                    "count": 0, //解析数据长度
                                    "data": [] //解析数据列表
                                };
                            }
                            var result = res.data.getMe;
                            return {
                                "code": res.meow, //解析接口状态
                                "msg": res.data.msg, //解析提示文本
                                "count": res.data.total, //解析数据长度
                                "data": result //解析数据列表
                            };
                        },
                        height: 'full-40',
                        toolbar: '#toolbar',
                        cols: [
                            [ //标题栏
                                { field: 'loginIp', title: '登录ip' }, { field: 'operation', title: '操作内容' }, { field: 'logName', title: '操作类型' },  { field: 'operUserName', title: '操作人' },{ field: 'remark', title: '备注' },{ field: 'createtime', title: '操作时间' }, { title: "操作", width: 300, align: "center", templet: "#operationTpl" }
                            ]
                        ]
                    });
                       var myTable = zTable.getTable();
                okUtils.ajax({"url":constantUrl.stAuth.selectDic,"param":{'key': 'logType'}}).done(function (data1) {
            if (data1.meow != 0) {
                layer.alert("警告 " + data1.msg)
            } else {
                okUtils.ajax({"url":constantUrl.stAuth.selectDic,"param":{'parentid': data1.data[0].id}}).done(function (data2) {
                    selectData =  data2.data
                    okUtils.adapterSelect("#type", "", "key", "value", data2.data);

                });

            }
        }).fail(function (error) {
            layer.alert("警告 " + error)
        });
            form.on("submit(search)", function (data) {
                     var param = {};
                        param.operation = data.field.operation;
                        var stype = data.field.type;
                        if (stype) {
                           param.logType = stype;
                        }
                        param.operName = data.field.operName;
                        myTable.reload({
                            url: constantUrl.stMap.selectLog,
                            where: param,
                            page: {curr: 1}
                        });
                        okUtils.adapterSelect("#type", "", "key", "value",selectData);
                        return false;
        });
                    $(document).on('click', '#add', function() {
                        parentFlag = 0;
                        okLayer.open("添加日志", "add.html", "40%", "60%", function(layero) {
                            var iframeWin = window[layero.find("iframe")[0]["name"]];
                            iframeWin.initForm(null,selectData,true);
                        }, function() {
                            if (parentFlag === 1) {
                                  myTable.reload();
                            }
                        })
                    });

                    $(document).on('click', '#reload', function() {
                        myTable.reload({
                            url: constantUrl.stMap.selectSubSystem,
                            page: {curr: 1}
                        });
                        okUtils.adapterSelect("#type", "", "key", "value",selectData);
                        return false;
                    });

                    zTable.getLayuiTable().on("tool(list)", function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case "btnEdit":
                parentFlag = 0;
                    edit(data);
                    break;
                case "btnDel":
                parentFlag = 0;
                    btnDel(data);
                    break;
            }
        });

                    var edit = function(obj) {
                        okLayer.open("编辑信息", "add.html", "40%", "60%", function(layero) {
                            var iframeWin = window[layero.find("iframe")[0]["name"]];
                            iframeWin.initForm(obj, selectData, false);
                        }, function() {
                            if (parentFlag === 1) {
                               myTable.reload();
                            }
                        })
                    };
                     function btnDel(data) {
            okLayer.confirm("确定要删除吗？", function (index) {
                okUtils.ajax({
                    "url": constantUrl.stAuth.delLog,
                    "param": {"id": data.id}
                }).done(function (response) {
                    okUtils.table.successMsg("删除成功");
                    myTable.reload();
                }).fail(function (error) {
                    console.log(error)
                });
            });
        }
                });

    </script>
</body>
<script type="text/html" id="operationTpl">
    <div>
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnEdit">编辑信息</button>
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnDel">删除</button>
    </div>
</script>

</html>
