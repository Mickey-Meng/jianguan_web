<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文件上传</title>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<div class="layui-body commonOutCss" style="left: 0">
    <div >
        <table class="layui-hide" id="files" lay-filter="users"></table>
    </div>
</div>

<script type="text/html" id="toolbar">
    <form class="layui-form layui-col-md12">
        <button class="layui-btn" id="add" title="添加文件">添加文件<i class="layui-icon">&#58964;</i>
        </button>
    </form>
</script>

<!--
42,84,95行url,selectFile 41行url 46行扩展参数


-->
<script>
    var $;
    var allFile;
    layui.use([ 'table', 'okUtils', "okLayer", 'constantUrl' ], function () {
        $ = layui.jquery;
        var okUtils = layui.okUtils;
        var constantUrl = layui.constantUrl;
        var okLayer = layui.okLayer;
        var table = layui.table;

        var myTable = table.render({
            elem: '#files'
            , page: true //是否显示分页
            , limit: 10 //每页默认显示的数量
            , url: 'http://192.168.43.6:8080/STSfmb/sanya/getManageFile'
            , parseData: function (res) { //res 即为原始返回的数据
                var result = {};//分页
                var length = res.data ? res.data.length : 0;
                allFile = res.data;
                if (this.page.curr) {
                    result = res.data.slice(this.limit * (this.page.curr - 1), this.limit * this.page.curr);
                } else {
                    result = res.data.slice(0, this.limit);
                }
                return {
                    "code": res.meow, //解析接口状态
                    "msg": res.data.msg, //解析提示文本
                    "count": length, //解析数据长度
                    "data": result //解析数据列表
                };
            }
            , height: 'full-58'
            ,toolbar:'#toolbar'
            , cols: [[ //标题栏
                {field: 'fileName', title: '文件名'}
                , {field: 'time', title: '上传时间'}
                , {field: 'msg', title: '备注信息'}
                , {title: "操作", width: 200, align: "center", templet: "#operationTpl"}
            ]]
        });

        table.on("tool(users)", function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case "btnDel":
                    btnDel(data);
                    break;
                case "download":
                    downloadFile(data);
                    break;
            }
        });

        function btnDel(data) {
            okLayer.confirm("确定要删除吗？", function (index) {
                okUtils.ajax({
                    "url": 'http://192.168.43.6:8080/STSfmb/sanya/deleteManegeFile',
                    "param": {"id": data.id}
                }).done(function (response) {
                    okUtils.table.successMsg("删除成功");
                }).fail(function (error) {
                    console.log(error)
                });
            });
        }

        function downloadFile(data){
            var url = data.path ? 'http://192.168.43.6:8080/STSfmb/temp/' + data.path + "/" + data.fileName
                : 'http://192.168.43.6:8080/STSfmb/temp/' + data.fileName;
            window.open( url);
        }

        $('#add').click(function () {
            okLayer.open("选择文件", "selectFile.html", "90%", "90%", function (layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(allFile);
            }, function () {
                myTable.reload()
            });
            return false;
        });
    })
</script>

<script type="text/html" id="operationTpl">
    <div>
        <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="download">下载</button>
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnDel">删除</button>
    </div>
</script>
</body>
</html>
