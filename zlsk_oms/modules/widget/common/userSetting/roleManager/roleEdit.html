<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>角色设置</title>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/lib/layui/css/layui.css" media="all">
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<form class="layui-form layui-form-pane ok-form" style="margin-top: 15px;margin-right: 20px;">
    <div class="layui-form-item">
        <label class="layui-form-label">角色名称</label>
        <div class="layui-input-block">
            <input type="text" id="USERNAME" name="USERNAME" placeholder="请输入角色名称" autocomplete="off" class="layui-input"
                   lay-verify="required">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">角色编码</label>
        <div class="layui-input-block">
            <input type="text" id="NAME" name="NAME" placeholder="请输入角色编码" autocomplete="off" class="layui-input"
                   lay-verify="required">
        </div>
    </div>
    <div class="layui-form-item" id="department" style="display: none">
        <label class="layui-form-label">上级角色</label>
        <div class="layui-input-block">
            <select name="xm" id="xm" lay-verify="department" lay-filter="xmFilter" class="layui-btn-xs" style="overflow-y:scroll;"></select>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="add">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>
<script>

    var $;
    var groupData;
    var isAdd;
    var roleData;

    function initForm(data, initData,isadd) {
        groupData = data;
        roleData = initData;
        isAdd = isadd;

        if (!isAdd){
            document.getElementById("USERNAME").value = initData.NAME;
            document.getElementById("NAME").value = initData.CODE;
        }
    }

    layui.use(['form','constantUrl','okUtils','okLayer'], function () {
        $ = layui.jquery;
        var form = layui.form;
        var okLayer = layui.okLayer;
        var okUtils = layui.okUtils;
        var constantUrl = layui.constantUrl;

        if (isAdd){
            $("#department").show();
        }

        $.each(groupData, function (index, value) {
            $('#xm').append(value.outerHTML);
        });
        layui.form.render("select");

        form.verify({
            "department":function (value, item) {
                if (isAdd && (!value || value == "")){
                    return '请选择部门';
                }
            }
        });

        form.on("submit(add)",function (data) {
            var param = {};

            if (isAdd){
                param.name = data.field.USERNAME;
                param.code = data.field.NAME;
                param.parentid = data.field.xm;
                if (param.parentid == -1) {
                    param.rolelevel = 1;
                }else {
                    param.rolelevel = 2;
                }
                okUtils.ajax({"url":constantUrl.stAuth.insertRole,"param":param}).done(function (data1) {
                    okLayer.msg.greenTick( "添加成功" , function () {
                        parent.parentFlag = 1;
                        parent.layer.close(parent.layer.getFrameIndex(window.name));
                    })
                }).fail(function (error) {
                    layer.alert(error.msg)
                });
            }else {
                param.name = data.field.USERNAME;
                param.code = data.field.NAME;
                param.id = roleData.ID;
                param.parentid = data.field.xm;
                okUtils.ajax({"url":constantUrl.stAuth.updateRole,"param":param}).done(function (data1) {
                    okLayer.msg.greenTick("编辑成功", function () {
                        parent.parentFlag = 1;
                        parent.layer.close(parent.layer.getFrameIndex(window.name));
                    })
                }).fail(function (error) {
                    layer.alert(error.msg)
                });
            }
            return false;
        })
    })

</script>
</body>
</html>
