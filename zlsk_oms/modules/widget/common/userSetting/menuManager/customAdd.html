<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>添加属性</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/oksub.css">
    <style type="text/css">
    /*您可以将下列样式写入自己的样式表中*/
    .childBody {
        padding: 15px;
    }

    /*layui 元素样式改写*/
    .layui-btn-sm {
        line-height: normal;
        font-size: 12.5px;
    }

    /*.layui-table-view .layui-table-body {
        min-height: 256px;
    }*/

    .layui-table-cell .layui-input.layui-unselect {
        height: 30px;
        line-height: 30px;
    }

    /*设置 layui 表格中单元格内容溢出可见样式*/
    .table-overlay .layui-table-view,
    .table-overlay .layui-table-box,
    .table-overlay .layui-table-body {
        overflow: visible;
    }

    .table-overlay .layui-table-cell {
        height: auto;
        overflow: visible;
    }

    /*文本对齐方式*/
    .text-center {
        text-align: center;
    }
    </style>
</head>

<body class="childBody">
    <section class="layui-col-md10" style="margin: 0 auto; float: none;">
        <div class="layui-card">
            <div class="layui-card-body layui-text">
                <div id="tableRes" class="table-overlay">
                    <table id="dataTable" lay-filter="dataTable" class="layui-hide"></table>
                </div>
                <div id="action" class="text-center">
                    <button type="button" class="layui-btn layui-btn-sm" data-type="addRow" title="添加一行">
                        <i class="layui-icon layui-icon-add-1"></i> 添加一行
                    </button>
                    <!--  <button type="button" name="btnSave" class="layui-btn" data-type="save"><i class="layui-icon layui-icon-ok-circle"></i>保存</button> -->
                    <button type="button" class="layui-btn layui-btn-sm" data-type="save" title="添加一行">
                        <i class="layui-icon layui-icon-add-1">保存</i>
                    </button>
                </div>
            </div>
        </div>
    </section>
    <!--recommended script position-->
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <script type="text/javascript">
    var viewObj = null;
    var attr = null;
    var $;

    function initForm(res) {
        if (!res) {
            viewObj = {
                tbData: [{ tempId: new Date().valueOf(), key: null, value: null }]
            };
        } else {

            viewObj = {};
            var tbData = [];
            attr = JSON.parse(res);
             for (var key in attr) {
                    tbData.push({ tempId: new Date().valueOf(), key: key, value: attr[key] })
                }
            // for (var i = 0; i < obj.length; i++) {
            //     var o = obj[i];
            //     for (var key in o) {
            //         tbData.push({ tempId: new Date().valueOf(), key: key, value: o[key] })
            //     }

            // }
            viewObj['tbData'] = tbData;
        }

    }

    layui.use(['table', 'layer'], function() {
        $ = layui.jquery;
        table = layui.table,
            form = layui.form,
            layer = layui.layer;

        //数据表格实例化
        var tbWidth = $("#tableRes").width();
        var layTableId = "layTable";
        var tableIns = table.render({
            elem: '#dataTable',
            id: layTableId,
            data: viewObj.tbData,
            width: tbWidth,
            page: false,
            loading: true,
            even: false, //不开启隔行背景
            cols: [
                [

                    { field: 'key', title: '属性', edit: 'text' },
                    { field: 'value', title: '属性值', edit: 'text' },
                    {
                        field: 'tempId',
                        title: '操作',
                        templet: function(d) {
                            return '<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del" lay-id="' + d.tempId + '"><i class="layui-icon layui-icon-delete"></i>移除</a>';
                        }
                    }
                ]
            ],
            done: function(res, curr, count) {
                viewObj.tbData = res.data;
            }
        });



        //定义事件集合
        var active = {
            addRow: function() { //添加一行
                var oldData = table.cache[layTableId];
                var newRow = { tempId: new Date().valueOf(), key: null, value: null };
                oldData.push(newRow);
                tableIns.reload({
                    data: oldData
                });
            },
            updateRow: function(obj) {
                var oldData = table.cache[layTableId];
                console.log(oldData);
                for (var i = 0, row; i < oldData.length; i++) {
                    row = oldData[i];
                    if (row.tempId == obj.tempId) {
                        $.extend(oldData[i], obj);
                        return;
                    }
                }
                tableIns.reload({
                    data: oldData
                });
            },
            removeEmptyTableCache: function() {
                var oldData = table.cache[layTableId];
                for (var i = 0, row; i < oldData.length; i++) {
                    row = oldData[i];
                    if (!row || !row.tempId) {
                        oldData.splice(i, 1); //删除一项
                    }
                    continue;
                }
                tableIns.reload({
                    data: oldData
                });
            },
            save: function() {
                var oldData = table.cache[layTableId];
                console.log(oldData);
                var d = [];
                var obj = {};
                for (var i = 0, row; i < oldData.length; i++) {
                    row = oldData[i];
                    if (row.key && row.value) {

                        obj[row.key] = row.value;
                        //d.push(obj);
                    }

                }
                if(!obj){
                    layer.msg("检查每一行，请输入内容", { icon: 5 }); //提示
                    return;
                }
                // if (d.length == 0) {
                //     layer.msg("检查每一行，请输入内容", { icon: 5 }); //提示
                //     return;
                // }
                var newdata = JSON.stringify(obj);
                parent.attrObj = newdata;
                parent.layer.close(parent.layer.getFrameIndex(window.name));
            }
        }

        //激活事件
        var activeByType = function(type, arg) {
            if (arguments.length === 2) {
                active[type] ? active[type].call(this, arg) : '';
            } else {
                active[type] ? active[type].call(this) : '';
            }
        }

        //注册按钮事件
        $('.layui-btn[data-type]').on('click', function() {
            var type = $(this).data('type');
            activeByType(type);
        });

        //监听select下拉选中事件
        form.on('select(type)', function(data) {
            var elem = data.elem; //得到select原始DOM对象
            $(elem).prev("a[lay-event='type']").trigger("click");
        });

        //监听工具条
        table.on('tool(dataTable)', function(obj) {
            var data = obj.data,
                event = obj.event,
                tr = obj.tr; //获得当前行 tr 的DOM对象;
            console.log(data);
            switch (event) {
                case "del":
                    layer.confirm('确定删除？', function(index) {
                        obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                        layer.close(index);
                        activeByType('removeEmptyTableCache');
                    });
                    break;
            }
        });
    });
    </script>
</body>

</html>
