<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>权限配置</title>
    <script type="text/javascript" src="../../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <link rel="stylesheet" href="../../../../../lib/ok_admin/css/oksub.css">
</head>
<body>
<div class="layui-body" style="left: 0px">
<div id="role" style="margin-left: 10%;margin-top: 10px"></div>
<div class="layui-form-item" style="margin-top: 10px">
    <div class="layui-input-block">
        <button class="layui-btn" lay-submit lay-filter="edit" id="edit">提交</button>
    </div>
</div>
</div>
<script>
    var initData;
    var $;

    function initForm(data) {
        var jsonString = JSON.stringify(data);
        initData = JSON.parse(jsonString);
    }

    layui.use(['layer', 'form', "element", "laydate", "okLayer", "okUtils", 'constantUrl', 'tree'], function () {
        $ = layui.jquery;
        var laydate = layui.laydate;
        var okLayer = layui.okLayer;
        var okUtils = layui.okUtils;
        var tree = layui.tree;
        var form = layui.form;
        var constantUrl = layui.constantUrl;
        var layer = layui.layer;

        var groupData = [];
        okUtils.ajax({"url":constantUrl.stAuth.selectRole}).done(function (data1) {
            if (data1.data == null) {
                alert("警告 "+ data1.msg)
            } else {
                data = okUtils.structureTree({"data":data1.data.getMe,"check":false,"spread":true});
                for (var index = 0; index < data.length; index++) {
                    if (data[index].PARENTID == -1) {
                        groupData.push(data[index])
                    }
                }
                tree.render({
                    elem: '#role'
                    ,showCheckbox: true
                    ,data: groupData
                    ,id: 'treeId'
                    ,showLine: false //关闭连接线
                });
            }
        });

        okUtils.ajax({"url":constantUrl.stAuth.selectFunRole,"param":{'code': initData.CODE}}).done(function (roles) {
            if (roles.data != "") {
                var roleList = roles.data.getMe;
                if (roleList && roleList.length > 0) {
                    var cacheRole = [];
                    for (var index = 0; index < roleList.length; index++) {
                        cacheRole.push(roleList[index].ID)
                    }
                    tree.setChecked('treeId', cacheRole);
                }
            }
        });
        $(document).on('click', '#edit', function () {
            var checkData = tree.getChecked('treeId');
            var roleList = getRole(checkData, []);
            if (checkData && checkData.length > 0 && roleList.length > 0) {
                okUtils.ajax({"url":constantUrl.stAuth.deleteFunRole,"param":{"rid": initData.ID}}).done(function (roles) {
                    okUtils.ajax({"url":constantUrl.stAuth.insertFunRole,"param":{"funId": initData.ID, 'roleId': roleList},"traditional":true}).done(function (data) {
                        okLayer.msg.greenTick("编辑成功", function () {
                            parent.parentFlag = 1;
                            parent.layer.close(parent.layer.getFrameIndex(window.name));
                        });
                    }).fail(function (error) {
                        alert("警告 " +  data.msg);
                    });
                }).fail(function (error) {
                    alert("警告 " +  data.msg)
                })
            } else {
                layer.msg('请先选择角色');
            }
        })
    });

    var getRole = function (data, cache) {
        if (data && data.length > 0) {
            for (var index = 0; index < data.length; index++) {
//                todo check role level
                if (data[index].ROLELEVEL == "2") {
                    cache.push(data[index].ID)
                }
                if (data[index].children && data[index].children.length > 0) {
                    getRole(data[index].children, cache);
                }
            }
        }
        return cache;
    }

</script>
</body>
</html>
