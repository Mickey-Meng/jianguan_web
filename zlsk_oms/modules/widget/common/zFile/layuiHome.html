<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文件管理</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
</head>
<body>
<script type="text/html" id="toolbar">
    <form class="layui-form layui-col-md12">
        <div class="layui-input-inline" style="width: 100px">
            <i class="layui-icon">&#xe621;</i>
            <a id="folderName" style="width: 100px"></a>
        </div>
        <div class="layui-input-inline" style="width: 100px">
            <select name="higherOffice" id="higherOffice" lay-filter="folderName"></select>
        </div>
        <div class="layui-input-inline ok-search" style="width: 100px">
            <input class="layui-input" placeholder="请输入文件名" autocomplete="off" name="fileName" style="width: 100px">
        </div>
        <button class="layui-btn" lay-submit="" lay-filter="search" id="search" title="条件查询">
            <i class="layui-icon">&#xe615;</i>
        </button>
        <button class="layui-btn" lay-submit="" lay-filter="refresh" id="refresh" title="刷新">
            <i class="layui-icon">&#xe9aa;</i>
        </button>
        <button class="layui-btn" lay-submit="" lay-filter="download" id="download" title="打包下载">
            <i class="layui-icon">&#xe601;</i>
        </button>
        <div class="layui-input-inline" style="width: 100px">
            <select name="operation" id="operation" lay-filter="operation">
                <option value="">选择操作</option>
                <option>上传文件</option>
                <option>上传文件夹</option>
                <option>新建文件夹</option>
                <option>删除</option>
            </select>
        </div>
    </form>
</script>

<div class="layui-body commonOutCss" style="left: 0">
    <table id="fileTable" lay-filter="fileTable"></table>
</div>

<script>
    var $;
    var currentFid = 'root';
    var currentFile;
    var parentFlag = 0;
    var progressLayer;
    var URL_PREFIX = 'http://localhost:9000/esriProxy/proxy.jsp?http://localhost:8080/';
    layui.use(['form', 'table', 'okUtils', "okLayer",  'table', 'layer'], function () {
        $ = layui.jquery;
        var okUtils = layui.okUtils;
        var okLayer = layui.okLayer;
        var form = layui.form;
        var layer = layui.layer;
        var table = layui.table;

        table.render({
            elem: '#fileTable'
            , page: true //是否显示分页
            , limit: 10 //每页默认显示的数量
            , height: 'full-58'
            , defaultToolbar: []
            , toolbar: '#toolbar'
            , cols: [[ //标题栏
                {checkbox: true}
                , {field: 'fileName', title: '文件名', templet: "#operationFolder"}
                , {field: 'fileCreationDate', title: '创建日期'}
                , {field: 'fileSize', title: '大小'}
                , {title: "操作", width: 300, align: "center", templet: "#operationTpl"}
            ]]
        });

        getFile();

        let option = [];
        option.push({"value": "", "text": "请选择"});
        option.push({"value": "上传文件", "text": "上传文件"});
        if (isSupportWebkitdirectory())option.push({"value": "上传文件夹", "text": "上传文件夹"});
        option.push({"value": "新建文件夹", "text": "新建文件夹"});
        option.push({"value": "删除", "text": "删除"});
        okUtils.adapterSelect("#operation", "", "value", "text", option);

        table.on("tool(fileTable)", function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case "btnLinked":
                    linkDown(data);
                    break;
                case "btnEditFile":
                    editFile(data);
                    break;
                case "btnDel":
                    deleteFolderOrFile(data);
                    break;
                case "btnEditFolder":
                    editFolder(data);
                    break;
                case "btnGo":
                    currentFid = data.folderId;
                    getFile();
                    break
            }
        });

        form.on('select(folderName)', function (data) {
            if (data.value !== '-1') {
                getFile({fid: data.value})
            }
            return false;
        });

        form.on('select(operation)', function (data) {
            switch (data.value) {
                case '上传文件':
                    okLayer.open("上传文件", "fileSelect.html", "60%", "60%", function (layero) {
                        var iframeWin = window[layero.find("iframe")[0]["name"]];
                        iframeWin.initForm(currentFile,0);
                    }, function () {
                        getFile()
                    });
                    break;
                case '上传文件夹':
                    okLayer.open("上传文件夹", "fileSelect.html", "60%", "60%", function (layero) {
                        var iframeWin = window[layero.find("iframe")[0]["name"]];
                        iframeWin.initForm(currentFile,1);
                    }, function () {
                        getFile()
                    });
                    break;
                case '新建文件夹':
                    parentFlag = 0;
                    okLayer.open("上传文件", "createNewFile.html", "60%", "60%", function (layero) {
                        var iframeWin = window[layero.find("iframe")[0]["name"]];
                        iframeWin.initForm(currentFile);
                    }, function () {
                        if (parentFlag === 1) {
                            getFile()
                        }
                    });
                    break;
                case '删除':
                    var faf = getCheckFile();
                    if (!faf){
                        layer.alert('请勾选文件');
                        return
                    }
                    $.ajax({
                        type: "POST",
                        dataType: "text",
                        data: {
                            strIdList: faf.filesId,
                            strFidList: faf.foldersId
                        },
                        url: URL_PREFIX + "homeController/deleteCheckedFiles.ajax",
                        success: function (result) {
                            if (result === "mustLogin") {
                                layer.alert("提示：出现意外错误，可能未能删除全部文件");
                            } else {
                                if (result === "noAuthorized") {
                                    layer.alert("提示：您的操作未被授权，删除失败");
                                } else if (result === "errorParameter") {
                                    layer.alert("提示：参数不正确，未能全部删除文件");
                                } else if (result === "cannotDeleteFile") {
                                    layer.alert("提示：出现意外错误，可能未能删除全部文件");
                                } else if (result === "deleteFileSuccess") {
                                    getFile();
                                } else {
                                    layer.alert("提示：出现意外错误，可能未能删除全部文件");
                                }
                            }
                        },
                        error: function () {
                            layer.alert("提示：出现意外错误，可能未能删除全部文件");
                        }
                    });
                    break;
            }
            return false;
        });

        // 判断浏览器是否支持webkitdirectory属性且不为ios系统（判断是否能进行文件夹上传）
        function isSupportWebkitdirectory() {
            var testWebkitdirectory = document.createElement("input");
            if ("webkitdirectory" in testWebkitdirectory && !(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent))) {
                return true;
            } else {
                return false;
            }
        }

        form.on("submit(search)", function (data) {
            let name = data.field.fileName;
            let tableData = layui.table.cache.fileTable;
            let cache = [];
            try {
                var reg = new RegExp(name + "+");
                for (let index = 0; index < tableData.length; index++) {
                    if (reg.test(tableData[index].folderName) || reg.test(tableData[index].fileName) || tableData[index].flagBack) {
                        cache.push(tableData[index]);
                    }
                }
                table.reload('fileTable', {
                    data: cache
                })
            } catch (e) {
                alert("错误：搜索关键字有误。请在特殊符号（例如“*”）前加上“\\”进行转义。");
            }
            return false;
        });

        form.on("submit(refresh)", function (data) {
            getFile()
        });

        form.on("submit(download)", function (data) {
            downloadAllChecked();
            return false;
        });

        function getCheckFile() {
            let filesAndFolders = {};
            let checkData = table.checkStatus('fileTable').data;
            if (!checkData || checkData.length === 0 || (checkData.length === 1 && checkData[0].flagBack)) {
                return false;
            } else {
                var filesId = [];
                var foldersId = [];
                for (let index = 0; index < checkData.length; index++) {
                    if (checkData[index].flagFile) {
                        filesId.push(checkData[index].fileId)
                    } else if (checkData[index].flagFolder) {
                        foldersId.push(checkData[index].folderId)
                    }
                }
            }
            filesAndFolders.filesId = JSON.stringify(filesId);
            filesAndFolders.foldersId = JSON.stringify(foldersId);
            return filesAndFolders;
        }

        function getFile(param) {
            if (!param) {
                param = {};
                param.fid = currentFid;
            }
            $.ajax({
                type: 'POST',
                dataType: 'text',
                data: param,
                url: URL_PREFIX + 'homeController/getFolderView.ajax',
                success: function (result) {
                    if (result === "ERROR") {
                        layer.alert('获取失败，请尝试刷新');
                    } else if (result === "mustLogin") {
                        layer.alert('获取失败');
                    } else if (result === "NOT_FOUND") {
                        layer.alert('获取失败');
                        window.location.href = "/";
                    } else if (result === "notAccess") {
                        layer.alert('获取失败');
                    } else {
                        let cache = JSON.parse(result);
                        let data = [];
                        let option = [];
                        if (cache) {
                            if (cache.parentList.length !== 0) {
                                let cacheData = cache.parentList[cache.parentList.length - 1];
                                cacheData.fileSize = "-";
                                cacheData.fileName = "../";
                                cacheData.fileCreationDate = cacheData.folderCreationDate;
                                cacheData.flagBack = true;
                                data.push(cacheData);

                                $.each(cache.parentList, function (index, value) {
                                    option.push(value);
                                });
                            } else {
                                option.push({"folderId": "-1", "folderName": "无"});
                            }
                            let folderList = cache.folderList;
                            if (folderList.length !== 0) {
                                for (let index = 0; index < folderList.length; index++) {
                                    folderList[index].fileSize = "-";
                                    folderList[index].fileName = folderList[index].folderName;
                                    folderList[index].fileCreationDate = folderList[index].folderCreationDate;
                                    folderList[index].flagFolder = true;
                                    data.push(folderList[index]);
                                }
                            }
                            let fileList = cache.fileList;
                            if (fileList.length !== 0) {
                                for (let index = 0; index < fileList.length; index++) {
                                    fileList[index].flagFile = true;
                                    if (fileList[index].fileSize === "0") {
                                        fileList[index].fileSize = '<1M';
                                    } else {
                                        fileList[index].fileSize = fileList[index].fileSize + 'M';
                                    }
                                    data.push(fileList[index]);
                                }
                            }
                            currentFile = cache.folder;
                            currentFid = cache.folder.folderId;
                        }
                        table.reload('fileTable', {
                            data: data
                        });
                        okUtils.adapterSelect("#higherOffice", "", "folderId", "folderName", option);
                        $('#folderName').text(cache.folder.folderName);
                    }
                },
                error: function () {
                    layer.alert('获取失败，请尝试刷新');
                }
            });
        }

        function linkDown(data) {
            okLayer.confirm("确定要下载 " + data.fileName + " 吗？", function (index) {
                window.location.href = URL_PREFIX + "homeController/downloadFile.do?fileId=" + data.fileId;
            });
        }

        function editFile(data) {
            parentFlag = 0;
            okLayer.open("编辑文件", "editFile.html", "60%", "60%", function (layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(data, true);
            }, function () {
                if (parentFlag === 1) {
                    getFile()
                }
            })
        }

        function deleteFolderOrFile(data) {
            let isFile = data.flagFile;
            layer.confirm("确定要删除 " + data.fileName + " 吗？", function (index) {
                if (isFile) {
                    deleteFile(data, function (success) {
                        if (success) {
                            layer.closeAll('dialog');
                            getFile();
                        }
                    })
                } else {
                    deleteFolder(data, function (success) {
                        if (success) {
                            layer.closeAll('dialog');
                            getFile();
                        }
                    })
                }
            });
        }

        function deleteFile(data, callback) {
            $.ajax({
                type: "POST",
                dataType: "text",
                data: {
                    fileId: data.fileId
                },
                url: URL_PREFIX + "homeController/deleteFile.ajax",
                success: function (result) {
                    if (result === "mustLogin") {
                        // window.location.href = "prv/login.html";
                        layer.alert("提示：出现意外错误，可能未能删除文件");
                    } else {
                        if (result === "noAuthorized") {
                            layer.alert("提示：您的操作未被授权，删除失败");
                        } else if (result === "errorParameter") {
                            layer.alert("提示：参数不正确，删除失败");
                        } else if (result === "cannotDeleteFile") {
                            layer.alert("提示：出现意外错误，可能未能删除文件")
                        } else if (result === "deleteFileSuccess") {
                            callback(true);
                        } else {
                            layer.alert("提示：出现意外错误，可能未能删除文件");
                        }
                    }
                },
                error: function () {
                    layer.alert("提示：出现意外错误，可能未能删除文件");
                }
            });
        }

        function deleteFolder(data, callback) {
            $.ajax({
                type: "POST",
                dataType: "text",
                data: {
                    folderId: data.folderId
                },
                url: URL_PREFIX + "homeController/deleteFolder.ajax",
                success: function (result) {
                    if (result === "mustLogin") {
                        window.location.href = "prv/login.html";
                    } else {
                        if (result === "noAuthorized") {
                            layer.alert("提示：您的操作未被授权，删除文件夹失败");
                        } else if (result === "errorParameter") {
                            layer.alert("提示：参数不正确，删除文件夹失败");
                        } else if (result === "cannotDeleteFolder") {
                            layer.alert("提示：出现意外错误，可能未能删除文件夹");
                        } else if (result === "deleteFolderSuccess") {
                            callback(true)
                        } else {
                            layer.alert("提示：出现意外错误，可能未能删除文件夹");
                        }
                    }
                },
                error: function () {
                    layer.alert("提示：出现意外错误，可能未能删除文件夹");
                }
            });
        }

        function editFolder(data) {
            parentFlag = 0;
            okLayer.open("编辑文件夹", "editFile.html", "60%", "60%", function (layero) {
                var iframeWin = window[layero.find("iframe")[0]["name"]];
                iframeWin.initForm(data, false);
            }, function () {
                if (parentFlag === 1) {
                    getFile()
                }
            })
        }

        function isSupportWebkitdirectory() {
            var testWebkitdirectory = document.createElement("input");
            if ("webkitdirectory" in testWebkitdirectory && !(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent))) {
                return true;
            } else {
                return false;
            }
        }

        // 下载选中的所有文件
        function downloadAllChecked() {
            var faf = getCheckFile();
            if (!faf){
                layer.alert('请勾选文件');
                return;
            }
            layer.msg("提示：服务器正在对选中资源进行压缩（共" + faf.size
                + "项），这可能需要一些时间（文件越大耗时越长），压缩完成将自动开始下载。");
            // 计算预计耗时
            $.ajax({
                url: URL_PREFIX + 'homeController/getPackTime.ajax',
                type: 'POST',
                data: {
                    strIdList: faf.filesId,
                    strFidList: faf.foldersId
                },
                dataType: 'text',
                success: function (result) {
                    layer.load(2, { //icon支持传入0-2
                        shade: [0.5, 'gray'], //0.5透明度的灰色背景
                        content: '压缩中...',
                        success: function (layero) {
                            layero.find('.layui-layer-content').css({
                                'padding-top': '39px',
                                'width': '60px'
                            });
                        }
                    });
                },
                error: function () {
                    layer.alert("（无法获取预计耗时）");
                }
            });
            // 同时发送压缩下载请求
            $.ajax({
                type: "POST",
                url: URL_PREFIX + "homeController/downloadCheckedFiles.ajax",
                data: {
                    strIdList: faf.filesId,
                    strFidList: faf.foldersId
                },
                dataType: "text",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result === "ERROR") {
                        layer.alert("提示：压缩过程出错。无法完成压缩，请重试或告知管理员。");
                    } else {
                        layer.msg("提示：压缩完成！准备开始下载");
                        // POST提交全部下载请求
                        var temp = document.createElement("form");
                        temp.action = URL_PREFIX + 'homeController/downloadCheckedFilesZip.do';
                        temp.method = "post";
                        temp.style.display = "none";
                        var sl = document.createElement("input");
                        sl.name = 'zipId';
                        sl.value = result;
                        temp.appendChild(sl);
                        document.body.appendChild(temp);
                        temp.submit();
                    }
                },
                error: function () {
                    layer.closeAll('loading');
                    layer.alert("提示：请求失败。无法完成压缩，请重试或告知管理员。");
                }
            });
        }
    });
</script>

<script type="text/html" id="operationTpl">
    {{#  if(d.flagFile){ }}
    <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnLinked">下载</button>
    <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnDel">删除</button>
    <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnEditFile">重命名</button>
    {{#  } }}
    {{#  if(d.flagFolder){ }}
    <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btnDel">删除</button>
    <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="btnEditFolder">编辑</button>
    {{#  } }}
</script>

<script type="text/html" id="operationFolder">
    {{#  if(d.flagFolder || d.flagBack){ }}
    <a href="###" class="layui-table-link" lay-event="btnGo">{{d.fileName}}</a>
    {{#  } else { }}
    {{d.fileName}}
    {{#  } }}
</script>
</body>
</html>
