<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文件选择</title>
    <link rel="stylesheet" href="../../../../lib/ok_admin/css/okadmin.css">
    <script type="text/javascript" src="../../../../lib/ok_admin/lib/layui/layui.js"></script>
    <!-- Bootstrap基本框架 -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">
</head>
<body>
<form class="layui-form layui-col-md12" id="file" style="margin-left: 10px;margin-top: 10px;display: none">
    <div class="layui-form-item">
        <h5>
            选择文件：<span id="selectcount"></span>
        </h5>
        <input type="text" id="filepath" class="layui-input"
               onclick="checkpath()" onfocus="this.blur()"
               placeholder="请点击选择要上传的文件……">
        <input type="file"
               id="uploadfile" style="display: none;" onchange="getInputUpload()"
               multiple="multiple"> <br/>
        <span style="display: none"><input id="selectFileUpLoadModelAsAll" type="checkbox" ></span>
        <span id="repeFileName" style="display: none"></span>
        <span id="mrepeFileName" style="display: none"></span>
        <h5>
            上传进度：<span id="filecount"></span>
        </h5>
        <div class="progress">
            <div id="progress" class="progress-bar" role="progressbar"
                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                 style="width: 0%;">
                <span class="sr-only"></span>
            </div>
        </div>
        <h5>上传状态：</h5>
        <div class="panel panel-default" >
            <div class="panel-body" style="height: 00px;overflow: auto;">
                <div id="uploadstatus" class="uploadstatusbox"></div>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <button type="button" class="layui-btn layui-btn-warm"
                onclick='abortUpload()'>取消
        </button>
        <button id="umbutton" type='button' class="layui-btn"
                onclick='checkUploadFile()'>开始上传
        </button>
    </div>
</form>
<form class="layui-form layui-col-md12" id="folder" style="margin-left: 10px;margin-top: 10px;display: none">
    <div class="layui-form-item">
        <h5>选择文件夹：</h5>
        <div>
            <input type="text" id="folderpath" class="layui-input" style="width: 75%;display: inline-block"
                   onclick="checkimportpath()" onfocus="this.blur()"
                   placeholder="请点击选择要上传的文件夹……" folderConstraintLevel="0">
            <div class="layui-input-inline" style="width: 20%">
                <select id="folderLevl" name="folderLevl" lay-filter="folderLevl">
                    <option>公开的</option>
                    <option>仅小组</option>
                    <option>仅创建者</option>
                </select>
                <span id="importfoldertype" style="display: none">公开的</span>
                <ul id="importfoldertypelist"
                    class="dropdown-menu dropdown-menu-right">
                </ul>
            </div>
        </div>
        <input type="file" id="importfolder" style="display: none;"
               onchange="getInputImport()" multiple="multiple" webkitdirectory>
        <h5>
            上传进度：<span id="importcount"></span>
        </h5>
        <div class="progress">
            <div id="importpros" class="progress-bar" role="progressbar"
                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                 style="width: 0%;">
                <span class="sr-only"></span>
            </div>
        </div>
        <h5>上传状态：</h5>
        <div class="panel panel-default" >
            <div class="panel-body" style="height: 00px;overflow: auto;">
                <div id="importstatus" class="uploadstatusbox"></div>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <button type="button" class="layui-btn layui-btn-warm"
                onclick='abortImport()'>取消
        </button>
        <button id="importbutton" type='button' class="layui-btn"
                onclick='checkImportFolderNew()'>开始上传
        </button>
    </div>
</form>
<script>
    var fs;
    var ifs;
    var xhr;
    var layer;
    var pingInt;
    var initData;
    var flagIsFile;
    var constraintLevel;
    var isUpLoading = false;// 是否正在执行上传操作
    var isImporting = false;// 是否正在执行上传文件夹操作
    var locationpath;
    var importFolderName;
    var repeList;// 这个是重复文件名的列表，型如['xxx','ooo',...]
    var repeIndex;// 当前设定上传模式的文件序号
    var repeModelList;// 这个是对每一个重复文件选取的上传模式，型如{'xxx':'skip','ooo':'both',...}
    var URL_PREFIX = 'http://localhost:9000/esriProxy/proxy.jsp?http://localhost:8080/';

    function initForm(data, fileState) {
        flagIsFile = fileState;
        var jsonString = JSON.stringify(data);
        initData = JSON.parse(jsonString);
        locationpath = initData.folderId;
        constraintLevel = initData.folderConstraint;
    }

    layui.use(['okUtils', "okLayer", 'layer', 'form'], function () {
        $ = layui.jquery;
        var okUtils = layui.okUtils;
        var okLayer = layui.okLayer;
        var form = layui.form;
        layer = layui.layer;

        form.on('select(folderLevl)', function (data) {
            $('#importfoldertype').text(data.value);
            return false;
        });

        if (flagIsFile === 0) {
            $('#file').show()
        } else if (flagIsFile === 1) {
            $('#folder').show()
        }else {
            layer.confirm('请刷新后重试', {icon: 3, title:'提示'}, function(index){
                //do something
                endFile(0);
                layer.close(index);
            });
        }
    });

    function uploadProgress(evt) {
        if (evt.lengthComputable) {
            // evt.loaded：文件上传的大小 evt.total：文件总的大小
            var percentComplete = Math.round((evt.loaded) * 100 / evt.total);
            // 加载进度条，同时显示信息
            $("#pros").width(percentComplete + "%");
            $("#pros").attr('aria-valuenow', "" + percentComplete);
        }
    }

    function importProgress(evt) {
        if (evt.lengthComputable) {
            // evt.loaded：文件上传的大小 evt.total：文件总的大小
            var percentComplete = Math.round((evt.loaded) * 100 / evt.total);
            // 加载进度条，同时显示信息
            $("#importpros").width(percentComplete + "%");
            $("#importpros").attr('aria-valuenow', "" + percentComplete);
        }
    }

    function abortUpload() {
        isUpLoading = false;
        if (xhr != null) {
            xhr.abort();
        }
        endFile(0);
    }

    function getInputUpload() {
        fs = $("#uploadfile").get(0).files;
        showfilepath();
    }

    function getInputImport() {
        ifs = $("#importfolder")[0].files;
        if (ifs.length > 0) {
            importFolderName = ifs[0].webkitRelativePath.substring(0, ifs[0].webkitRelativePath.indexOf("/"));
            $("#folderpath").val(importFolderName);
        }
    }

    function checkpath() {
        $('#uploadfile').click();
    }

    function checkimportpath() {
        $('#importfolder').click();
    }

    function showFileMsg() {
        $("#repeFileName").text(repeList[repeIndex]);
        layer.confirm('已存在于该路径下，您希望：', {
            btn: ['覆盖', '跳过', '保留两者']
            , btn3: function (index, layero) {
                fileModelAsAll(3);
            }
        }, function (index, layero) {
            fileModelAsAll(1);
        }, function (index) {
            fileModelAsAll(2);
        });
    }

    function fileModelAsAll(state) {
        layer.confirm('是否全部应用？', {
            btn: ['是', '否']
        }, function (index, layero) {
            $('#selectFileUpLoadModelAsAll').prop("checked",true);
            dealToUpload(state)
        }, function (index) {
            dealToUpload(state)
        });
    }

    function dealToUpload(state) {
        switch (state) {
            case 1:
                selectFileUpLoadModelEnd('cover');
                break;
            case 2:
                selectFileUpLoadModelEnd('skip');
                break;
            case 3:
                selectFileUpLoadModelEnd('both');
                break;
        }
    }

    function selectFileUpLoadModelEnd(t) {
        if (repeModelList == null) {
            repeModelList = {};
        }
        repeModelList[$("#repeFileName").text()] = t;
        if ($('#selectFileUpLoadModelAsAll').prop('checked')) {
            for (var i = repeIndex; i < repeList.length; i++) {
                repeModelList[repeList[i]] = t;
            }
            doupload(1);
        } else {
            repeIndex++;
            if (repeIndex < repeList.length) {
                showFileMsg();
            } else {
                doupload(1);
            }
        }
    }

    function showFolderMsg(state) {
        if (state === 0){
            layer.confirm('已存在于该路径下，您希望：', {
                btn: [ '取消上传', '保留两者']
            }, function (index, layero) {
                layer.closeAll('dialog');
                abortImport();
            }, function (index) {
                importAndBoth();
                layer.closeAll('dialog');
            });
        } else if (state === 1){
            layer.confirm('已存在于该路径下，您希望：', {
                btn: ['覆盖', '取消上传', '保留两者']
                , btn3: function (index, layero) {
                    layer.closeAll('dialog');
                    importAndBoth();
                }
            }, function (index, layero) {
                layer.closeAll('dialog');
                importAndCover()
            }, function (index) {
                layer.closeAll('dialog');
                abortImport()
            });
        } else {
            layer.alert('未知错误');
        }

    }

    function importAndBoth() {
        $("#selectFolderImportModelAlert").hide();
        var fc = $("#folderpath").attr("folderConstraintLevel");// 文件夹访问级别
        $.ajax({
            url: URL_PREFIX + 'homeController/createNewFolderByName.ajax',
            type: 'POST',
            data: {
                parentId: locationpath,
                folderName: importFolderName,
                folderConstraint: fc
            },
            dataType: 'text',
            success: function (result) {
                var resJson = eval("(" + result + ")");
                if (resJson.result === 'success') {
                    iteratorImport(0, resJson.newName);// 若新建成功，则使用新文件夹名称开始上传
                } else {
                    layer.alert("提示：生成新文件夹名称失败，无法开始上传");
                }
            },
            error: function () {
                layer.alert("提示：生成新文件夹名称失败，无法开始上传");
            }
        });
    }

    function abortImport() {
        isImporting = false;
        if (xhr != null) {
            xhr.abort();
        }
        endFile(0)
    }

    function importAndCover() {
        $.ajax({
            url:URL_PREFIX + 'homeController/deleteFolderByName.ajax',
            type:'POST',
            data:{
                parentId : locationpath,
                folderName : importFolderName
            },
            dataType:'text',
            success:function(result){
                if(result === 'deleteSuccess'){
                    iteratorImport(0);// 若覆盖成功，则开始上传
                }else{
                    layer.alert("提示：无法覆盖原文件夹，上传失败");
                }
            },
            error:function(){
                layer.alert("提示：无法覆盖原文件夹，上传失败");
            }
        });
    }

    function showfilepath() {
        var filename = "";
        for (var i = 0; i < fs.length; i++) {
            filename = filename + fs[i].name;
            if (i < (fs.length - 1)) {
                filename = filename + "、";
            }
        }
        if (fs.length <= 1) {
            $("#selectcount").text("");
        } else {
            $("#selectcount").text("（共" + fs.length + "个）");
        }
        $("#filepath").val(filename);
    }

    // 检查文件是否能够上传
    function checkUploadFile() {
        if (isUpLoading === false && isImporting === false) {
            if (fs != null && fs.length > 0) {
                $("#filepath").attr("disabled", "disabled");
                $("#umbutton").attr('disabled', true);
                isUpLoading = true;
                repeModelList = null;
                var filenames = [];
                var maxSize = 0;
                var maxFileIndex = 0;
                for (var i = 0; i < fs.length; i++) {
                    filenames[i] = fs[i].name.replace(/^.+?\\([^\\]+?)?$/gi, "$1");
                    if (fs[i].size > maxSize) {
                        maxSize = fs[i].size;
                        maxFileIndex = i;
                    }
                }
                var namelist = JSON.stringify(filenames);

                $.ajax({
                    type: "POST",
                    dataType: "text",
                    data: {
                        folderId: locationpath,
                        namelist: namelist,
                        maxSize: maxSize,
                        maxFileIndex: maxFileIndex
                    },
                    url: URL_PREFIX + "homeController/checkUploadFile.ajax",
                    success: function (result) {
                        if (result === "mustLogin") {
                            // window.location.href = "prv/login.html";
                            layer.alert("提示：出现意外错误，无法开始上传");
                        } else {
                            if (result === "errorParameter") {
                                layer.alert("提示：参数不正确，无法开始上传");
                            } else if (result === "noAuthorized") {
                                layer.alert("提示：您的操作未被授权，无法开始上传");
                            } else {
                                var resp = eval("(" + result + ")");
                                if (resp.checkResult === "fileTooLarge") {
                                    layer.alert("提示：文件[" + resp.overSizeFile + "]的体积超过最大限制（" + resp.maxUploadFileSize + "），无法开始上传");
                                } else if (resp.checkResult === "hasExistsNames") {
                                    repeList = resp.pereFileNameList;
                                    repeIndex = 0;
                                    showFileMsg();
                                } else if (resp.checkResult === "permitUpload") {
                                    doupload(1);
                                } else {
                                    layer.alert("提示：出现意外错误，无法开始上传");
                                }
                            }
                        }
                    },
                    error: function () {
                        layer.alert("提示：出现意外错误，无法开始上传");
                    }
                });
            } else {
                layer.alert("提示：您未选择任何文件，无法开始上传");
            }
        } else {
            layer.alert("提示：另一项上传文件或文件夹的任务尚未完成，无法开始上传");
        }
    }

    function checkImportFolderNew() {
        if (isUpLoading === false && isImporting === false) {
            if (ifs != null && ifs.length > 0) {// 必须选中文件
                $("#folderpath").attr("disabled", true);
                $("#importbutton").attr('disabled', true);
                isImporting = true;
                var maxSize = 0;
                var maxFileIndex = 0;
                // 找出最大体积的文件避免服务器进行效验
                for (var i = 0; i < ifs.length; i++) {
                    if (ifs[i].size > maxSize) {
                        maxSize = ifs[i].size;
                        maxFileIndex = i;
                    }
                }
                // 发送合法性检查请求
                $.ajax({
                    url: URL_PREFIX + 'homeController/checkImportFolder.ajax',
                    type: 'POST',
                    dataType: 'text',
                    data: {
                        folderName: importFolderName,
                        maxSize: maxSize,
                        folderId: locationpath
                    },
                    success: function (result) {
                        var resJson = eval("(" + result + ")");
                        switch (resJson.result) {
                            case 'noAuthorized':
                                layer.alert("提示：您的操作未被授权，无法开始上传");
                                break;
                            case 'errorParameter':
                                layer.alert("提示：参数不正确，无法开始上传");
                                break;
                            case 'mustLogin':
                                // window.location.href = "prv/login.html";
                                layer.alert("提示：出现意外错误，无法开始上传");
                                break;
                            case 'fileOverSize':
                                layer.alert("提示：文件[" + ifs[maxFileIndex].webkitRelativePath + "]的体积超过最大限制（" + resJson.maxSize + "），无法开始上传");
                                break;
                            case 'repeatFolder_Both':
                                showFolderMsg(0);
                                break;
                            case 'repeatFolder_coverOrBoth':
                                showFolderMsg(1);
                                break;
                            case 'permitUpload':
                                iteratorImport(0);// 直接允许上传
                                break;
                            default:
                                layer.alert("提示：出现意外错误，无法开始上传");
                                break;
                        }
                    },
                    error: function () {
                        layer.alert("提示：出现意外错误，无法开始上传");
                    }
                });
            } else {
                layer.alert("提示：您未选择任何文件夹，无法开始上传");
            }
        } else {
            layer.alert("提示：另一项上传文件或文件夹的任务尚未完成，无法开始上传");
        }
    }

    function doupload(count) {
        var fcount = fs.length;
        $("#pros").width("0%");// 先将进度条置0
        $("#pros").attr('aria-valuenow', "0");
        var uploadfile = fs[count - 1];// 获取要上传的文件
        if (uploadfile != null) {
            var fname = uploadfile.name;
            if (fcount > 1) {
                $("#filecount").text("（" + count + "/" + fcount + "）");// 显示当前进度
            }
            $("#uploadstatus").prepend(
                "<p>" + fname + "<span id='uls_" + count
                + "'>[正在上传...]</span></p>");
            xhr = new XMLHttpRequest();// 这东西类似于servlet里面的request

            var fd = new FormData();// 用于封装文件数据的对象

            fd.append("file", uploadfile);// 将文件对象添加到FormData对象中，字段名为uploadfile
            fd.append("folderId", locationpath);
            if (repeModelList != null && repeModelList[fname] != null) {
                if (repeModelList[fname] === 'skip') {
                    $("#uls_" + count).text("[已完成]");
                    if (count < fcount) {
                        doupload(count + 1);
                        return;
                    } else {
                        // 清空所有提示信息，还原上传窗口
                        isUpLoading = false;
                        $("#filepath").removeAttr("disabled");
                        $("#uploadfile").val("");
                        $("#filepath").val("");
                        $("#pros").width("0%");
                        $("#pros").attr('aria-valuenow', "0");
                        $("#umbutton").attr('disabled', false);
                        $("#filecount").text("");
                        $("#uploadstatus").text("");
                        $("#selectcount").text("");
                        endFile();
                        return;
                    }
                }
                fd.append("repeType", repeModelList[fname]);
            }
            xhr.open("POST", URL_PREFIX + "homeController/douploadFile.ajax", true);// 上传目标

            xhr.upload.addEventListener("progress", uploadProgress, false);// 这个是对上传进度的监听
            // 上面的三个参数分别是：事件名（指定名称）、回调函数、是否冒泡（一般是false即可）

            xhr.send(fd);// 上传FormData对象

            if (pingInt == null) {
                pingInt = setInterval("ping()", 60000);// 上传中开始计时应答
            }

            // 上传结束后执行的回调函数
            xhr.onloadend = function () {
                // 停止应答计时
                if (pingInt != null) {
                    window.clearInterval(pingInt);
                    pingInt = null;
                }
                if (xhr.status === 200) {
                    // TODO 上传成功
                    var result = xhr.responseText;
                    if (result === "uploadsuccess") {
                        $("#uls_" + count).text("[已完成]");
                        if (count < fcount) {
                            doupload(count + 1);
                        } else {
                            // 清空所有提示信息，还原上传窗口
                            isUpLoading = false;
                            $("#filepath").removeAttr("disabled");
                            $("#uploadfile").val("");
                            $("#filepath").val("");
                            $("#pros").width("0%");
                            $("#pros").attr('aria-valuenow', "0");
                            $("#umbutton").attr('disabled', false);
                            $("#filecount").text("");
                            $("#uploadstatus").text("");
                            $("#selectcount").text("");
                            endFile()
                        }
                    } else if (result === "uploaderror") {
                        layer.alert("提示：出现意外错误，文件：[" + fname
                            + "]上传失败，上传被中断。");
                        $("#uls_" + count).text("[失败]");
                    } else {
                        layer.alert("提示：出现意外错误，文件：[" + fname
                            + "]上传失败，上传被中断。");
                        $("#uls_" + count).text("[失败]");
                    }
                } else {
                    layer.alert("提示：出现意外错误，文件：[" + fname + "]上传失败，上传被中断。");
                    $("#uls_" + count).text("[失败]");
                }
            };
        } else {
            layer.alert("提示：要上传的文件不存在。");
            $("#uploadstatus").prepend(
                "<p>未找到要上传的文件<span id='uls_" + count + "'>[失败]</span></p>");
        }
    }

    function iteratorImport(i, newFolderName) {
        $("#importpros").width("0%");// 先将进度条置0
        $("#importpros").attr('aria-valuenow', "0");
        var uploadfile = ifs[i];// 获取要上传的文件
        var fcount = ifs.length;
        var fc = $("#folderpath").attr("folderConstraintLevel");// 文件夹访问级别
        if (uploadfile != null) {
            var fname = uploadfile.webkitRelativePath;
            if (fcount > 1) {
                $("#importcount").text("（" + (i + 1) + "/" + fcount + "）");// 显示当前进度
            }
            $("#importstatus").prepend(
                "<p>" + fname + "<span id='ils_" + i
                + "'>[正在上传...]</span></p>");
            xhr = new XMLHttpRequest();// 这东西类似于servlet里面的request

            var fd = new FormData();// 用于封装文件数据的对象

            fd.append("file", uploadfile);// 将文件对象添加到FormData对象中，字段名为uploadfile
            fd.append("folderId", locationpath);
            fd.append("folderConstraint", fc);
            if (!!newFolderName) {
                fd.append("newFolderName", newFolderName);
            }
            xhr.open("POST", URL_PREFIX + "homeController/doImportFolder.ajax", true);// 上传目标

            xhr.upload.addEventListener("progress", importProgress, false);// 这个是对上传进度的监听
            // 上面的三个参数分别是：事件名（指定名称）、回调函数、是否冒泡（一般是false即可）

            xhr.send(fd);// 上传FormData对象

            if (pingInt == null) {
                pingInt = setInterval("ping()", 60000);// 上传中开始计时应答
            }

            // 上传结束后执行的回调函数
            xhr.onloadend = function () {
                // 停止应答计时
                if (pingInt != null) {
                    window.clearInterval(pingInt);
                    pingInt = null;
                }
                if (xhr.status === 200) {
                    // TODO 上传成功
                    var result = xhr.responseText;
                    if (result === "uploadsuccess") {
                        $("#ils_" + i).text("[已完成]");
                        var ni = i + 1;
                        if (ni < fcount) {
                            iteratorImport(ni, newFolderName);
                        } else {
                            // 完成全部上传后，清空所有提示信息，并还原上传窗口
                            isImporting = false;
                            $("#folderpath").removeAttr("disabled");
                            $("#importfolder").val("");
                            $("#folderpath").val("");
                            $("#importpros").width("0%");
                            $("#importpros").attr('aria-valuenow', "0");
                            $("#importbutton").attr('disabled', false);
                            $("#importcount").text("");
                            $("#importstatus").text("");
                            endFile()
                        }
                    } else if (result === "uploaderror") {
                        layer.alert("提示：出现意外错误，文件：[" + fname
                            + "]上传失败，上传被中断。");
                        $("#ils_" + i).text("[失败]");
                    } else {
                        layer.alert("提示：出现意外错误，文件：[" + fname
                            + "]上传失败，上传被中断。");
                        $("#ils_" + i).text("[失败]");
                    }
                } else {
                    layer.alert("提示：出现意外错误，文件：[" + fname + "]上传失败，上传被中断。");
                    $("#ils_" + i).text("[失败]");
                }
            };
        } else {
            layer.alert("提示：要上传的文件不存在。");
            $("#importstatus").prepend(
                "<p>未找到要上传的文件<span id='ils_" + i + "'>[失败]</span></p>");
        }
    }

    function endFile(flag) {
        if (flag) parent.parentFlag = flag;
        parent.parentFlag = 1;
        parent.layer.close(parent.layer.getFrameIndex(window.name));
    }
</script>
</body>
</html>
