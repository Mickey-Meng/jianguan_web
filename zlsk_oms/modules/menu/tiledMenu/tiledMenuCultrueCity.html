<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <script type="text/javascript" src="../../../lib/sfmbase/sfmUtil.js"></script>
    <script type="text/javascript">
    SFM.sfmUtil.loadEasyui();
    SFM.sfmUtil.loadSfmBase();
    </script>
    <script type="text/javascript">
    SFM.SfmTiledMenu = SFM.SfmMenuBase.extend({
        constructor: function(options) {
            var me = this;
            me.base(options);
            me.addAction('setMenuName', me._setMenuName); //把方法加到addAction中 通过doAction调用
        },
        destroy: function() {
            $('.sfm-m-mi-box-lv1').off('click');
            this.removeAction('setMenuName');
            this.base();
        },
        render: function() {
            var me = this;
            me.el = $('body');
            me._renderMenus();
            var m = me.menu && me.menu[0]; //读配置菜单 mid 生成唯一标识
            if (m) {
                me.showMenu(m.mid);
            }
            me.addAction('getDocByClassName', me.getDocByClassName);
            me.base();
            return me;
        },


        showMenu: function(id) {
            $('.sfm-m-mi-box-lv1').removeClass('sfm-f-active'); //sfm-m-mi-box-lv1 一级菜单的样式 sfm-f-active：暂时看起来没什么样式
            $('#' + id).addClass('sfm-f-active');
            $('.sfm-m-menu-panel').hide();
            var $mp = $('.sfm-m-menu-panel[data-panel=' + id + ']').show();
            this._setMi1Img();
            var w = 0;
            $mp.find('.sfm-m-mi-box-lv2').each(function() {
                w += $(this).width() + 6;
            });
            // var l = Number($('#divMenuBox').css('margin-left').replace('px', '')) + ($('#divMenuBox').width() - w) / 2;
            var am = this.getConfig().alignLv2;
            if (am == 'center') {
                var $mb = $('#divMenuBox');
                if ($mb.css('float') == 'right') {
                    l = $('body').width() - Number($mb.css('margin-right').replace('px', '')) - $mb.width() / 2 - w / 2;
                } else {
                    l = Number($('#divMenuBox').css('margin-left').replace('px', '')) + ($('#divMenuBox').width() - w) / 2;
                }
                $mp.css('left', l + 'px');
            } else {
                $mp.css('right', (this.getConfig().marginRight || 0) + 'px');
            }
        },

        _bindEvents: function() {
            var me = this;
            $('.sfm-m-mi-box-lv1').on('click', function() {
                me.showMenu(this.id);
                 $('.normalsjx').removeClass('sjx');
                $(this).find('.normalsjx').addClass('sjx');
            });
            $('.sfm-m-mi-box-lv1').on('mouseover', function() {
                var $t = $(this);
                if (!$t.hasClass('sfm-f-hover')) {
                    $t.addClass('sfm-f-hover');
                }
                $('.normalsjx').removeClass('sjx');
                $(this).find('.normalsjx').addClass('sjx');
                me._setMi1Img();
                //me.showMenu(this.id);
            });

            $('.sfm-m-mi-box-lv1-name').on('mouseover', function() {
                var $t = $(this);
                if (!$t.hasClass('sfm-f-hover')) {
                    $t.addClass('sfm-f-hover');
                }
                // me._setMi1Img();
                // me.showMenu($t.attr('data-id'));
            });
            $('.sfm-m-mi-text1').on('mouseover', function() {
                var $t = $(this);
                if (!$t.hasClass('sfm-f-hover')) {
                    $t.addClass('sfm-f-hover');
                }
                me._setMi1Img();
                me.showMenu($(this).find('.sfm-m-mi-box-lv1-name').attr('data-id'));
            });
            $('.sfm-m-mi-box-lv1').on('mouseout', function() {
                var $t = $(this);
                if ($t.hasClass('sfm-f-hover')) {
                    $t.removeClass('sfm-f-hover');
                }
                me._setMi1Img();
            });
            me.base();
            return me;
        },

        _renderMenus: function() {
            var me = this;
            var menus = me.menu;
            var h1 = '';
            var h2 = '';
            if (menus) {
                var h1 = '<div class="sfm-m-menu-lv1-box ">';
                var h2 = '';
                for (var i = 0; i < menus.length; i++) {
                    var mi = menus[i];
                    h1 += me._getMi1Html(mi, menus.length, i); //一级菜单样式
                    h2 += '<div class="sfm-m-menu-panel" data-panel="' + mi.mid + '">';
                    if (mi.children) {
                        for (var j = 0; j < mi.children.length; j++) {
                            var cmj = mi.children[j];
                            h2 += me._getMi2Html(cmj, j); //二级菜单样式
                        }
                    }
                    h2 += '</div>';
                }
                h1 += '</div>';
            }
            $('#divMenuBox').html(h1); //一級菜單
            $('#divMenuBox2').html(h2); //二级菜单
        },
        _setMi1Img: function() {
            var me = this;
            $('.sfm-m-mi-box-lv1').each(function() {
                var $t = $(this);
                var mi = me._getMi1(this.id); //获得当前一级菜单的信息
                if (mi && mi.icon1) { //icon1不知道什么用 配置文件中没有该属性
                    var $i = $t.find('img');
                    if ($t.hasClass('sfm-f-active') || $t.hasClass('sfm-f-hover')) { //hasClass检查对象中是否存在指定的class
                        $i[0].src = mi.icon1;
                    } else {
                        $i[0].src = mi.icon;
                    }
                }
            });
        },
        _getMi1: function(id) { //获取each 一级菜单对象
            var menus = this.menu;
            if (menus) {
                for (var i = 0; i < menus.length; i++) {
                    if (menus[i].mid == id) {
                        return menus[i];
                    }
                }
            }
            return null;
        },
        _getMi1Html: function(mi, len, index) {
            var h = '';
            if (mi) {
                h += '<div id="' + mi.mid + '" class="sfm-m-mi-box sfm-m-mi-box-lv1">'; //一级菜单
                h += '<div class="sfm-m-mi-text1" style="float:left;">';
                if (mi.icon != null) {
                    h += '<div style="float:left;margin-top:12px;"><img src="' + mi.icon + '" class="sfm-m-mi-img" /></div>';
                }
                h += '<div style="margin-top:20px;float:left;" class="sfm-m-mi-box-lv1-name" data-id="' + mi.mid + '">' + mi.name + '</div></div>';

                if (len != index + 1) {
                    h += '<div style="float:left;width:2px;margin-left:10px;margin-top:13px;"><img src="../../../images/menus/cultureCity/line.png" style="height:50px;"/></div>';
                }
                if (index == 0) {
                    h += '<div class="normalsjx sjx"></div>';
                } else {
                    h += '<div class="normalsjx"></div>';
                }

                h += '</div>';
            }

            return h;
        },
        _getMi2Html: function(mi, index) {
            var h = '';
            if (mi) {
                var s = mi.disabled ? ' disabled="disabled"' : '';
                var acn = mi.actived ? ' sfm-f-active' : '';
                if (index != 0) {
                    h += "<div style='width:1.5px;float:left;margin-top:8.5px;text-align:center;color:white;'>| </div>";
                }

                h += '<div id="' + mi.mid + '" class="sfm-m-mi-box sfm-m-mi-box-lv2' + acn + '" data-mk="' + (mi.mk || mi.id) + '"';
                if (mi.radioGroup) {
                    h += ' data-rg="' + mi.radioGroup + '"';
                }
                h += s + '>';


                // if(mi.icon != null){
                //     h += '<img src="' + mi.icon + '" class="sfm-m-mi-img" />';
                // }
                h += '<div id="' + mi.mid + '_t" class="sfm-m-mi-text">' + mi.name + '</div>';
                h += '</div>';
            }
            return h;
        },
        _setMenuName: function(mk, name) {
            var me = this;
            if (mk) {
                var mi = me.menuMap[mk];
                if (mi) {
                    var $md = me.el.find('#' + mi.mid);
                    me._setMiName($md, name);
                }
            }
            me.doAction('onSetMenuName', null, mk, name); //调用addAction中的 onSetMenuName
            return me;
        },
        _setMiName: function($mi, name) {
            $mi.find('.sfm-m-mi-text').text(name);
            return this;
        },
        getDocByClassName: function(classname) {
            var doc = document.getElementsByClassName(classname);
            return doc;
        },

        __className__: 'SfmTiledMenu'
    });

    var tiledMenu = new SFM.SfmTiledMenu({ ctx: window });
    </script>
    <script type="text/javascript">
    tiledMenu.initConfig();
    var userInfo = tiledMenu.getSfmDataMgr().getData('data.globalData.userInfo').user;
    $(function() {
        tiledMenu.render();
        $('#userinfo').html(userInfo.NAME + '&nbsp;欢迎登录系统!');
    });

    function updatePwd() {
        tiledMenu.getSfmModuleMgr().loadModuleByKey('updatpwd', null, null, function(mid) {
            tiledMenu.data.ltm = mid;
        });
    }

    function logoOut() {
        delCookie('name');
        delCookie('pwd');
        delCookie("userinfo");
        delCookie("menus");
        delCookie("fun");
        var url = window.parent.parent.location.href;
        window.parent.parent.location.href = url;
    }
    var delCookie = function(name) {
        var exp = new Date();
        exp.setTime(exp.getTime() - 10000);
        var cval = getCookie(name);
        if (cval != null) document.cookie = name + "=" + cval + ";expires=" + exp.toGMTString() + ';path=/';
    }
    var getCookie = function(cname) {
        var v = document.cookie.replace(/\s/g, "");
        var arrstr = v.split(";");
        for (var i = 0; i < arrstr.length; i++) {
            var temp = arrstr[i].split("=");
            if (temp[0] == cname) { return unescape(temp[1]); }
        }
    }
    </script>
</head>

<body>
    <div id="divMenuBox" class="sfm-m-menu-box" style="margin-right: 225px;"> </div>
    <div style="float: left;height: 79px;position: absolute;right:3px;margin-top: 19px;font-size: 14px;float: left;">
        <div style="float: left;"><span><img src="../../../images/menus/cultureCity/nav6.png"></span></div>
        <div style="float: left;"><span id="userinfo">admin欢迎登录系统!</span><br />
            <span style="cursor: pointer;"  onclick="updatePwd()" id="updatespan">修改密码</span>|<span style="cursor: pointer;" onclick="logoOut()" id="outspan">退出系统</span></div>
    </div>
    <div id="divMenuBox2" class="sfm-m-menu-lv2-box"></div>
</body>

</html>
