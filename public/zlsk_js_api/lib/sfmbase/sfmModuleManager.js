!function(e,n){if("undefined"!=typeof module&&module.exports){var t=require("jquery"),r=require("underscore"),o=require("SfmModuleBase");module.exports=e(t,r,o)}else"function"==typeof define&&define.amd?define(["jquery","underscore","sfmModuleBase"],e):(null==n.SFM&&(n.SFM={}),n.SFM.SfmModuleManager=e(n.$,n._,n.SFM.SfmModuleBase))}(function(_,f,e){function i(e,n){return a(e,["children","render"],"mk",n)}var d=["url","config","style","type","region","group","groupName","closable","tab","render","moduleType"],a=function(e,n,t,r){if(!e)return null;for(var o=0;o<e.length;o++){var i=e[o];if(i[t]==r)return i;if("string"==typeof n){if(u=i[n])if(f=a(u,n,t,r))return f}else for(var l=0;l<n.length;l++){var u,f;if(u=i[n[l]])if(f=a(u,n,t,r))return f}}return null};return e.extend({constructor:function(e){this.base(e)},destroy:function(){this._destroyModules()},render:function(){return this},resize:function(){for(var e=this.data._ms,n=["container","menu","toolbar","module"],t=0;t<n.length;t++){var r=e[n[t]];if(r)for(var o=0;o<r.length;o++){var i=r[o].module;"function"==typeof i.resize&&i.resize()}}return this},setMainContainer:function(e){return this.el=e,this},loadConfig:function(e){return this.config=e,this.initService(e)},initService:function(e){var o=this,n=e&&e.service,i=e&&e.server;if(null!=n)return o.data._svc=[],_.each(n,function(e,n){var t=n.name,r=n.url;r=r.replace(/\{\$\S+\$\}/g,function(e){var n=e.substr(2,e.length-4);return null==i[n]?e:i[n]}),o.data._svc.push({name:t,url:r})}),o;o.data._svc=null},getServiceUrl:function(e,n){var t=this.data._svc;if(!t||!e)return null;for(var r=0;r<t.length;r++){var o=t[r];if(o.name==e){var i=o.url;if(n)for(var l in n){var u=n[l];null!=u&&(i=i.replace("{{"+l+"}}",u))}return i}}return null},getMenus:function(e){var t=[],r=1==e?"fun":"fun2";return f.each(this.config.menu,function(e,n){f.each(e[r],function(e){t.push(e)})}),t},getProjectName:function(){return this.getSfmUtil().valueOrDefault(this.config,"project","")},getFileRoot:function(){return this.getSfmUtil().valueOrDefault(this.config,"sfmFileRoot","")},getFileRootUrl:function(){var e=this.config;return e.serviceProtocol+"//"+e.serviceIp+"/"+e.sfmFileRoot+"/"},jump2Login:function(){var e=this.login;return e&&e.render(),this.destroyModules(),this},loadLib:function(e){return e&&0!=e.length&&SFM.sfmUtil.load.apply(this,e),this},loadLogin:function(n){var t=this,e=(t.data._ms,t.config&&t.config.login);if(e){t.destroyModule({type:"login"});e.url,e.config,e.style;return e.moduleType||(e.moduleType="login"),e.mk||(e.mk="sfm_login"),e.id||(e.id=t.getSfmUtil().fguid()+"_"+(new Date).getTime()),t._loadModule({cid:null,el:t._getMainCtnr(),frm:t._getMainCtnr(),params:{onLogin:function(e){"function"==typeof n&&n(e)}},onModuleInited:function(e){t.login=e}},e),t}},loadContainer:function(n,t){var r=this,e=(r.data._ms,r.config&&r.config.container);if(e){r.destroyModule({type:"container"});e.url,e.config,e.style;return e.moduleType||(e.moduleType="container"),e.mk||(e.mk="sfm_container"),e.id||(e.id=r.getSfmUtil().fguid()+"_"+(new Date).getTime()),r._loadModule({cid:null,el:r._getMainCtnr(),frm:r._getMainCtnr(),params:e.param,onModuleInited:function(e){r.container=e,"function"==typeof n&&n(e)},onModuleRendered:function(e){"function"==typeof t&&t(e)}},e),r}},loadMenu:function(n){var e=this,t=e.config&&e.config.menu;if(t){if(e.destroyModule({type:"menu"}),0==t.length)return"function"==typeof n&&n(),e;for(var r=0,o=0;o<t.length;o++){var i=t[o],l={};_.extend(!0,l,i,{moduleType:"menu"}),e.loadModule(l,{menuInfo:i.fun2},function(e){++r==t.length&&"function"==typeof n&&n()})}return e}},loadToolbar:function(r){var e=this,n=e.config&&e.config.toolbar;if(n){e.destroyModule({type:"toolbar"});if(0<n.length){for(var o=0,i=0,t=function(e){if(o++,e.children)for(var n=0;n<e.children.length;n++)t(e.children[n]);if(e.render)for(n=0;n<e.render.length;n++)t(e.render[n])},l=function(t){t.moduleType="toolbar";var n=_.extend(!0,{},t);f.each(d,function(e){delete n[e]}),e.loadModule(t,{config:n},function(e){if(i++,t.children)for(var n=0;n<t.children.length;n++)l(t.children[n]);i==o&&"function"==typeof r&&r()},function(e){if(t.render)for(var n=0;n<t.render.length;n++)l(t.render[n]);i==o&&"function"==typeof r&&r()})},u=0;u<n.length;u++)t(n[u]);for(u=0;u<n.length;u++)l(n[u])}else"function"==typeof r&&r(null);return e}},loadPre:function(r){var e=this,n=e.config&&e.config.pre;if(n){for(var o=0,i=0,t=function(e){if(o++,e.children)for(var n=0;n<e.children.length;n++)t(e.children[n]);if(e.render)for(n=0;n<e.render.length;n++)t(e.render[n])},l=function(t){e.loadModule(t,null,function(e){if(t.children)for(var n=0;n<t.children.length;n++)l(t.children[n]);i==o&&"function"==typeof r&&r()},function(e){if(i++,t.render)for(var n=0;n<t.render.length;n++)l(t.render[n]);i==o&&"function"==typeof r&&r()})},u=0;u<n.length;u++)t(n[u]);for(u=0;u<n.length;u++)l(n[u]);return e}},loadModuleByKey:function(e,n,t,r){var o=this._getMc(e);return o&&this.loadModule(o,_.extend(!0,{},o.param,n),t,r),this},loadModule:function(o,i,l,u){function n(e){"function"==typeof l&&l(e)}var f=this,e=f.getSfmUtil().valueOrDefault,t=(e(o,"moduleType","module"),e(o,"type",null),e(o,"region",null)),r=e(o,"url",null),d=(e(o,"config",null),e(o,"style",null),e(o,"mk",o.id),e(o,"reopen",!1));if(!r)return n(null),f;var a=f.container;if(!a)return n(null),f;f.data._ms;var c=f._findModule({url:r,mid:e(o,"mid",null)}),s=!0;if(c&&0<c.length){var m=c[0].moduleInfo.maxnum;m=null==m?1:m,s=c.length<m,c=c[c.length-1]}if(!s&&c&&!d){if("none"==c.moduleInfo.region)return c.module.render(),f;var g={};return _.extend(!0,g,o,{type:c.moduleInfo.type,region:c.moduleInfo.region,id:c.cid,onShow:function(e){"function"==typeof c.module.beforeShow&&c.module.beforeShow()},onShown:function(e){"function"==typeof c.module.show&&c.module.show(),c.module&&"function"==typeof c.module.resize&&c.module.resize(),n(c.module)}}),a.showContainer(!0,g),f}!s&&c&&d&&f.destroyModule({mid:c.module.getId()},"none"!=c.type);var h=null;if("none"==t){var p={el:null};return i&&_.extend(!0,p,i),f._loadModule({cid:null,params:p,el:null,onModuleInited:l,onModuleRendered:u},o),f}g={};return _.extend(!0,g,o,{onOpen:function(e){var n=e.id,t=e.container,r={cid:n,el:t};_.extend(!0,r,e),i&&_.extend(!0,r,i),f._loadModule({cid:n,params:r,el:t,onModuleInited:function(e){h=e,"function"==typeof l&&l(e)},onModuleRendered:u},o)},onOpened:function(e){h&&(h&&"function"==typeof h.show&&h.show(),h&&"function"==typeof h.resize&&h.resize())},onClose:function(e){if(h){var n={mid:h.getId()},t=!0;return("function"!=typeof h.onClose||(t=h.onClose(n)))&&f.destroyModule(n),t}return f.destroyModule({url:r}),!0},onHide:function(e){h&&"function"==typeof h.beforeHide&&h.beforeHide()},onHidden:function(){h&&("function"==typeof h.hide&&h.hide(),h&&"function"==typeof h.resize&&h.resize())},onShow:function(e){h&&"function"==typeof h.beforeShow&&h.beforeShow()},onShown:function(){h&&("function"==typeof h.show&&h.show(),h&&"function"==typeof h.resize&&h.resize())}}),a.openContainer(g),f},destroyModule:function(e,n){var t=this,r=t.data._ms,o=t.data._ul;if(null==r||null==o)return null;var i=t.getSfmUtil().valueOrDefault,l=i(e,"type",null),u=i(e,"url",null),f=i(e,"mid",null);for(var d in r)if(!l||l==d){var a=r[d];if(f||u)for(var c=0;c<a.length;c++){if((g=a[c]).mid&&g.mid==f||g.url&&g.url==u){for(var s=t.data._ml,m=0;m<s.length;m++)if(s[m].mid==g.mid||s[m].url==g.url){s.splice(m,1),m--;break}return u=u||g.url,a.splice(c,1),c--,void t._destroyModule(g,n)}}}if(u)for(d=0;d<o.length;d++)o[d]==u&&(o.splice(d,1),d--);if(l&&r[l])for(;0<r[l].length;){var g=r[l].pop();t._destroyModule(g,n)}return t},__init__:function(e){return this.data._ms={},this.data._ml=[],this.data._ul=[],this},_getMainCtnr:function(){return this.el},_findModule:function(e){var n=this.data._ms;if(null==n)return null;var t=this.getSfmUtil().valueOrDefault,r=t(e,"type",null),o=t(e,"url",null),i=t(e,"mid",null),l=[];for(var u in n)if(!r||r==u){var f=n[u];if(i||o)for(var d=0;d<f.length;d++){var a=f[d];i&&o?a.fid==i&&a.url==o&&l.push(a):i&&a.fid==i?l.push(a):o&&a.url==o&&l.push(a)}}return 0<l.length?l:r&&n[r]&&!o?n[r]:null},_findUrl:function(e){for(var n=this.data._ul,t=0;t<n.length;t++)if(n[t]==e)return n[t];return null},_loadModule:function(r,o){var i=this,e=i.getSfmUtil().valueOrDefault,l=o.url,n=o.config,u=o.style,f=r.cid,d=e(o,"moduleType","module"),a=e(o,"mk",o.id),c=r.params;_.extend(!0,c,o.param);var s=i.data._ms,m=r.el,t=i.getSfmDataMgr().getData("moduleData")||{};_.extend(!0,c,{name:o.name,title:o.title}),t[a]={url:l,style:u,config:n,lib:o.lib,mp:c,el:m,onModuleInited:function(e){var n=e;s[d]=s[d]||[];var t={url:l,mk:a,mid:n.getId(),cid:f,fid:o.mid,style:u,module:n,moduleInfo:o};t.fid=t.mid,s[d].push(t),i.data._ml.push(t),"function"==typeof r.onModuleInited&&r.onModuleInited(n)},onModuleRendered:function(e){"function"==typeof r.onModuleRendered&&r.onModuleRendered(e)}},i.getSfmDataMgr().setData({moduleData:t}),i.data._ul.push(l);var g=l.indexOf("?");if((0<g?l.substring(0,g):(g=l.length,l)).lastIndexOf(".js")!=g-3){if("none"==o.region)i.getSfmUtil().load(l);else{M=i.getSfmUtil().getHostUrl(i.getSfmUtil().getMainWin());if(M+=l+(0<l.indexOf("?")?"&":"?")+"mk="+a,r.frm)return r.frm.attr("src",M),i;if(o.moduleName){var h=i.getSfmUtil().getMainWin();return void((h=h&&h.SFM[o.moduleName])&&(h=new h({mk:a,el:m}))&&h.render())}if(0==m.find("#"+f+"_frm").length){var p='<iframe id="'+f+'_frm"';p+=' name="'+f+'_frm"',p+=' allowtransparency="true"',p+=' frameborder="0" style="width: 100%;height: 100%;"></iframe>',m.html(p)}m.find("#"+f+"_frm").attr("src",M)}return i}function v(){var e=c.moduleName;e||(e=l.lastIndexOf("/"),e=(e=l.substring(e+1,g-3))[0].toUpperCase()+e.substr(1));var n=SFM[e],t=_.extend(!0,{},{mk:a,el:m},c);n&&new n(t).initConfig().render()}var y=i.getSfmUtil().getHostUrl(i.getSfmUtil().getMainWin()),M=y+l+(0<l.indexOf("?")?"&":"?")+"mk="+a;n?$LAB.script(y+n).script(M).wait(v):$LAB.script(M).wait(v)},_destroyModule:function(e,n){if(e){var t=e,r=t.module;if(r&&"function"==typeof r.destroy&&r.destroy(),t.mk){var o=this.getSfmDataMgr().getData("moduleData")||{};o[t.mk]=null,this.getSfmDataMgr().setData({moduleData:o})}var i=t.cid;return i&&n&&this.container.closeContainer({id:i}),this}},_destroyModules:function(){var e=this.data._ml;if(e)for(;0<e.length;){var n=e.pop();n&&n.module&&"function"==typeof n.module.destroy&&n.module.destroy()}var t=this.data._ms;return t&&f.each(t,function(e){e&&0<e.length&&e.splice(0,e.length)}),this.getSfmDataMgr().setData({moduleData:null}),this},_getMc:function(e){var n=this,t=n.config&&n.config.menu;if(t)for(var r=0;r<t.length;r++){var o;if(o=i(t[r].fun2,e))return o}if((t=n.config&&n.config.toolbar)&&(o=i(t,e)))return o;if((t=n.config&&n.config.pre)&&(o=i(t,e)))return o;if((t=n.config&&n.config.module)&&(o=i(t,e)))return o;return null},__className__:"SfmModuleManager"})},window);
